
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>New Brunswick Wildfire Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light" />

    <!-- Fonts / Leaflet / Plugins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <!-- Leaflet markercluster (CSS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

    <style>
      :root{
        color-scheme: light;
        --bg:#f7f8fc; --text:#0f172a; --muted:#5b6474;
        --panel:rgba(255,255,255,.85); --panel-strong:#fff; --border:#e6eaf1;
        --radius:14px; --radius-sm:10px;
        --shadow:0 10px 30px rgba(2,8,20,.08); --shadow-soft:0 6px 16px rgba(2,8,20,.06);
        --btn-bg:#fff; --btn-border:#d9dee6; --btn-hover:#f2f4f7;
        --link:#2563eb; --focus:0 0 0 3px rgba(37,99,235,.28);
        --oc:#ef4444; --cont:#fb923c; --uc:#facc15; --pat:#22c55e; --mon:#3b82f6;
        --modis:#f59e0b; --perimeter:#ef4444; --boundary:#0b0f19;
        --fs-12:12px; --fs-14:14px; --fs-16:16px; --fs-18:18px;

        /* dynamic bottom lift for the footer (set by JS) */
        --footer-offset: 0px;
      }

      html,body{height:100%;margin:0;overflow:hidden;overscroll-behavior:none}
      #map{height:100%}
      body{background:var(--bg);color:var(--text);font:var(--fs-14)/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;letter-spacing:.1px;
        -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

      /* Leaflet controls */
      .leaflet-bar a,.leaflet-bar a:hover{background:var(--panel);border:1px solid var(--border);color:var(--text);box-shadow:var(--shadow-soft)}
      .leaflet-bar a{width:34px;height:34px;line-height:34px;font-size:16px}
      .leaflet-control-attribution{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow-soft);padding:4px 8px}
      .leaflet-top.leaflet-left{top:52px!important}
      .leaflet-top.leaflet-right{top:72px!important}

      /* Layers panel */
      .leaflet-control-layers{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
        font-size:var(--fs-14);padding:8px 40px 8px 14px;backdrop-filter:blur(6px);min-width:260px;white-space:nowrap}
      .leaflet-control-layers-expanded,.leaflet-control-layers-list{max-height:none;overflow:visible}
      .leaflet-control-layers-overlays label{display:grid;grid-template-columns:18px 26px 1fr;align-items:center;column-gap:8px;min-width:max-content;line-height:1.25}
      .leaflet-control-layers-overlays input{margin:0;width:max-content;height:18px}
      .leaflet-control-layers-overlays .text{min-width:max-content;white-space:nowrap;overflow:visible;text-overflow:clip}

      @media (max-width: 640px) {
        /* constrain legend so the PAGE never scrolls; scroll inside the panel if needed */
        .leaflet-control-layers { width: var(--layers-w, auto); max-width: calc(100vw - 24px); min-width: 0 !important;
          white-space: nowrap; overflow-x: auto; max-height: calc(100vh - 180px); overflow-y: auto; }
        .leaflet-control-layers-overlays label { grid-template-columns: 18px 26px auto; }
        .leaflet-control-layers-overlays .text { white-space: nowrap; min-width: max-content; }
      }
      @media (max-width:767.98px){.leaflet-control-layers{font-size:var(--fs-12)}}

      /* Buttons */
      .map-btn{position:absolute;z-index:1001;background:var(--btn-bg);border:1px solid var(--btn-border);border-radius:999px;padding:10px 14px;
        font-size:var(--fs-14);font-weight:700;color:var(--text);cursor:pointer;box-shadow:var(--shadow);display:inline-flex;align-items:center;gap:8px;
        transition:background .2s,transform .06s,box-shadow .2s}
      .map-btn:hover{background:var(--btn-hover);box-shadow:0 8px 22px rgba(0,0,0,.08)}
      .map-btn:active{transform:translateY(1px)}
      .map-btn:focus-visible{outline:none;box-shadow:var(--focus)}
      .map-toggle-btn{top:12px;right:12px}
      .reset-view-btn{top:12px;left:12px;z-index:1002}
      .map-btn .icon{width:18px;height:18px;display:inline-grid;place-items:center}
      .map-ui-hidden .leaflet-control-layers{opacity:0;pointer-events:none}

      /* Labels */
      .city-label-tooltip,.perimeter-label-tooltip{background:none!important;border:none!important;box-shadow:none!important;padding:0!important}
      .city-label{font-size:15px;font-weight:800;color:#fff;text-shadow:0 0 2px rgba(0,0,0,.7),0 0 8px rgba(0,0,0,.6),1px 1px 0 rgba(0,0,0,.9)}
      .perimeter-label{font-size:12px;font-weight:800;pointer-events:none;padding:2px 6px;border-radius:6px;background:rgba(239,68,68,.12);backdrop-filter:blur(2px)}

      /* Summary modal (scrolls inside the panel, page remains fixed) */
      .fire-summary-btn{position:fixed;left:12px;bottom:86px;z-index:2001}
      .fire-summary-overlay{position:fixed;inset:0;display:none;align-items:start;justify-content:center;z-index:3000;background:rgba(0,0,0,.25);backdrop-filter:blur(2px)}
      .fire-summary{margin-top:16px;background:var(--panel-strong);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);width:min(680px,calc(100% - 24px));color:var(--text);
        max-height:90vh; display:flex; flex-direction:column; overflow:hidden;}
      .fire-summary header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 8px; flex:0 0 auto;}
      .fire-summary h2{font-size:var(--fs-18);font-weight:800;margin:0}
      .fire-summary .body{padding:0 16px 16px;line-height:1.5; overflow:auto; flex:1 1 auto; min-height:0;}
      .close-summary{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--text);border-radius:var(--radius-sm);padding:8px 12px;cursor:pointer;font-weight:700;box-shadow:var(--shadow-soft)}
      .close-summary:hover{background:var(--btn-hover)}
      .close-summary:focus-visible{outline:none;box-shadow:var(--focus)}
      .chip{display:inline-flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:0 8px 8px 0;font-weight:700;box-shadow:var(--shadow-soft)}
      .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
      .summary-list{margin:8px 0 0;padding-left:12px;list-style:decimal;list-style-position:inside}
      .summary-list a{color:var(--link);text-decoration:none;font-weight:700}
      .summary-list a:hover{text-decoration:underline}
      .fs-scroll{margin-top:8px;border:1px solid var(--border);border-radius:12px;padding:8px;background:var(--panel)}

      .fs-meta-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:10px 0}
      .stat{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:var(--shadow-soft)}
      .stat .h{font:800 13px/1.2 Inter,system-ui,Arial;color:var(--muted);text-transform:uppercase;letter-spacing:.02em;margin-bottom:4px}
      .stat .v{font:800 18px/1.15 Inter,system-ui,Arial}
      @media (max-width: 520px){ .fs-meta-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }

      /* Legend icons */
      .marker-badge{width:38px;height:38px;border-radius:999px;display:grid;place-items:center;background:var(--panel-strong);border:2.5px solid var(--ring,#9aa0a6);box-shadow:0 2px 10px rgba(0,0,0,.18)}
      .marker-badge i{font-size:18px;color:var(--ring,#9aa0a6)}
      .legend-icon{width:18px;height:18px;display:inline-grid;place-items:center}
      .icons-pack{display:inline-flex;gap:6px;vertical-align:middle;justify-content:center;width:26px}
      .legend-badge{width:18px;height:18px;border-radius:999px;display:grid;place-items:center;background:#fff;border:2.5px solid var(--ring)}
      .legend-badge i{font-size:11px;color:var(--ring)}
      .legend-modis-dot{width:10px;height:10px;border-radius:999px;background:var(--modis);display:inline-block;box-shadow:0 0 0 1.5px #111827 inset}

      /* Footer */
      .nb-footer{position:fixed;bottom:10px;left:0;width:100%;text-align:center;z-index:2000}
      .nb-footer a{background:var(--btn-bg);border:1px solid var(--btn-border);border-radius:12px;padding:10px 18px;box-shadow:var(--shadow);color:var(--link);font-weight:800;text-decoration:none;display:inline-flex;align-items:center;gap:10px}

      /* Weather-station text */
      .ws-svg text{fill:#fff;stroke:rgba(0,0,0,.45);stroke-width:.9px;paint-order:stroke;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
      .ws-speed{font-weight:800;font-size:14px}
      .ws-small{font-weight:700;font-size:10px;opacity:.95}

      /* Smoke timeline UI (responsive & offset from footer) */
      #smokeControls{
        position:absolute; right:12px; z-index:2100;
        display:none; align-items:center; gap:10px;
        background:var(--panel); border:1px solid var(--border);
        border-radius:12px; padding:8px 12px; box-shadow:var(--shadow);
        backdrop-filter:blur(6px);
        font-size:var(--fs-14);
        max-width: min(96vw, 560px);
        /* raised a bit higher so no mobile scroll is needed */
        bottom: calc(28px + var(--footer-offset, 0px)); /* was 12px */
      }
      @supports (bottom: calc(12px + env(safe-area-inset-bottom))) {
        #smokeControls{
          bottom: calc(28px + var(--footer-offset, 0px) + env(safe-area-inset-bottom));
        }
      }
      #smokePlay{
        background:var(--btn-bg); border:1px solid var(--btn-border);
        border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:800;
        white-space:nowrap;
      }
      #smokePlay:focus-visible{ outline:none; box-shadow:var(--focus); }
      #smokeTime{ width:320px; max-width:60vw; }
      #smokeTimestamp{ font-weight:700; white-space:nowrap; }

      /* Mobile layout: stretch, wrap, timestamp on its own line; PAGE never scrolls */
      @media (max-width: 560px){
        #smokeControls{
          left:12px; right:12px;
          /* no display override here — JS toggles it */
          flex-wrap:wrap;
          justify-content:space-between;
          gap:8px;
        }
        #smokeTime{ flex:1 1 auto; min-width:140px; max-width:none; }
        #smokeTimestamp{ flex: 1 0 100%; order: 3; font-size: var(--fs-12); }
      }
    </style>
  </head>
  <body>
    <div id="map" aria-label="Interactive wildfire map"></div>

    <!-- Smoke timeline controls (hidden until Smoke layer is toggled on) -->
    <div id="smokeControls" aria-live="polite">
      <button id="smokePlay" type="button" title="Play/Pause" aria-label="Play animation">▶</button>
      <input id="smokeTime" type="range" min="0" max="0" value="0" step="1" aria-label="Smoke time slider" />
      <span id="smokeTimestamp">Loading…</span>
    </div>

    <!-- Renamed to “Show Legend” and kept synced with state -->
    <button id="mapToggleBtn" class="map-btn map-toggle-btn" type="button" aria-pressed="false" title="Show Legend">
      <span class="icon"><i class="fa-solid fa-layer-group"></i></span><span id="mtb-text">Show Legend</span>
    </button>
    <button id="resetViewBtn" class="map-btn reset-view-btn" type="button" title="Reset map view">
      <span class="icon"><i class="fa-solid fa-compass"></i></span><span>Reset Map View</span>
    </button>
    <button id="fireSummaryBtn" class="map-btn fire-summary-btn" type="button" title="Open summary">
      <span class="icon"><i class="fa-solid fa-fire"></i></span><span>Fire Summary</span>
    </button>

    <div id="fireSummaryOverlay" class="fire-summary-overlay" role="presentation" hidden>
      <div class="fire-summary" role="dialog" aria-modal="true" aria-labelledby="fs-title">
        <header>
          <h2 id="fs-title">New Brunswick Fire Summary</h2>
          <button id="fs-close" class="close-summary" type="button"><span class="icon"><i class="fa-solid fa-xmark"></i></span> Close</button>
        </header>
        <div id="fs-body" class="body"></div>
      </div>
    </div>

    <!-- Soft “data may be unavailable” modal -->
    <div id="serviceAlertOverlay" class="service-alert-overlay" role="presentation" hidden>
      <div class="service-alert" role="dialog" aria-modal="true" aria-labelledby="svc-title">
        <header>
          <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
          <h2 id="svc-title">Data May Be Unavailable</h2>
        </header>
        <div id="svc-body" class="body">
          <p>We couldn’t load one of the layers.</p>
          <p>Please try refreshing the page later.</p>
        </div>
        <div class="footer">
          <button id="svc-ack" class="service-btn" type="button">OK</button>
        </div>
      </div>
    </div>

    <div class="nb-footer">
      <a href="https://www.gnb.ca/en/topic/laws-safety/emergency-preparedness-alerts/fire-watch.html" target="_blank" rel="noopener">
        <i class="fa-solid fa-up-right-from-square"></i> NB Fire Watch &amp; Burn Restrictions
      </a>
    </div>

    <!-- JS (deferred) -->
    <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script defer src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
    <script defer src="https://unpkg.com/esri-leaflet-image/dist/esri-leaflet-image.js"></script>
    <script defer src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script defer src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script defer src="https://unpkg.com/esri-leaflet-cluster/dist/esri-leaflet-cluster.js"></script>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        'use strict';

        /* ====================== Config ====================== */
        const LS_KEY = 'nbMapView';
        const NB_BOUNDS = [[44.0, -69.5], [48.5, -62.0]];
        const INITIAL_VIEW = { center: [46.7, -66.2], zoom: 7 }; // safety fallback only
        const ATLANTIC_TZ = 'America/Moncton';
        const OPEN_SKY_URL = 'https://opensky-network.org/api/states/all';
        const OPEN_SKY_INTERVAL_MS = 250_000;
        const LIGHTNING_REFRESH_MS = 120_000;

        /* ====================== Utilities ====================== */
        const isMobile = () => innerWidth < 768;
        const cssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        const norm = (s) => (s || '').toString().trim().toLowerCase();
        const toNum = (v, d = 1) => (v == null || Number.isNaN(Number(v))) ? '—' : Number(v).toLocaleString(undefined, { maximumFractionDigits: d });
        const fmtDateTime = (ms) => ms == null ? '—' : new Date(+ms).toLocaleString(undefined, { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        const fmtDateTZ = (ms, tz = ATLANTIC_TZ) => ms == null ? '—' : new Date(+ms).toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: tz });

        const statusColor = (s) => ({
          'out of control': cssVar('--oc'),
          contained: cssVar('--cont'),
          'under control': cssVar('--uc'),
          'being patrolled': cssVar('--pat'),
          'being monitored': cssVar('--mon'),
          extinguished: '#9aa0a6'
        }[norm(s)] || '#9aa0a6');

        const severityRank = (s) => ({
          'out of control': 3,
          contained: 2,
          'under control': 1,
          'being patrolled': 0,
          'being monitored': 0,
          extinguished: -1
        }[norm(s)] ?? -1);

        // Atlantic day bucketing
        const ymdInTz = (ms, tz = ATLANTIC_TZ) => {
          const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' });
          const parts = fmt.formatToParts(new Date(ms));
          const grab = (k) => +parts.find((p) => p.type === k)?.value;
          return { y: grab('year'), m: grab('month'), d: grab('day') };
        };
        const sameYMD = (a, b, tz) => { if (a == null || b == null) return false; const A = ymdInTz(a, tz); const B = ymdInTz(b, tz); return A.y===B.y && A.m===B.m && A.d===B.d; };
        const yesterdayUTCms = (tz = ATLANTIC_TZ) => { const t = ymdInTz(Date.now(), tz); return Date.UTC(t.y, t.m - 1, t.d) - 86_400_000; };
        const isToday = (ms) => sameYMD(ms, Date.now(), ATLANTIC_TZ);
        const isYesterday = (ms) => sameYMD(ms, yesterdayUTCms(ATLANTIC_TZ), ATLANTIC_TZ);
        const getExtinguishedMs = (p) => { for (const k of ['FIRE_OUT_DATE','OUT_DATE','DATE_OUT','DATE_EXTINGUISHED','OUT_TIME','EXTINGUISHED','FIRE_STAT_DATE']) { const v=p?.[k]; if(v==null) continue; const n=+v; if(Number.isFinite(n)) return n; const t=Date.parse(v); if(!Number.isNaN(t)) return t; } return null; };
        const getDetectedMs = (p) => { for (const k of ['TIME_DETECTED','DATE_DETECTED','DETECTED','FIRE_START_DATE','START_DATE']) { const v=p?.[k]; if(v==null) continue; const n=+v; if(Number.isFinite(n)) return n; const t=Date.parse(v); if(!Number.isNaN(t)) return t; } return null; };

        /* ====================== Map init ====================== */
        const restored = (() => { try { return JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch { return null; } })();

        // create the map (we'll fit to province right after)
        const map = L.map('map', { center: restored?.center || INITIAL_VIEW.center, zoom: restored?.zoom || INITIAL_VIEW.zoom });

        // Save view as user moves
        map.on('moveend', () => {
          const c = map.getCenter();
          localStorage.setItem(LS_KEY, JSON.stringify({ center: [c.lat, c.lng], zoom: map.getZoom() }));
        });

        // Panes
        [['alwaysOnTopPopup',9999],
        ['sentinelPane',400],
        ['nbBoundaryPane',405],
        ['smokePane',410],
        ['perimetersPane',412],
        ['radarPane',413],
        ['lightningPane',413],
        ['viirsPane',414],
        ['weatherPane',640],   // raised above Leaflet's markerPane (600)
        ['aqiPane',416],
        ['firesPane',650],     // fires above stations
        ['planesPane',1000,true]]
          .forEach(([name, z, pe]) => { const p = map.createPane(name); p.style.zIndex = z; if (pe) p.style.pointerEvents = 'auto'; });

        L.esri.basemapLayer('Imagery').addTo(map);

        if (isMobile()) {
          L.control.locate({
            position: 'topleft', flyTo: true, showPopup: false, keepCurrentZoomLevel: true,
            icon: 'fa fa-location-crosshairs', strings: { title: 'Show me where I am' }
          }).addTo(map);
        }

        /* --- device-aware province fit with buffer --- */
        const fitPaddingPercent = () => (isMobile() ? 0.0001 : 0.04);
        function fitProvinceToView(options = {}) {
          const pct = fitPaddingPercent();
          const padX = Math.round(innerWidth  * pct);
          const padY = Math.round(innerHeight * pct);
          map.fitBounds(NB_BOUNDS, {
            paddingTopLeft: [padX, padY],
            paddingBottomRight: [padX, padY],
            ...options
          });
        }

        map.whenReady(() => fitProvinceToView({ animate: false }));

        let userHasInteracted = false;
        ['zoomstart','dragstart'].forEach(ev => map.on(ev, () => { userHasInteracted = true; }));
        const maybeRefit = () => { if (!userHasInteracted) fitProvinceToView({ animate: false }); };
        window.addEventListener('resize', maybeRefit);
        window.addEventListener('orientationchange', maybeRefit);

        /* ====================== Fires: GeoJSON + markercluster (no overlay toggles) ====================== */
        const fireStore = new Map();
        const fireClusters = L.markerClusterGroup({
          disableClusteringAtZoom: 11,
          spiderfyOnMaxZoom: true,
          zoomToBoundsOnClick: true,
          showCoverageOnHover: false,
          iconCreateFunction:(cluster)=>{
            const markers = cluster.getAllChildMarkers();
            let worst = { sev:-2, key:'extinguished' };
            for(const m of markers){
              const k = m.options._statusKey || 'extinguished';
              const sev = Number.isFinite(m.options._severity) ? m.options._severity : severityRank(k);
              if(sev > worst.sev){ worst = { sev, key: k }; }
            }
            const ring = statusColor(worst.key);
            const count = cluster.getChildCount();
            return L.divIcon({
              className:'fire-cluster-icon',
              html: `
                <div style="position:relative;display:inline-grid;place-items:center">
                  <div class="marker-badge" style="--ring:${ring};width:42px;height:42px">
                    <i class="fa-solid fa-fire"></i>
                  </div>
                  <div style="position:absolute;bottom:-6px;right:-6px;background:var(--panel-strong);border:2px solid ${ring};border-radius:999px;
                              font:800 12px/1.1 Inter,system-ui,Arial;padding:4px 7px;box-shadow:0 2px 8px rgba(0,0,0,.18)">${count}</div>
                </div>`,
              iconSize:[42,42], iconAnchor:[21,28], popupAnchor:[0,-24]
            });
          },
          pane: 'firesPane',
          clusterPane: 'firesPane' // keep clusters aligned with fires pane (ignored if unsupported, harmless)
        }).addTo(map);

        const activeMarkersAll = []; // all non-extinguished markers (kept for filtering)
        const outMarkersAll = [];    // extinguished markers

        function bindFirePopup(props, layer, explicitStatus) {
          const status = explicitStatus || props.FIRE_STAT_DESC_E || '—';
          const html = `
            <div style="font:14px/1.45 Inter,system-ui,Segoe UI,Arial;min-width:240px;color:var(--text)">
              <div style="font-weight:800;font-size:16px;margin-bottom:6px;letter-spacing:.2px">${props.FIRE_NAME || props.FIRE_ID || 'Unnamed Fire'}</div>
              <div style="margin:6px 0 10px">
                <span style="display:inline-flex;align-items:center;gap:8px;padding:5px 10px;border-radius:999px;background:var(--panel);border:1px solid var(--border);font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,.12)">
                  <span class="dot" style="background:${statusColor(status)}"></span>${status}
                </span>
              </div>
              <div><b>Area:</b> ${toNum(props.FIRE_SIZE ?? props.SIZE_HA ?? props.AREA,1)} ha</div>
              <div><b>Detected:</b> ${fmtDateTime(getDetectedMs(props))}</div>
              ${norm(status)==='extinguished'
                ? `<div><b>Extinguished:</b> ${fmtDateTime(getExtinguishedMs(props))}</div>`
                : `<div><b>Status updated:</b> ${fmtDateTime(props.FIRE_STAT_DATE)}</div>`}
            </div>`;
          layer.bindPopup(html,{maxWidth:340,pane:'alwaysOnTopPopup'});

          const rawId = props.GlobalID || props.OBJECTID || props.FIRE_ID || Math.random().toString(36).slice(2)+Date.now().toString(36);
          const id = String(rawId);
          fireStore.set(id,{ id, props, latlng: layer.getLatLng(), layer, statusKey: layer.options._statusKey });

          // hover/click UX
          let clicked=false, openT=null, closeT=null;
          const OPEN_MS=150, CLOSE_MS=60;
          const clearTimers=()=>{ if(openT){clearTimeout(openT);openT=null} if(closeT){clearTimeout(closeT);closeT=null} };
          layer.on('mouseover',function(){ if(clicked) return; if(closeT) clearTimeout(closeT);
            if(!openT){ openT=setTimeout(()=>{ openT=null; this.openPopup(); },OPEN_MS); }});
          layer.on('mouseout',function(){ if(clicked) return; if(openT) clearTimeout(openT);
            if(!closeT){ closeT=setTimeout(()=>{ closeT=null; this.closePopup(); },CLOSE_MS); }});
          layer.on('click',function(){ clicked=!clicked; clearTimers(); clicked?this.openPopup():this.closePopup(); });
          layer.on('remove', clearTimers);
        }

        function makeFireMarker(props, coords, explicitStatus){
          const [lng, lat] = coords; // GeoJSON order
          const statusKey = norm(explicitStatus || props.FIRE_STAT_DESC_E || '—');
          const marker = L.marker([lat, lng], {
            pane: 'firesPane', // ensure the individual fire markers are in the higher pane
            icon: L.divIcon({
              className:'fire-badge-icon',
              html:`<div class="marker-badge" style="--ring:${statusColor(statusKey)}"><i class="fa-solid fa-fire"></i></div>`,
              iconSize:[38,38],iconAnchor:[19,26],popupAnchor:[0,-22]
            }),
            keyboard:false
          });
          marker.options._statusKey = statusKey;
          marker.options._severity  = severityRank(statusKey);
          bindFirePopup(props, marker, explicitStatus);
          return marker;
        }

        async function fetchLocalAny(base){
          const attempts = [
            `${base}.json`, `${base}.geojson`,
            `./${base}.json`, `./${base}.geojson`,
            `data/${base}.json`, `data/${base}.geojson`,
            `./data/${base}.json`, `./data/${base}.geojson`,
          ];
          for (const url of attempts) {
            try { const r = await fetch(url, { cache:'no-store' }); if (r.ok) return await r.json(); } catch {}
          }
          throw new Error(`Could not load ${base} from any known path`);
        }

        async function loadLocalFires(){
          try {
            const [activeData, outData] = await Promise.all([
              fetchLocalAny('active_fires'),
              fetchLocalAny('out_fires')
            ]);

            (activeData.features||[]).forEach((f)=>{
              if (!f || f.geometry?.type !== 'Point') return;
              const m = makeFireMarker(f.properties||{}, f.geometry.coordinates, f.properties?.FIRE_STAT_DESC_E);
              activeMarkersAll.push(m);
              fireClusters.addLayer(m); // ACTIVE visible by default
            });

            (outData.features||[]).forEach((f)=>{
              if (!f || f.geometry?.type !== 'Point') return;
              const m = makeFireMarker(f.properties||{}, f.geometry.coordinates, 'Extinguished');
              outMarkersAll.push(m);
              // Extinguished OFF by default — not added
            });

            applyFireFilter();   // enforce initial checkbox state (Extinguished off)
            refreshSummary();    // summary uses fireStore
          } catch (e) {
            console.error('Loading local fires failed:', e);
          }
        }
        loadLocalFires();

        /* ====================== MODIS, Perimeters, NB boundary ====================== */
        const modis48 = L.esri.featureLayer({
          url:'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/MODIS_Thermal_v1/FeatureServer/0',
          pane:'viirsPane',
          pointToLayer:(_f,latlng)=>L.circleMarker(latlng,{radius:5,color:'var(--modis)',fillColor:'var(--modis)',fillOpacity:.9})
        }).addTo(map);

        const modis7d = L.esri.featureLayer({
          url:'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/MODIS_Thermal_v1/FeatureServer/1',
          pane:'viirsPane',
          pointToLayer:(_f,latlng)=>L.circleMarker(latlng,{radius:4,color:'var(--modis)',fillColor:'var(--modis)',fillOpacity:.65})
        });

        const PERIMETER_COLOR = cssVar('--perimeter');
        const perimeterLabelLayers = new Set();

        const activefires = L.esri.featureLayer({
          url:'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Active_Wildfire_Perimeters_in_Canada_View/FeatureServer/0',
          pane:'perimetersPane',
          style:()=>({color:PERIMETER_COLOR,weight:1.2,fillOpacity:.18}),
          onEachFeature:(feature,layer)=>{
            const ha = feature?.properties?.AREA;
            layer.bindTooltip(
              `<span class="perimeter-label" style="color:${PERIMETER_COLOR}">${toNum(ha,1)} ha</span>`,
              {permanent:true,className:'perimeter-label-tooltip',direction:'center',opacity:0}
            );
            perimeterLabelLayers.add(layer);
          }
        }).addTo(map);

        const setPerimeterLabels = ()=> {
          const show = map.getZoom() >= 11;
          perimeterLabelLayers.forEach((l)=>l.getTooltip()?.setOpacity(show?1:0));
        };
        activefires.on('load', setPerimeterLabels);
        map.on('zoomend', setPerimeterLabels);

        const nbBoundary = L.esri.featureLayer({
          url:'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Provinces_and_Territories_of_Canada/FeatureServer/0',
          where:"Name_EN = 'New Brunswick'",
          pane:'nbBoundaryPane',
          style:()=>({color: cssVar('--boundary'), weight:5, fill:false}),
          interactive:false
        }).addTo(map);

        /* ====================== Sentinel-2 imagery (public service) ====================== */
        const sentinel2 = L.esri.imageMapLayer({
          url:'https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer',
          opacity:0.75, pane:'sentinelPane'
        });

        sentinel2.on('load', ()=> sentinel2.bringToFront());

        /* ====================== Burn Bans (NB) ====================== */
        const nbBurnBans = L.esri.dynamicMapLayer({
          url:'https://gis-erd-der.gnb.ca/gisserver/rest/services/FireWeather/BurnCategories/MapServer',
          opacity:.7, pane:'perimetersPane'
        });

        /* ====================== Weather (clustered), Radar, Lightning, AQHI ====================== */
        function stationPopupHTML(p) {
          const fromDeg = Number(p.WindDirection);
          const dirTxt = Number.isFinite(fromDeg)
            ? (() => { const d=((fromDeg%360)+360)%360; const dirs=['N','NNE','NE','ENE','E','ESE','SE','S','SSW','SW','WSW','W','WNW','NW','NNW','N']; return dirs[Math.round(d/22.5)]; })()
            : '—';
          const kmh = Number(p.WindSpeed_kmh);
          const temp = p.Temperature_C !== '' && p.Temperature_C != null ? Math.round(Number(p.Temperature_C)) : null;
          const hum  = p.Humidity_Percent !== '' && p.Humidity_Percent != null ? Math.round(Number(p.Humidity_Percent)) : null;
          const name = p.StationName || p.location_name_en || 'Weather station';
          const when = p.observation_datetime_text_en || '';
          return `
            <div style="min-width:240px">
              <div style="font-weight:800;margin-bottom:4px">${name}</div>
              <div><b>Wind:</b> ${Number.isFinite(kmh) ? kmh : '—'} km/h • From ${dirTxt}${Number.isFinite(fromDeg) ? ' ('+Math.round(fromDeg)+'°)' : ''}</div>
              <div><b>Temp:</b> ${temp != null ? temp + '°C' : '—'}${hum != null ? ' • ' + hum + '%' : ''}</div>
              ${when ? `<div style="opacity:.8">${when}</div>` : ''}
            </div>`;
        }
        function stationSVG(p, size=84){
          const fromDeg = Number(p.WindDirection);
          const toDeg = Number.isFinite(fromDeg) ? (fromDeg + 180) % 360 : 0;
          const kmh = Number(p.WindSpeed_kmh);
          const dirTxt = Number.isFinite(fromDeg)
            ? (() => { const d=((fromDeg%360)+360)%360; const dirs=['N','NNE','NE','ENE','E','ESE','SE','S','SSW','SW','WSW','W','WNW','NW','NNW','N']; return dirs[Math.round(d/22.5)]; })()
            : '—';
          const temp = p.Temperature_C !== '' && p.Temperature_C != null ? Math.round(Number(p.Temperature_C)) : null;
          const hum  = p.Humidity_Percent !== '' && p.Humidity_Percent != null ? Math.round(Number(p.Humidity_Percent)) : null;
          const arrowPathD = "M42 14 Q52 30 58 58 Q42 48 42 48 Q42 48 26 58 Q32 30 42 14 Z";
          const scale = size/84;
          return `
            <svg class="ws-svg" width="${84*scale}" height="${92*scale}" viewBox="0 0 84 92" aria-hidden="true" role="img"
                 style="position:relative; z-index:1; filter:drop-shadow(0 2px 2px rgba(0,0,0,.25))">
              <circle cx="42" cy="42" r="34" fill="#0b0f19" stroke="#ffffff" stroke-width="2.5"/>
              <g transform="rotate(${toDeg} 42 42)">
                <path d="${arrowPathD}" fill="#999999" stroke="#999999" stroke-width="1.8" stroke-linejoin="round"></path>
                <g transform="rotate(${-toDeg} 42 42)">
                  <text x="42" y="26" text-anchor="middle" class="ws-small">From ${dirTxt}</text>
                  <text x="42" y="42" text-anchor="middle" class="ws-speed">${Number.isFinite(kmh) ? kmh : '—'} km/h</text>
                  <text x="42" y="58" text-anchor="middle" class="ws-small">
                    ${temp != null ? temp + '°C' : '—'}${hum != null ? ' • ' + hum + '%' : ''}
                  </text>
                </g>
              </g>
            </svg>`;
        }
        function makeStationMarker(feature, latlng) {
          const p = feature.properties || {};
          const icon = L.divIcon({ className: 'ws-div', html: stationSVG(p, 84), iconSize: [84, 92], iconAnchor: [42, 54], popupAnchor: [0, -44] });
          const m = L.marker(latlng, { icon, pane: 'weatherPane' });
          m.options._stationProps = p;

          const fromDeg = Number(p.WindDirection);
          const dirTxt = Number.isFinite(fromDeg)
            ? (() => { const d=((fromDeg%360)+360)%360; const dirs=['N','NNE','NE','ENE','E','ESE','SE','S','SSW','SW','WSW','W','WNW','NW','NNW','N']; return dirs[Math.round(d/22.5)]; })()
            : '—';
          const kmh = Number(p.WindSpeed_kmh);
          const temp = p.Temperature_C !== '' && p.Temperature_C != null ? Math.round(Number(p.Temperature_C)) : null;
          const hum  = p.Humidity_Percent !== '' && p.Humidity_Percent != null ? Math.round(Number(p.Humidity_Percent)) : null;

          m.bindTooltip(
            `Wind: ${Number.isFinite(kmh) ? kmh : '—'} km/h • From ${dirTxt}${
              temp != null ? ' • ' + temp + '°C' : ''
            }${hum != null ? ' • ' + hum + '%' : ''}`,
            { direction: 'top', offset: [0, -36], opacity: 0 }
          );
          m.bindPopup(stationPopupHTML(p), { pane: 'alwaysOnTopPopup' });
          return m;
        }
        const weatherStations = L.esri.Cluster.featureLayer({
          url: 'https://services.arcgis.com/zmLUiqh7X11gGV2d/ArcGIS/rest/services/EnvironmentCanada/FeatureServer/0',
          pane: 'weatherPane',
          clusterPane: 'weatherPane', // align cluster icons; ignored if unsupported
          spiderfyOnMaxZoom: true,
          disableClusteringAtZoom: 10,
          zoomToBoundsOnClick: false,
          showCoverageOnHover: false,
          pointToLayer: makeStationMarker,
          iconCreateFunction: (cluster) => {
            const center = cluster.getLatLng();
            const markers = cluster.getAllChildMarkers();
            let best = null, bestDist = Infinity;
            for (const m of markers) {
              const d = map.distance(center, m.getLatLng());
              if (d < bestDist) { bestDist = d; best = m; }
            }
            const p = best?.options?._stationProps || {};
            return L.divIcon({
              className: 'ws-cluster-icon',
              html: `
                <div style="position:relative;display:inline-grid;place-items:center">
                  ${stationSVG(p, 84)}
                  <div style="position:absolute;bottom:8px;right:8px;z-index:2;background:var(--panel-strong);border:2px solid #111827;border-radius:999px;
                              font:800 12px/1.1 Inter,system-ui,Arial;padding:4px 7px;box-shadow:0 2px 8px rgba(0,0,0,.18);pointer-events:none">
                    ${cluster.getChildCount()}
                  </div>
                </div>`,
              iconSize: [84, 92], iconAnchor: [42, 54], popupAnchor: [0, -44]
            });
          }
        }).addTo(map);

        const noaaRadar = L.esri.imageMapLayer({
          url:'https://mapservices.weather.noaa.gov/eventdriven/rest/services/radar/radar_base_reflectivity_time/ImageServer',
          opacity:.8, pane:'radarPane'
        });
        const lightningLayer = L.tileLayer.wms('https://geo.weather.gc.ca/geomet',{
          layers:'Lightning_2.5km_Density',version:'1.3.0',format:'image/png',transparent:true,opacity:1,pane:'lightningPane'
        });
        let lightningTimer=null;
        const startLightningRefresh=()=>{ if(!lightningTimer){ lightningTimer=setInterval(()=>{ lightningLayer.setParams({_ :Date.now()}); }, LIGHTNING_REFRESH_MS); } };
        const stopLightningRefresh = ()=>{ if(lightningTimer){ clearInterval(lightningTimer); lightningTimer=null; } };
        map.on('overlayadd',(e)=>{ if(e.layer===lightningLayer) startLightningRefresh(); if(e.layer===sentinel2) sentinel2.bringToFront(); });
        map.on('overlayremove',(e)=>{ if(e.layer===lightningLayer) stopLightningRefresh(); });

        const fireRiskGroup = L.layerGroup().addLayer(L.tileLayer.wms('https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms', {
          layers:'public:fdr_current', format:'image/png', transparent:true, version:'1.1.1',
          opacity:.4, pane:'perimetersPane', attribution:'CWFIS © Natural Resources Canada'
        }));

        /* ====================== NOAA Smoke (timelapse, off by default) ====================== */
        const NOAA_SMOKE_URL = 'https://mapservices.weather.noaa.gov/raster/rest/services/air_quality/ndgd_smoke_sfc_1hr_avg_time/ImageServer';
        const SMOKE_HOURS_EACH_SIDE = 8;      // ± hours around “now”
        const SMOKE_FRAME_MS = 1200;          // ms per frame

        // The layer itself (not added to map => OFF by default)
        const smokeLayer = L.esri.imageMapLayer({
          url: NOAA_SMOKE_URL,
          format: 'png32',
          transparent: true,
          opacity: 0.72,
          pane: 'smokePane'
        });

        // Timeline UI refs
        const smokeControls   = document.getElementById('smokeControls');
        const smokePlayBtn    = document.getElementById('smokePlay');
        const smokeSlider     = document.getElementById('smokeTime');
        const smokeTsLabel    = document.getElementById('smokeTimestamp');

        // Animation state
        let smokeTimesMs = [];
        let smokeUsedFallback = false;
        let smokeIdx = 0;
        let smokeTimer = null;

        function smokeFmt(ms){
          const d = new Date(ms);
          const local = d.toLocaleString(undefined, {
            year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false
          });
          const iso = d.toISOString().replace('T',' ').replace('.000Z','Z');
          return `${local} (local) | ${iso} • frame ${smokeIdx+1}/${smokeTimesMs.length}` +
                 (smokeUsedFallback ? ' • closest frames to now' : '');
        }

        function smokeSetIndex(i){
          if (!smokeTimesMs.length) return;
          smokeIdx = Math.max(0, Math.min(smokeTimesMs.length - 1, i));
          const t = smokeTimesMs[smokeIdx];
          const dt = new Date(t);
          smokeLayer.setTimeRange(dt, dt); // snapshot at t
          smokeSlider.value = String(smokeIdx);
          smokeTsLabel.textContent = smokeFmt(t);
        }

        function smokePlay(){
          if (smokeTimer || !smokeTimesMs.length) return;
          smokePlayBtn.textContent = '⏸';
          smokeTimer = setInterval(() => {
            smokeSetIndex((smokeIdx + 1) % smokeTimesMs.length);
          }, SMOKE_FRAME_MS);
        }
        function smokePause(){
          smokePlayBtn.textContent = '▶';
          if (smokeTimer){ clearInterval(smokeTimer); smokeTimer = null; }
        }

        smokePlayBtn.addEventListener('click', () => (smokeTimer ? smokePause() : smokePlay()));
        smokeSlider.addEventListener('input', (e) => { smokePause(); smokeSetIndex(parseInt(e.target.value, 10)); });

        async function initSmokeTimes(){
          try{
            smokeTsLabel.textContent = 'Loading…';
            const r = await fetch(NOAA_SMOKE_URL + '/slices?f=json');
            if(!r.ok) throw new Error('Failed to load time slices');
            const json = await r.json();
            const allTimes = (json.slices || [])
              .map(s => s.multidimensionalDefinition?.[0]?.values?.[0])
              .filter(v => typeof v === 'number')
              .sort((a,b)=>a-b);

            if(!allTimes.length){
              smokeTsLabel.textContent = 'No time frames available';
              return;
            }

            const now = Date.now();
            const windowMs = SMOKE_HOURS_EACH_SIDE * 3600 * 1000;
            let within = allTimes.filter(t => t >= (now - windowMs) && t <= (now + windowMs));

            smokeUsedFallback = false;
            if(within.length === 0){
              smokeUsedFallback = true;
              // nearest index to now
              let lo=0, hi=allTimes.length-1, best=0, bestDiff=Infinity;
              while(lo<=hi){
                const mid=(lo+hi)>>1, diff=Math.abs(allTimes[mid]-now);
                if(diff<bestDiff){ bestDiff=diff; best=mid; }
                if(allTimes[mid] < now) lo=mid+1; else hi=mid-1;
              }
              const start = Math.max(0, best - SMOKE_HOURS_EACH_SIDE);
              const end   = Math.min(allTimes.length - 1, best + SMOKE_HOURS_EACH_SIDE);
              within = allTimes.slice(start, end+1);
            }

            smokeTimesMs = within;
            smokeSlider.max = String(within.length - 1);
            smokeIdx = 0;
            smokeSlider.value = '0';
            smokeTsLabel.textContent = 'Ready';
          } catch (e){
            console.error('Smoke slices error:', e);
            smokeTsLabel.textContent = 'Error loading smoke timeline';
          }
        }

        // Prepare timeline immediately (controls still hidden until layer is turned on)
        initSmokeTimes();

        // Keep the controls above the footer (measure dynamically)
        function updateFooterOffset(){
          const footer = document.querySelector('.nb-footer');
          let offset = 0;
          if (footer){
            const rect = footer.getBoundingClientRect();
            const visible = rect.height > 0 && rect.bottom > 0;
            if (visible) offset = rect.height + 16; // breathing room
          }
          document.documentElement.style.setProperty('--footer-offset', offset + 'px');
        }
        updateFooterOffset();
        window.addEventListener('resize', updateFooterOffset);
        window.addEventListener('orientationchange', updateFooterOffset);

        // Show/hide controls + start/stop when the overlay is toggled
        map.on('overlayadd', (e) => {
          if (e.layer === smokeLayer) {
            updateFooterOffset();
            smokeControls.style.display = 'flex';
            if (smokeTimesMs.length) {
              smokeSetIndex(smokeIdx || 0);
              smokePlay();
            } else {
              smokeTsLabel.textContent = 'Loading…';
            }
            smokeLayer.bringToBack();
          }
        });
        map.on('overlayremove', (e) => {
          if (e.layer === smokeLayer) {
            smokePause();
            smokeControls.style.display = 'none';
          }
        });

        const aqhiLayer = L.esri.featureLayer({
          url:'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/aqhi_stations_observations_realtime/FeatureServer/1',
          pane:'aqiPane',
          pointToLayer:(feature,latlng)=> {
            const p=feature.properties||{};
            const raw=p.aqhi??p.aqhi_round; const val=(raw==null||Number.isNaN(Number(raw)))?null:Number(raw);
            const label=val==null?'—':val>=10?'Very High Risk':val>=7?'High Risk':val>=4?'Moderate Risk':'Low Risk';
            const color=val==null?'#6b7280':val>=10?'#8b5cf6':val>=7?'#ef4444':val>=4?'#eab308':'#22c55e';
            const icon=L.divIcon({className:'aqi-badge-icon',html:`
              <div style="display:flex;flex-direction:column;align-items:center;">
                <svg width="26" height="26" viewBox="0 0 26 26" style="filter:drop-shadow(0 2px 2px rgba(0,0,0,.25));">
                  <circle cx="13" cy="13" r="11" stroke="#111827" stroke-width="2" fill="${color}" />
                </svg>
                <div style="margin-top:2px;font-size:12px;font-weight:800;color:var(--text);background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:4px 8px;line-height:1.15;text-align:center;box-shadow:var(--shadow-soft)">
                  AQHI ${val ?? '—'} <span style="opacity:.8">${label}</span>
                </div>
              </div>`, iconSize:[28,48], iconAnchor:[14,24], popupAnchor:[0,-22]});
            const m=L.marker(latlng,{icon});
            const loc=p.location_name_en||''; const when=p.observation_datetime_text_en||'';
            m.bindTooltip(`${loc?loc+' — ':''}AQHI ${val ?? '—'} • ${label}${when?' • '+when:''}`,{direction:'top',offset:[0,-20],opacity:0});
            return m;
          }
        });

        /* ====================== Aircraft tracking (OpenSky) ====================== */
        const planesLayer = L.layerGroup(); const planeMarkers=new Map();
        const makePlaneIcon=(heading)=>{ const ICON_OFFSET=-45;
          const rotate=Number.isFinite(heading)?heading:0;
          return L.divIcon({className:'plane-div-icon',html:`<div style="transform:rotate(${ICON_OFFSET}deg);transform-origin:center;display:inline-block;">
              <div style="transform:rotate(${rotate}deg);font-size:26px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.25))">✈️</div></div>`,
            iconSize:[30,46],iconAnchor:[15,23]}); };
        const upsertPlane=(id,lat,lon,hdg,callsign,vel)=> {
          const html = `<b>${callsign||'Unknown'}</b><br>Heading: ${Number.isFinite(hdg)?Math.round(hdg):'—'}°<br>Speed: ${vel!=null?Math.round(vel*1.94384):'—'} kt`;
          let m=planeMarkers.get(id);
          if(!m){
            m=L.marker([lat,lon],{icon:makePlaneIcon(hdg),pane:'planesPane',keyboard:false,zIndexOffset:10000}).bindPopup(html,{pane:'alwaysOnTopPopup'});
            let clicked=false;
            m.on('mouseover',function(){ if(!clicked) this.openPopup(); });
            m.on('mouseout',function(){ if(!clicked) this.closePopup(); });
            m.on('click',function(){ clicked=!clicked; clicked?this.openPopup():this.closePopup(); });
            m.addTo(planesLayer); planeMarkers.set(id,m);
          } else {
            m.setLatLng([lat,lon]); m.setIcon(makePlaneIcon(hdg)); m.setPopupContent(html);
          }
        };
        const pruneMissing=(seen)=>{ for(const [k,m] of planeMarkers.entries()){ if(!seen.has(k)){ planesLayer.removeLayer(m); planeMarkers.delete(k); } } };
        async function fetchOpenSky(){ try{
          const [[lamin,lomin],[lamax,lomax]] = NB_BOUNDS;
          const r=await fetch(`${OPEN_SKY_URL}?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`, { cache:'no-store' });
          if(!r.ok) throw new Error(r.statusText);
          const data=await r.json(); const states=Array.isArray(data.states)?data.states:[]; const seen=new Set();
          for(const s of states){ const icao24=s[0], callsign=(s[1]||'').trim().toUpperCase(), lon=s[5], lat=s[6], vel=s[9], hdg=s[10];
            if(!icao24||lat==null||lon==null) continue; seen.add(icao24); upsertPlane(icao24,lat,lon,hdg,callsign,vel); }
          pruneMissing(seen);
        } catch(e){ console.warn('OpenSky fetch failed:', e); } }
        let planesTimer=null;
        planesLayer.on('add',()=>{ fetchOpenSky(); if(!planesTimer) planesTimer=setInterval(fetchOpenSky,OPEN_SKY_INTERVAL_MS); });
        planesLayer.on('remove',()=>{ if(planesTimer){ clearInterval(planesTimer); planesTimer=null; } });

        /* ====================== Cities ====================== */
        const cityMarkers=L.layerGroup(
          [
            ['Fredericton',45.9636,-66.6431],['Saint John',45.2733,-66.0633],['Moncton',46.0878,-64.7782],
            ['Bathurst',47.6186,-65.6517],['Miramichi',47.0281,-65.5019],['Edmundston',47.3730,-68.3251],
            ['Campbellton',48.0075,-66.6731],['Dieppe',46.0842,-64.6877],['Riverview',46.0617,-64.8052],
            ['Quispamsis',45.4319,-65.9469],['Oromocto',45.8491,-66.4828],['Woodstock',46.1527,-67.6016],
            ['Grand Falls',47.0469,-67.7394],['Shediac',46.2197,-64.5403],['Tracadie',47.5081,-64.9117],
            ['St. Stephen',45.1942,-67.2756],['Shippagan',47.7400,-64.7078],['Caraquet',47.7943,-64.9386],
            ['Bouctouche',46.4711,-64.7400],['Sussex',45.7221,-65.5060]
          ].map(([name,lat,lng])=>L.marker([lat,lng],{icon:L.divIcon({html:'',iconSize:[0,0]}),interactive:false,zIndexOffset:1000})
            .bindTooltip(`<span class="city-label">${name}</span>`,{permanent:true,direction:'top',className:'city-label-tooltip'}))
        );

        /* ====================== Overlays + control (no separate fire toggles) ====================== */
        const overlays = {
          'MODIS Hotspots — Last 48 hours': modis48,
          'MODIS Hotspots — Last 7 days': modis7d,
          'Weather Stations': weatherStations,
          'Fire Perimeters': activefires,
          'Sentinel-2 Imagery': sentinel2,
          'NB Burn Bans': nbBurnBans,
          'AQHI Risk': aqhiLayer,
          'Weather Radar': noaaRadar,
          'Lightning Density': lightningLayer,
          Smoke: smokeLayer,
          'Fire Risk': fireRiskGroup,
          Aircraft: planesLayer,
          'Major Cities & Towns': cityMarkers
        };
        L.control.layers(null, overlays, { collapsed: false }).addTo(map);

        /* ======== Fire Status panel (Extinguished OFF by default) ======== */
        const FIRE_STATUS = [
          ['Out of Control', cssVar('--oc'), true],
          ['Contained',      cssVar('--cont'), true],
          ['Under Control',  cssVar('--uc'), true],
          ['Being Patrolled',cssVar('--pat'), true],
          ['Being Monitored',cssVar('--mon'), true],
          ['Extinguished',   '#9aa0a6', false]
        ];
        function applyFireFilter(){
          const cbs = document.querySelectorAll('.fire-filter-block input[type="checkbox"]');
          const enabled = new Set(); cbs.forEach(cb => { if (cb.checked) enabled.add(norm(cb.getAttribute('data-status'))); });
          for (const m of activeMarkersAll) {
            const show = enabled.has(m.options._statusKey);
            if (show && !fireClusters.hasLayer(m)) fireClusters.addLayer(m);
            if (!show && fireClusters.hasLayer(m)) fireClusters.removeLayer(m);
          }
          const showOut = enabled.has('extinguished');
          for (const m of outMarkersAll) {
            if (showOut && !fireClusters.hasLayer(m)) fireClusters.addLayer(m);
            if (!showOut && fireClusters.hasLayer(m)) fireClusters.removeLayer(m);
          }
        }
        function injectFireStatusPanel(){
          const overlaysList = document.querySelector('.leaflet-control-layers-overlays');
          if(!overlaysList || overlaysList.querySelector('.fire-filter-block')) return;
          const block = document.createElement('div');
          block.className = 'fire-filter-block';
          block.innerHTML = `
            <div class="fire-filter-title">Fire Status</div>
            ${FIRE_STATUS.map(([label, ring, checked]) => `
              <label class="fire-filter-row">
                <input type="checkbox" data-status="${label}" ${checked ? 'checked' : ''}>
                <span class="legend-badge" style="--ring:${ring}">
                  <i class="fa-solid fa-fire"></i>
                </span>
                <span class="text">${label}</span>
              </label>
            `).join('')}
          `;
          overlaysList.prepend(block);
          block.addEventListener('change', applyFireFilter);
        }
        injectFireStatusPanel();

        /* ====================== Summary (scrollable body) ====================== */
        const fsOverlay=document.getElementById('fireSummaryOverlay');
        const fsBody=document.getElementById('fs-body');
        const chip=(label,n)=>`<span class="chip"><span class="dot" style="background:${statusColor(label)}"></span>${label} <span style="font-weight:800;margin-left:6px">${n}</span></span>`;
        const sizeOf=(p)=> Number((p?.FIRE_SIZE ?? p?.SIZE_HA ?? p?.AREA) ?? 0) || 0;

        function buildSummaryHTML(){
          const items=[...fireStore.values()];
          const year = new Date().getFullYear();

          let totalArea=0, counts={'out of control':0,contained:0,'under control':0,'being patrolled':0,'being monitored':0,extinguished:0,other:0};
          let newToday=0, newYesterday=0, extToday=0, extYesterday=0, totalActive=0, totalExt=0;

          for(const it of items){
            const p=it.props||{};
            totalArea += sizeOf(p);
            const key=norm(it.statusKey || p.FIRE_STAT_DESC_E);
            if (Object.prototype.hasOwnProperty.call(counts,key)) counts[key]++; else counts.other++;
            if (key === 'extinguished') totalExt++; else totalActive++;

            const det = getDetectedMs(p);
            if(det!=null){ if(isToday(det)) newToday++; else if(isYesterday(det)) newYesterday++; }

            if (key === 'extinguished') {
              const outMs = getExtinguishedMs(p);
              if (outMs!=null){ if (isToday(outMs)) extToday++; else if (isYesterday(outMs)) extYesterday++; }
            }
          }

          const chipsHTML=[
            ['Out of Control',counts['out of control']],
            ['Contained',counts['contained']],
            ['Under Control',counts['under control']],
            ['Being Patrolled',counts['being patrolled']],
            ['Being Monitored',counts['being monitored']],
            ['Extinguished',counts['extinguished']]
          ].map(([l,n])=>chip(l,n)).join('');

          const byStatus = new Map();
          for (const it of items) {
            const st = norm(it.statusKey || it.props?.FIRE_STAT_DESC_E || 'other');
            if (!byStatus.has(st)) byStatus.set(st, []);
            byStatus.get(st).push(it);
          }
          for (const arr of byStatus.values()) {
            arr.sort((a,b)=> sizeOf(b.props) - sizeOf(a.props));
          }
          const statusOrder = ['out of control','contained','under control','being patrolled','being monitored','extinguished','other'];

          const detailSections = statusOrder
            .filter(k => byStatus.has(k))
            .map(k => {
              const label = k==='other' ? 'Other' : k.replace(/\b\w/g, c=>c.toUpperCase());
              const list = byStatus.get(k).map((it) => {
                const p=it.props||{};
                const name = p.FIRE_NAME || p.FIRE_ID || 'Unnamed Fire';
                const size = toNum(sizeOf(p),0);
                const det  = fmtDateTZ(getDetectedMs(p));
                const extra = (k==='extinguished') ? ` • Out: ${fmtDateTZ(getExtinguishedMs(p))}` : '';
                return `<li style="margin:4px 0;"><a href="#" data-fireid="${it.id}"><span style="font-weight:700">${name}</span>&nbsp;—&nbsp;${size} ha <span style="opacity:.8">• ${label}</span> <span style="opacity:.8">• Detected: ${det}${extra}</span></a></li>`;
              }).join('') || '<li>None</li>';
              return `<div style="margin:10px 0"><b>${label}</b><ol class="summary-list">${list}</ol></div>`;
            }).join('');

          const totalFiresYear = totalActive + totalExt;

          return `
            <div class="fs-meta-grid">
              <div class="stat"><div class="h">Total Fires (${year})</div><div class="v">${toNum(totalFiresYear,0)}</div></div>
              <div class="stat"><div class="h">Active</div><div class="v">${toNum(totalActive,0)}</div></div>
              <div class="stat"><div class="h">Extinguished</div><div class="v">${toNum(totalExt,0)}</div></div>
              <div class="stat"><div class="h">New Fires Today</div><div class="v">${toNum(newToday,0)}</div></div>
              <div class="stat"><div class="h">New Fires Yesterday</div><div class="v">${toNum(newYesterday,0)}</div></div>
              <div class="stat"><div class="h">Total Area Burned</div><div class="v">${toNum(totalArea,0)} ha</div></div>
              <div class="stat"><div class="h">Extinguished Today</div><div class="v">${toNum(extToday,0)}</div></div>
              <div class="stat"><div class="h">Extinguished Yesterday</div><div class="v">${toNum(extYesterday,0)}</div></div>
            </div>

            <div style="margin:8px 0 6px"><b>Fires by status</b></div>
            <div>${chipsHTML}</div>

            <div style="margin-top:12px"><b>Fires (largest → smallest)</b></div>
            <div class="fs-scroll" id="fs-scroll">
              ${detailSections}
            </div>

            <div style="margin-top:10px;font-size:12px;color:var(--muted)">“Today / yesterday” uses Atlantic Time. Sources: local <b>active_fires</b> &amp; <b>out_fires</b>.</div>`;
        }

        function refreshSummary(){ fsBody.innerHTML = buildSummaryHTML(); wireSummaryClicks(); }
        function wireSummaryClicks(){
          const cont = document.getElementById('fs-scroll'); if(!cont) return;
          cont.addEventListener('click', (e)=>{
            const a = e.target.closest('a[data-fireid]'); if(!a) return;
            e.preventDefault();
            const rec=fireStore.get(a.getAttribute('data-fireid')); if(!rec) return;
            fsOverlay.style.display='none'; fsOverlay.hidden=true;
            map.flyTo(rec.latlng,Math.max(map.getZoom(),12),{duration:.6});
            map.once('moveend',()=>rec.layer?.openPopup&&rec.layer.openPopup());
          });
        }

        document.getElementById('fireSummaryBtn').addEventListener('click',()=>{ refreshSummary(); fsOverlay.hidden=false; fsOverlay.style.display='flex'; });
        document.getElementById('fs-close').addEventListener('click',()=>{ fsOverlay.style.display='none'; fsOverlay.hidden=true; });
        fsOverlay.addEventListener('click',(e)=>{ if(e.target===fsOverlay){ fsOverlay.style.display='none'; fsOverlay.hidden=true; } });

        /* ====================== Show/Hide Legend + Reset view ====================== */
        const mapToggleBtn = document.getElementById('mapToggleBtn');
        const mtbText = document.getElementById('mtb-text');

        function updateLegendButton(){
          const hidden = document.body.classList.contains('map-ui-hidden');
          const label = hidden ? 'Show Legend' : 'Hide Legend';
          mapToggleBtn.setAttribute('aria-pressed', String(!hidden));
          mapToggleBtn.title = label;
          mtbText.textContent = label;
        }

        // Default: legend visible on desktop, hidden on mobile
        document.body.classList.toggle('map-ui-hidden', isMobile());
        updateLegendButton();

        mapToggleBtn.addEventListener('click', () => {
          document.body.classList.toggle('map-ui-hidden');
          updateLegendButton();
        });

        document.getElementById('resetViewBtn').addEventListener('click', () => {
          localStorage.removeItem(LS_KEY);
          fitProvinceToView({ animate: true }); // device-aware fit on reset
        });

      });
    </script>
  </body>
</html>
