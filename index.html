<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>New Brunswick Wildfire Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* Layout */
    html, body, #map { height: 100%; margin: 0; padding: 0; }

    /* Controls container scroll */
    .leaflet-control-layers-expanded { max-height: 300px; overflow-y: auto; }

    /* Shared button style */
    .map-btn {
      position: absolute;
      z-index: 1001;
      background: #fff;
      border: 1px solid #bbb;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 15px;
      font-family: 'Segoe UI', Arial, sans-serif;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.13);
      transition: background 0.2s;
    }
    .map-btn:hover { background: #f0f0f0; }

    /* Specific button positions */
    .map-toggle-btn { top: 12px; right: 12px; }
    .reset-view-btn { top: 12px; left: 12px; z-index: 1002; }

    /* Move zoom/GPS controls down a touch (still below reset button) */
    .leaflet-top.leaflet-left { top: 40px !important; }
    .leaflet-top.leaflet-right { top: 60px !important; }
    .info.legend { bottom: 70px !important; }

    /* Toggle opacity for legend/layers as a group */
    .leaflet-control-layers, .info.legend { transition: opacity 0.2s; }
    .map-ui-hidden .leaflet-control-layers,
    .map-ui-hidden .info.legend {
      opacity: 0; pointer-events: none;
    }

    /* Modern city label style */
    .city-label-tooltip {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin: 0 !important;
      pointer-events: none;
    }
    .city-label-tooltip::before { display: none !important; }
    .city-label {
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 15px;
      font-weight: 700;
      color: #fff;
      text-shadow:
        -1px -1px 0 #000,  1px -1px 0 #000,
        -1px  1px 0 #000,  1px  1px 0 #000;
      background: none;
      padding: 0; margin: 0;
    }

    /* Perimeter labels (centered, color-matched, with mask-like halo) */
    .perimeter-label-tooltip {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
    }
    .perimeter-label-tooltip::before { display:none !important; }
    .perimeter-label {
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 12px;
      font-weight: 800;
      text-shadow:
        -2px -2px 0 rgba(255,255,255,0.85),
         2px -2px 0 rgba(255,255,255,0.85),
        -2px  2px 0 rgba(255,255,255,0.85),
         2px  2px 0 rgba(255,255,255,0.85);
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="mapToggleBtn" class="map-btn map-toggle-btn">Show Legend & Layers</button>
  <button id="resetViewBtn" class="map-btn reset-view-btn" title="Reset map view">Reset Map View</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet-image/dist/esri-leaflet-image.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
  <script src="callsigns.js"></script>
  <script>
    /* =========================
       Constants & Utilities
    ========================== */
    var LS_KEY = 'nbMapView';

    var nbBounds = [
      [44.0, -69.5], // Southwest corner (a bit outside NB)
      [48.5, -62.0]  // Northeast corner (a bit outside NB)
    ];

    var initialView = {
      center: [46.7, -66.2],
      zoom: window.innerWidth < 768 ? 7 : 8
    };

    function isMobile() { return window.innerWidth < 768; }

    function getSavedView() {
      var saved = localStorage.getItem(LS_KEY);
      if (!saved) return null;
      try { return JSON.parse(saved); } catch(e) { return null; }
    }

    function saveView(map) {
      localStorage.setItem(LS_KEY, JSON.stringify({
        center: map.getCenter(),
        zoom: map.getZoom()
      }));
    }

    function normalizeFireStatus(label) {
      return (label || '').toString().trim().toLowerCase();
    }

    function fireStatusColor(label) {
      switch (normalizeFireStatus(label)) {
        case 'out of control': return 'red';
        case 'contained': return 'orange';
        case 'under control': return 'yellow';
        case 'being patrolled': return 'green';
        default: return 'gray';
      }
    }

    // Niceness helpers
    function formatEsriDate(v) {
      if (!v && v !== 0) return '—';
      try {
        const d = new Date(Number(v));
        return d.toLocaleString(undefined, {
          year: 'numeric', month: 'short', day: '2-digit',
          hour: '2-digit', minute: '2-digit'
        });
      } catch { return '—'; }
    }
    function numberFmt(n, digits=1) {
      return (n == null || isNaN(n)) ? '—' : Number(n).toLocaleString(undefined,{maximumFractionDigits:digits});
    }

    /* =========================
       Map Init & Basemaps
    ========================== */
    var restored = getSavedView();
    var map = L.map('map', {
      center: restored ? restored.center : initialView.center,
      zoom: restored ? restored.zoom : initialView.zoom,
      minZoom: 7,
      maxBounds: nbBounds,
      maxBoundsViscosity: 0.5
    }).on('moveend', function(){ saveView(map); });

    var esriImagery = L.esri.basemapLayer('Imagery').addTo(map);

    var sentinel2c = L.esri.imageMapLayer({
      url: 'https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer',
      opacity: 0.7
    });

    if (isMobile()) {
      L.control.locate({
        position: 'topleft',
        flyTo: true,
        showPopup: false,
        keepCurrentZoomLevel: true,
        icon: 'fa fa-location-crosshairs',
        strings: { title: "Show me where I am" }
      }).addTo(map);
      map.fitBounds(nbBounds, { padding: [30, 30] });
    }

    /* =========================
       Panes (z-ordering)
    ========================== */
    map.createPane('viirsPane');         map.getPane('viirsPane').style.zIndex = 410;
    map.createPane('nbBoundaryPane');    map.getPane('nbBoundaryPane').style.zIndex = 405;

    /* =========================
       Layers
    ========================== */

    // NB Active Wild Fires (on by default) — buffered hitbox + debounced hover
    var nbActiveWildFires = L.esri.featureLayer({
      url: 'https://gis-erd-der.gnb.ca/arcgis/rest/services/Fire_Dashboards/Public_Fires/MapServer/0',
      pointToLayer: function(feature, latlng) {
  var color = fireStatusColor(feature.properties.FIRE_STAT_DESC_E);

  var icon = L.divIcon({
    className: 'fire-triangle-icon',
    html: `
      <div style="width:44px;height:44px;display:flex;align-items:center;justify-content:center;">
        <svg width="32" height="32" viewBox="0 0 32 32" style="display:block; margin-top:4px;">
          <polygon points="16,4 28,28 4,28" style="fill:${color};stroke:#222;stroke-width:2" />
        </svg>
      </div>
    `,
    iconSize: [44, 44],
    iconAnchor: [22, 30] // X=half width, Y = triangle tip in box
  });

  return L.marker(latlng, { icon });
},
      onEachFeature: function (feature, layer) {
        const p = feature.properties || {};
        const status = p.FIRE_STAT_DESC_E || '—';
        const sizeHa = p.FIRE_SIZE; // likely hectares from source
        const detected = formatEsriDate(p.TIME_DETECTED);
        const statusDate = formatEsriDate(p.FIRE_STAT_DATE);
        const statusColor = fireStatusColor(status);

        const popupHTML = `
          <div style="font:14px 'Segoe UI',Arial,sans-serif;min-width:220px">
            <div style="font-weight:800;font-size:16px;margin-bottom:6px">${p.FIRE_NAME || 'Unnamed Fire'}</div>
            <div style="margin:6px 0 10px">
              <span style="display:inline-block;padding:2px 8px;border-radius:999px;background:${statusColor};color:#111;font-weight:700">
                ${status}
              </span>
            </div>
            <div style="line-height:1.35">
              <div><b>Area:</b> ${numberFmt(sizeHa,1)} ha</div>
              <div><b>Detected:</b> ${detected}</div>
              <div><b>Status updated:</b> ${statusDate}</div>
            </div>
          </div>
        `;
        layer.bindPopup(popupHTML, { maxWidth: 320 });

        // --- Debounced hover handlers (snappier)
let clickedOpen = false;
let openT = null, closeT = null;
const OPEN_DELAY = 150;  // was 250
const CLOSE_DELAY = 60;  // was 150

function clearTimers() {
  if (openT) { clearTimeout(openT); openT = null; }
  if (closeT) { clearTimeout(closeT); closeT = null; }
}

layer.on('mouseover', function() {
  if (clickedOpen) return;
  if (closeT) { clearTimeout(closeT); closeT = null; }
  if (!openT) {
    openT = setTimeout(() => {
      openT = null;
      this.openPopup();
    }, OPEN_DELAY);
  }
});

layer.on('mouseout', function() {
  if (clickedOpen) return;
  if (openT) { clearTimeout(openT); openT = null; }
  if (!closeT) {
    closeT = setTimeout(() => {
      closeT = null;
      this.closePopup();
    }, CLOSE_DELAY);
  }
});

layer.on('click', function() {
  clickedOpen = !clickedOpen;
  clearTimers();
  if (clickedOpen) this.openPopup(); else this.closePopup();
});

layer.on('remove', clearTimers);

      }
    }).addTo(map);

    // VIIRS Hotspots (on by default, draws under NB Active Wild Fires)
    var viirsHotspots = L.esri.featureLayer({
      url: 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/ArcGIS/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0',
      pane: 'viirsPane',
      pointToLayer: function(_, latlng) {
        return L.circleMarker(latlng, {
          radius: 5,
          color: '#ffe066',
          fillColor: '#ffe066',
          fillOpacity: 0.7
        });
      }
    }).addTo(map);

    // Fire Perimeters with area labels (show when zoomed in)
    const PERIMETER_COLOR = 'red';
    var perimeterLabelLayers = new Set();

    var activefires = L.esri.featureLayer({
      url: 'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Active_Wildfire_Perimeters_in_Canada_View/FeatureServer/0',
      style: function(){ return { color: PERIMETER_COLOR, weight: 1, fillOpacity: 0.20 }; },
      onEachFeature: function (feature, layer) {
        const ha = feature?.properties?.AREA; // already hectares on this service
        const html = `<span class="perimeter-label" style="color:${PERIMETER_COLOR}">
          ${numberFmt(ha,1)} ha
        </span>`;
        layer.bindTooltip(html, {
          permanent: true,
          className: 'perimeter-label-tooltip',
          direction: 'center',
          opacity: 0 // managed by zoom
        });
        perimeterLabelLayers.add(layer);
      }
    }).addTo(map);

    function updatePerimeterLabelVisibility() {
      const show = map.getZoom() >= 11; // adjust to taste
      perimeterLabelLayers.forEach(l => {
        const tt = l.getTooltip && l.getTooltip();
        if (!tt) return;
        tt.setOpacity(show ? 1 : 0);
      });
    }
    activefires.on('load', updatePerimeterLabelVisibility);
    map.on('zoomend', updatePerimeterLabelVisibility);

    // NB Crown Lands (off by default)
    var nbCrownLands = L.esri.featureLayer({
      url: 'https://gis-erd-der.gnb.ca/server/rest/services/OpenData/Crown_Lands/FeatureServer/0',
      style: function(){ return { color: 'purple', weight: 1, fillOpacity: 0.2 }; }
    });

    function updateCrownLandsVisibility() {
      if (map.getZoom() < 10 && map.hasLayer(nbCrownLands)) map.removeLayer(nbCrownLands);
    }
    map.on('zoomend', updateCrownLandsVisibility);

    // NB Burn Bans (off by default)
    var nbBurnBans = L.esri.dynamicMapLayer({
      url: 'https://gis-erd-der.gnb.ca/gisserver/rest/services/FireWeather/BurnCategories/MapServer',
      opacity: 0.7
    });

    // Weather Stations (on by default)
    var weatherStations = L.esri.featureLayer({
      url: 'https://services.arcgis.com/zmLUiqh7X11gGV2d/ArcGIS/rest/services/EnvironmentCanada/FeatureServer/0',
      pointToLayer: function(feature, latlng) {
        var p = feature.properties || {};
        var windDir = p.WindDirection || 0;
        var windSpeed = p.WindSpeed_kmh;
        var temp = p.Temperature_C;
        var humidity = p.Humidity_Percent;

        var arrowIcon = L.divIcon({
          className: 'weather-arrow-icon',
          html: `
            <div style="display: flex; flex-direction: column; align-items: center;">
              <svg width="38" height="38" style="transform: rotate(${windDir}deg); display: block;">
                <polygon points="19,4 30,30 19,24 8,30" style="fill:#bbb;stroke:#111;stroke-width:2" />
              </svg>
              <div style="font-size:13px; font-weight:bold; color:#222; background:rgba(255,255,255,0.85); border-radius:4px; padding:2px 6px; margin-top:0; text-align:center; line-height:1.1;">
                ${windSpeed !== undefined ? `<span style="white-space:nowrap;">${windSpeed}<span style="font-size:10px;"> km/h</span></span>` : ''}
                <br>
                ${temp !== undefined ? temp + '<span style="font-size:10px;">°C</span>' : ''}
                <br>
                ${humidity !== undefined ? humidity + '<span style="font-size:10px;">%</span>' : ''}
              </div>
            </div>
          `,
          iconSize: [38, 54],
          iconAnchor: [19, 32]
        });
        return L.marker(latlng, { icon: arrowIcon });
      }
    }).addTo(map);

    // Major Cities & Towns (off by default)
    var nbCities = [
      { name: "Fredericton", lat: 45.9636, lng: -66.6431 },
      { name: "Saint John", lat: 45.2733, lng: -66.0633 },
      { name: "Moncton", lat: 46.0878, lng: -64.7782 },
      { name: "Bathurst", lat: 47.6186, lng: -65.6517 },
      { name: "Miramichi", lat: 47.0281, lng: -65.5019 },
      { name: "Edmundston", lat: 47.3730, lng: -68.3251 },
      { name: "Campbellton", lat: 48.0075, lng: -66.6731 },
      { name: "Dieppe", lat: 46.0842, lng: -64.6877 },
      { name: "Riverview", lat: 46.0617, lng: -64.8052 },
      { name: "Quispamsis", lat: 45.4319, lng: -65.9469 },
      { name: "Oromocto", lat: 45.8491, lng: -66.4828 },
      { name: "Woodstock", lat: 46.1527, lng: -67.6016 }
    ];

    var cityMarkers = L.layerGroup(nbCities.map(function(city) {
      var transparentIcon = L.divIcon({ html: '', iconSize: [0, 0] });
      return L.marker([city.lat, city.lng], {
        icon: transparentIcon,
        interactive: false,
        zIndexOffset: 1000
      }).bindTooltip(
        `<span class="city-label">${city.name}</span>`,
        { permanent: true, direction: 'top', offset: [0, 0], className: 'city-label-tooltip' }
      );
    }));

    // NB boundary outline (thick black)
    L.esri.featureLayer({
      url: 'https://maps-cartes.services.geo.ca/server2_serveur2/rest/services/BaseMaps/Provinces/MapServer/0',
      where: "POLITICALDIV = 4",
      pane: 'nbBoundaryPane',
      style: function(){ return { color: 'black', weight: 5, fill: false }; },
      interactive: false
    }).addTo(map);

    /* =========================
       OpenSky Flights (planes)
    ========================== */
    const OPEN_SKY_URL = "https://opensky-network.org/api/states/all";
    const PROXY_URL = ""; // set to your proxy if you hit CORS

    // Use the Set defined in callsigns.js (fallback to empty set if script missing)
    const WHITELIST_CALLSIGNS = window.WHITELIST_CALLSIGNS || new Set();

    map.createPane('planesPane');
    map.getPane('planesPane').style.zIndex = 1000;
    map.getPane('planesPane').style.pointerEvents = 'auto';

    const planesLayer = L.layerGroup([], { pane: 'planesPane' }).addTo(map);
    const planeMarkers = new Map();

    function makePlaneIcon(headingDeg, callsign, velocity) {
      const ICON_OFFSET = -45;
      const isWhitelisted = WHITELIST_CALLSIGNS.has(callsign);
      const emojiStyle = isWhitelisted ? 'filter: hue-rotate(-90deg) saturate(5);' : '';
      return L.divIcon({
        className: 'plane-div-icon',
        html: `
          <div style="transform: rotate(${ICON_OFFSET}deg); transform-origin:center; display:inline-block;">
            <div style="font-size:26px; ${emojiStyle} transform: rotate(${Number.isFinite(headingDeg) ? headingDeg : 0}deg); display:block;">
              ✈️
            </div>
          </div>
        `,
        iconSize: [30, 46],
        iconAnchor: [15, 23]
      });
    }

    function upsertPlaneMarker(icao24, lat, lon, heading, callsign, velocity) {
      let m = planeMarkers.get(icao24);
      if (!m) {
        m = L.marker([lat, lon], {
          icon: makePlaneIcon(heading, callsign, velocity),
          pane: 'planesPane',
          keyboard: false,
          zIndexOffset: 10000
        });

        let clickedOpen = false;

        const popupContent = `
          <b>${callsign || 'Unknown'}</b><br>
          Heading: ${Number.isFinite(heading) ? Math.round(heading) : '—'}°<br>
          Speed: ${velocity != null ? Math.round(velocity * 1.94384) : '—'} kt
        `;

        m.bindPopup(popupContent);

        // Hover to show popup
        m.on('mouseover', function () { if (!clickedOpen) this.openPopup(); });
        // Hover out to hide popup unless clicked open
        m.on('mouseout',  function () { if (!clickedOpen) this.closePopup(); });
        // Click toggles permanent open/close state
        m.on('click',     function () {
          clickedOpen = !clickedOpen;
          if (clickedOpen) this.openPopup(); else this.closePopup();
        });

        m.addTo(planesLayer);
        planeMarkers.set(icao24, m);
      } else {
        m.setLatLng([lat, lon]);
        m.setIcon(makePlaneIcon(heading, callsign, velocity));
      }
    }

    function pruneMissing(currentIcao24s) {
      for (const [icao24, marker] of planeMarkers.entries()) {
        if (!currentIcao24s.has(icao24)) {
          planesLayer.removeLayer(marker);
          planeMarkers.delete(icao24);
        }
      }
    }

    async function fetchOpenSkyStates() {
      try {
        const lamin  = nbBounds[0][0];
        const lomin  = nbBounds[0][1];
        const lamax  = nbBounds[1][0];
        const lomax  = nbBounds[1][1];

        const url = `${OPEN_SKY_URL}?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`;
        const resp = await fetch(PROXY_URL ? PROXY_URL + encodeURIComponent(url) : url);
        if (!resp.ok) throw new Error(`OpenSky error: ${resp.status} ${resp.statusText}`);

        const data = await resp.json();
        const states = Array.isArray(data.states) ? data.states : [];
        const seen = new Set();

        for (const s of states) {
          const icao24   = s[0];
          const callsign = (s[1] || '').trim().toUpperCase();
          const lon      = s[5];
          const lat      = s[6];
          const velocity = s[9];
          const heading  = s[10];
          if (!icao24 || lat == null || lon == null) continue;
          seen.add(icao24);
          upsertPlaneMarker(icao24, lat, lon, heading, callsign, velocity);
        }

        pruneMissing(seen);
      } catch (err) {
        console.warn('OpenSky fetch failed:', err);
      }
    }

    // Start polling
    fetchOpenSkyStates();
    const OPEN_SKY_INTERVAL_MS = 250000; // 250s
    let planesTimer = setInterval(fetchOpenSkyStates, OPEN_SKY_INTERVAL_MS);

    // Pause polling when layer is hidden (optional)
    function onPlanesAdded() {
      if (!planesTimer) planesTimer = setInterval(fetchOpenSkyStates, OPEN_SKY_INTERVAL_MS);
    }
    function onPlanesRemoved() {
      if (planesTimer) { clearInterval(planesTimer); planesTimer = null; }
    }
    planesLayer.on('add', onPlanesAdded);
    planesLayer.on('remove', onPlanesRemoved);

    // Major Cities group already defined above
    // NB boundary outline (thick black) already added above

    /* =========================
       Controls (Layers & Legend)
    ========================== */
    var overlays = {
      "NB Active Wild Fires": nbActiveWildFires,
      "Weather Stations": weatherStations,
      "VIIRS Hotspots": viirsHotspots,
      "Fire Perimeters": activefires,
      "Aerial Assets": planesLayer,
      "Major Cities & Towns": cityMarkers,
      "NB Crown Lands (zoom in to view)": nbCrownLands,
      "NB Burn Bans": nbBurnBans,
      "Sentinel-2C Imagery": sentinel2c
    };

    var layersControl = L.control.layers(null, overlays, { collapsed: false }).addTo(map);
    map._layersControl = layersControl;

    // Custom Legend
    var legend = L.control({ position: 'bottomright' });
    legend.onAdd = function() {
      var div = L.DomUtil.create('div', 'info legend');
      div.style.background = 'rgba(255,255,255,0.95)';
      div.style.padding = '10px 14px';
      div.style.borderRadius = '8px';
      div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
      div.innerHTML = `
        <b>Legend</b><br>
        <div style="margin-bottom:8px;">
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:red;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Out of Control Fire</span><br>
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:orange;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Contained Fire</span><br>
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:yellow;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Under Control Fire</span><br>
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:green;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Being Patrolled Fire</span>
        </div>
        <div style="margin-bottom:8px;">
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,4 20,20 12,16 4,20" style="fill:#bbb;stroke:#111;stroke-width:2" />
          </svg>
          <a href="https://esricanada.maps.arcgis.com/home/item.html?id=38406bada3104e258fc8b42a2a96581a" target="_blank" style="margin-left:6px; color:#0074d9; text-decoration:underline; font-weight:bold;">
            Weather Station Wind Direction
          </a><br>
          <span style="display:inline-block;width:24px;"></span>
          <span style="font-size:12px; font-weight:bold; white-space:nowrap;">
            12 <span style="font-size:10px;">km/h</span>, 20<span style="font-size:10px;">°C</span>, 60<span style="font-size:10px;">%</span>
          </span>
          <span style="margin-left:6px;">Wind Speed, Temp, Humidity</span>
        </div>
        <div>
          <svg width="18" height="18" style="vertical-align:middle;">
            <circle cx="9" cy="9" r="6" fill="#ffe066" stroke="#ffe066" stroke-width="2"/>
          </svg>
          <a href="https://www.arcgis.com/home/item.html?id=dece90af1a0242dcbf0ca36d30276aa3" target="_blank" style="margin-left:6px; color:#0074d9; text-decoration:underline; font-weight:bold;">
            VIIRS Hotspot
          </a>
        </div>
        <div>
          <a href="https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer" target="_blank" style="margin-left:6px; color:#0074d9; text-decoration:underline; font-weight:bold;">
            Sentinel-2C Imagery
          </a>
        </div>
        <div style="margin-top:12px; font-size:12px;">
          Fires and Crown Land info are from 
          <a href="https://www.snb.ca/geonb1/e/dc/catalogue-E.asp" target="_blank" style="color:#0074d9; text-decoration:underline; font-weight:bold;">
            GeoNB
          </a>
        </div>
      `;
      return div;
    };
    legend.addTo(map);

    /* =========================
       UI Toggles & Buttons
    ========================== */
    function setMapUIHidden(hidden) {
      var mapDiv = document.getElementById('map');
      if (hidden) {
        mapDiv.classList.add('map-ui-hidden');
        document.getElementById('mapToggleBtn').innerText = 'Show Legend & Layers';
      } else {
        mapDiv.classList.remove('map-ui-hidden');
        document.getElementById('mapToggleBtn').innerText = 'Hide Legend & Layers';
      }
    }

    // Initial state: hidden on mobile, shown on desktop
    setMapUIHidden(isMobile());

    document.getElementById('mapToggleBtn').addEventListener('click', function() {
      var mapDiv = document.getElementById('map');
      setMapUIHidden(!mapDiv.classList.contains('map-ui-hidden'));
    });

    document.getElementById('resetViewBtn').onclick = function() {
      map.setView(initialView.center, initialView.zoom);
      localStorage.removeItem(LS_KEY);
    };

  </script>

  <div style="position:fixed;bottom:10px;left:0;width:100%;text-align:center;z-index:2000;">
    <a href="https://www.gnb.ca/en/topic/laws-safety/emergency-preparedness-alerts/fire-watch.html"
       target="_blank"
       style="background:#fff;border-radius:6px;padding:8px 18px;box-shadow:0 1px 4px rgba(0,0,0,0.13);color:#0074d9;font-weight:bold;text-decoration:underline;font-family:'Segoe UI',Arial,sans-serif;">
      NB Fire Watch &amp; Burn Restrictions
    </a>
  </div>
</body>
</html>

