<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NB Fire Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />

  <!-- Fonts / Leaflet / Plugins -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

  <style>
    :root{
      color-scheme: light;
      --bg:#f7f8fc; --text:#0f172a; --muted:#5b6474;
      --panel:rgba(255,255,255,.85); --panel-strong:#fff; --border:#e6eaf1;
      --radius:14px; --radius-sm:10px;
      --shadow:0 10px 30px rgba(2,8,20,.08); --shadow-soft:0 6px 16px rgba(2,8,20,.06);
      --btn-bg:#fff; --btn-border:#d9dee6; --btn-hover:#f2f4f7;
      --link:#2563eb; --focus:0 0 0 3px rgba(37,99,235,.28);
      --oc:#ef4444; --cont:#fb923c; --uc:#facc15; --pat:#22c55e; --mon:#3b82f6;
      --modis:#f59e0b; --perimeter:#ef4444; --boundary:#0b0f19;
      --fs-12:12px; --fs-14:14px; --fs-16:16px; --fs-18:18px;

      /* desktop fallbacks */
      --fs-bottom: 86px;
      --smoke-bottom: 28px;
      --legend-bottom-reserve: 180px;

      /* JS-updated guards for title width */
      --left-guard: 12px;
      --right-guard: 12px;
    }

    html,body{height:100%;margin:0;overflow:hidden;overscroll-behavior:none}
    #map{height:100%}
    body{
      background:var(--bg);color:var(--text);
      font:var(--fs-14)/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;letter-spacing:.1px;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale
    }

    /* Leaflet controls (kept lower to leave room for title/buttons) */
    .leaflet-bar a,.leaflet-bar a:hover{background:var(--panel);border:1px solid var(--border);color:var(--text);box-shadow:var(--shadow-soft)}
    .leaflet-bar a{width:34px;height:34px;line-height:34px;font-size:16px}
    .leaflet-control-attribution{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow-soft);padding:4px 8px}
    .leaflet-top.leaflet-left{top:112px!important}
    .leaflet-top.leaflet-right{top:112px!important}

    /* Overview (legend) panel */
    .leaflet-control-layers{
      background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
      font-size:var(--fs-14);padding:8px 40px 8px 14px;backdrop-filter:blur(6px);min-width:260px;
      width:fit-content;max-width:calc(100vw - 24px);white-space:nowrap;overflow-x:auto
    }
    .leaflet-control-layers-expanded,.leaflet-control-layers-list{max-height:none;overflow:visible}
    .leaflet-control-layers-overlays label{display:grid;grid-template-columns:18px 26px auto;align-items:center;column-gap:8px;min-width:0;line-height:1.25}
    .leaflet-control-layers-overlays input{margin:0;width:max-content;height:18px}
    .leaflet-control-layers-overlays .text{min-width:max-content;white-space:nowrap;overflow:visible;text-overflow:clip}

    /* Mobile tweaks */
    @media (max-width: 640px){
      .leaflet-control-layers{
        width:fit-content;max-width:calc(100vw - 24px);min-width:0!important;white-space:nowrap;overflow-x:auto;
        max-height:calc(100dvh - var(--legend-bottom-reserve, 180px));overflow-y:auto;-webkit-overflow-scrolling:touch
      }
      .leaflet-control-layers-overlays label{grid-template-columns:18px 26px auto}
      .leaflet-control-layers-overlays .text{white-space:nowrap;min-width:max-content}
    }
    @media (max-width:767.98px){.leaflet-control-layers{font-size:var(--fs-12)}}

    /* Sticky top/bottom bars inside Overview */
    .leaflet-control-layers .overview-topbar{
      position:sticky;top:0;background:var(--panel);
      margin:-8px -40px 8px -14px;padding:8px 14px 10px;border-bottom:1px solid var(--border);z-index:1;backdrop-filter:blur(6px)
    }
    .leaflet-control-layers .overview-footbar{
      position:sticky;bottom:0;background:var(--panel);
      margin:8px -40px -8px -14px;padding:10px 14px 8px;border-top:1px solid var(--border);z-index:1;backdrop-filter:blur(6px)
    }

    /* Buttons */
    .map-btn{position:absolute;z-index:1001;background:var(--btn-bg);border:1px solid var(--btn-border);border-radius:999px;padding:10px 14px;
      font-size:var(--fs-14);font-weight:700;color:var(--text);cursor:pointer;box-shadow:var(--shadow);display:inline-flex;align-items:center;gap:8px;
      transition:background .2s,transform .06s,box-shadow .2s}
    .map-btn:hover{background:var(--btn-hover);box-shadow:0 8px 22px rgba(0,0,0,.08)}
    .map-btn:active{transform:translateY(1px)}
    .map-btn:focus-visible{outline:none;box-shadow:var(--focus)}
    .map-toggle-btn{top:64px;right:12px}
    .reset-view-btn{top:64px;left:12px;z-index:1002}
    .map-btn .icon{width:18px;height:18px;display:inline-grid;place-items:center}
    .map-ui-hidden .leaflet-control-layers{opacity:0;pointer-events:none}

    /* Title (single-line by default) */
    .map-title{
      position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:1003;pointer-events:none;cursor:default;
      background:var(--btn-bg);border:1px solid var(--btn-border);border-radius:999px;padding:10px 16px;font-weight:800;box-shadow:var(--shadow);
      white-space:nowrap;width:max-content;max-width:max-content;overflow:hidden;text-overflow:ellipsis;text-wrap: nowrap;
    }

    /* Summary button (relocated into legend on wide UI) */
    .fire-summary-btn{position:fixed;left:12px;z-index:2001;bottom:calc(var(--fs-bottom, 86px) + env(safe-area-inset-bottom))}
    .fire-summary-btn.in-legend{position:static!important;left:auto;bottom:auto;width:100%;margin:0;justify-content:center;box-shadow:var(--shadow-soft);border-radius:var(--radius-sm)}

    /* Help button (in legend) */
    .legend-help-btn{
      width:100%;background:var(--btn-bg);border:1px solid var(--btn-border);border-radius:var(--radius-sm);padding:10px 12px;font-weight:800;box-shadow:var(--shadow-soft);cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px
    }
    .legend-help-btn:hover{background:var(--btn-hover)}
    .legend-help-btn:focus-visible{outline:none;box-shadow:var(--focus)}

    /* Labels */
    .city-label-tooltip{cursor: pointer;background:none!important;border:none!important;box-shadow:none!important;padding:0!important}
    .perimeter-label-tooltip{background:none!important;border:none!important;box-shadow:none!important;padding:0!important}
    .city-label{font-size:15px;font-weight:800;color:#fff;text-shadow:0 0 2px rgba(0,0,0,.7),0 0 8px rgba(0,0,0,.6),1px 1px 0 rgba(0,0,0,.9)}
    .perimeter-label{font-size:12px;font-weight:800;pointer-events:none;padding:2px 6px;border-radius:6px;background:rgba(239,68,68,.12);backdrop-filter:blur(2px)}

    /* NEW: distance labels for dark backgrounds */
    .distance-label-tooltip{background:none!important;border:none!important;box-shadow:none!important;padding:0!important}
    .distance-label{
      font-size:12px;font-weight:900;color:#fff;pointer-events:none;padding:2px 8px;border-radius:6px;
      background:rgba(0,0,0,.55);box-shadow:0 0 0 1.5px rgba(255,255,255,.9) inset, 0 2px 10px rgba(0,0,0,.5);
      text-shadow:0 0 3px rgba(0,0,0,.9);
      backdrop-filter:blur(2px)
    }

    /* Summary modal */
    .fire-summary-overlay{position:fixed;inset:0;display:none;align-items:start;justify-content:center;z-index:3000;background:rgba(0,0,0,.25);backdrop-filter:blur(2px)}
    .fire-summary{margin-top:16px;background:var(--panel-strong);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);width:min(680px,calc(100% - 24px));color:var(--text);max-height:90vh;display:flex;flex-direction:column;overflow:hidden}
    .fire-summary header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 8px;flex:0 0 auto}
    .fire-summary h2{font-size:var(--fs-18);font-weight:800;margin:0}
    .fire-summary .body{padding:0 16px 16px;line-height:1.5;overflow:auto;flex:1 1 auto;min-height:0}
    .close-summary{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--text);border-radius:var(--radius-sm);padding:8px 12px;cursor:pointer;font-weight:700;box-shadow:var(--shadow-soft)}
    .close-summary:hover{background:var(--btn-hover)}
    .close-summary:focus-visible{outline:none;box-shadow:var(--focus)}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:0 8px 8px 0;font-weight:700;box-shadow:var(--shadow-soft)}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .summary-list{margin:8px 0 0;padding-left:12px;list-style:decimal;list-style-position:inside}
    .summary-list a{color:var(--link);text-decoration:none;font-weight:700}
    .summary-list a:hover{text-decoration:underline}
    .fs-scroll{margin-top:8px;border:1px solid var(--border);border-radius:12px;padding:8px;background:var(--panel)}
    .fs-meta-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:10px 0}
    .stat{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:var(--shadow-soft)}
    .stat .h{font:800 13px/1.2 Inter,system-ui,Arial;color:var(--muted);text-transform:uppercase;letter-spacing:.02em;margin-bottom:4px}
    .stat .v{font:800 18px/1.15 Inter,system-ui,Arial}
    @media (max-width: 520px){ .fs-meta-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }

    /* Legend icons */
    .marker-badge{width:38px;height:38px;border-radius:999px;display:grid;place-items:center;background:var(--panel-strong);border:2.5px solid var(--ring,#9aa0a6);box-shadow:0 2px 10px rgba(0,0,0,.18)}
    .marker-badge i{font-size:18px;color:var(--ring,#9aa0a6)}
    .legend-icon{width:18px;height:18px;display:inline-grid;place-items:center}
    .icons-pack{display:inline-flex;gap:6px;vertical-align:middle;justify-content:center;width:26px}
    .legend-badge{width:18px;height:18px;border-radius:999px;display:grid;place-items:center;background:#fff;border:2.5px solid var(--ring)}
    .legend-badge i{font-size:11px;color:var(--ring)}
    .legend-modis-dot{width:10px;height:10px;border-radius:999px;background:var(--modis);display:inline-block;box-shadow:0 0 0 1.5px #111827 inset}

    /* Footer */
    .nb-footer{position:fixed;left:0;width:100%;text-align:center;z-index:2000;bottom:calc(10px + env(safe-area-inset-bottom))}
    .nb-footer a{background:var(--btn-bg);border:1px solid var(--btn-border);border-radius:12px;padding:10px 18px;box-shadow:var(--shadow);color:var(--link);font-weight:800;text-decoration:none;display:inline-flex;align-items:center;gap:10px}

    /* Weather-station text */
    .ws-svg text{fill:#fff;stroke:rgba(0,0,0,.45);stroke-width:.9px;paint-order:stroke;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .ws-speed{font-weight:800;font-size:14px}
    .ws-small{font-weight:700;font-size:10px;opacity:.95}

    /* Smoke timeline UI */
    #smokeControls{
      position:absolute;left:12px;right:12px;z-index:2100;display:none;flex-direction:column;gap:6px;
      background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:8px 10px;box-shadow:var(--shadow);backdrop-filter:blur(6px);
      font-size:var(--fs-14);max-width:min(96vw,680px);bottom:calc(var(--smoke-bottom, 28px) + env(safe-area-inset-bottom))
    }
    .sc-top{display:flex;align-items:center;gap:10px}
    .sc-bottom{display:flex;align-items:center;gap:8px;font-size:var(--fs-12);opacity:.95}
    #smokePlay{background:var(--btn-bg);border:1px solid var(--btn-border);border-radius:8px;padding:4px 10px;cursor:pointer;font-weight:800;height:28px;display:inline-grid;place-items:center;line-height:1;min-width:38px;text-align:center}
    #smokePlay:focus-visible{outline:none;box-shadow:var(--focus)}
    #smokeTime{-webkit-appearance:none;appearance:none;flex:1 1 auto;min-width:140px;height:22px;background:transparent;outline:none;margin:0}
    #smokeTime:focus-visible{outline:none;box-shadow:var(--focus);border-radius:10px}
    #smokeTime::-webkit-slider-runnable-track{height:2px;border-radius:999px;background:var(--border)}
    #smokeTime::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:12px;height:12px;border-radius:50%;background:var(--text);border:2px solid #fff;margin-top:-5px;box-shadow:0 1px 2px rgba(0,0,0,.18)}
    #smokeTime::-moz-range-track{height:2px;border-radius:999px;background:var(--border)}
    #smokeTime::-moz-range-thumb{width:12px;height:12px;border-radius:50%;background:var(--text);border:2px solid #fff;box-shadow:0 1px 2px rgba(0,0,0,.18)}
    #smokeTime::-moz-range-progress{height:2px;background:color-mix(in srgb, var(--text) 35%, transparent);border-radius:999px}
    #smokeLabel{font-weight:800}.dot-sep{opacity:.6}#smokeTimestamp{font-weight:700;white-space:nowrap}
    @media (min-width:700px){#smokeControls{left:auto;right:12px}}
    @media (max-width:560px){
      #smokeControls{padding:6px 8px}.sc-top{gap:8px}#smokePlay{padding:4px 8px;min-width:34px;height:26px}
      .sc-bottom{font-size:var(--fs-12);gap:6px}#smokeTimestamp{white-space:nowrap}
    }

    /* Safe-area probe */
    #sai-probe{position:fixed;left:0;bottom:0;width:0;height:env(safe-area-inset-bottom);pointer-events:none;opacity:0}

    /* Summary table + pie */
    .pro-table{width:100%;border-collapse:separate;border-spacing:0;margin:10px 0 4px;background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow-soft)}
    .pro-table th,.pro-table td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border)}
    .pro-table th{font:800 12px/1.2 Inter,system-ui,Arial;color:var(--muted);text-transform:uppercase;letter-spacing:.03em;background:color-mix(in srgb, var(--panel) 80%, #fff 20%)}
    .pro-table tr:last-child td{border-bottom:none}
    .pro-kpi{font:800 16px/1.2 Inter,system-ui,Arial}
    .pro-table.compact{margin:6px 0 2px}
    .pro-table.compact th,.pro-table.compact td{padding:6px 8px}
    .pro-table.compact th{font-size:11px;letter-spacing:.02em}
    .pro-table.compact .pro-kpi{font-size:15px}
    .pie-wrap{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center;margin:10px 0 6px}
    .pie{width:110px;height:110px;border-radius:50%;border:1px solid var(--border);box-shadow:var(--shadow-soft);background:#fff}
    .pie-legend{display:grid;gap:6px}
    .legend-item{display:flex;align-items:center;gap:10px;font-weight:700}
    .legend-item[role="button"]{cursor:pointer}
    .legend-item[role="button"]:focus-visible{outline:none;box-shadow:var(--focus);border-radius:8px}
    .legend-swatch{width:12px;height:12px;border-radius:3px;border:1px solid rgba(0,0,0,.1);box-shadow:inset 0 0 0 1px rgba(255,255,255,.4)}
    .legend-count{opacity:.85;font-weight:800;margin-left:auto}
    .muted-note{margin-top:8px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div id="map" aria-label="Interactive wildfire map"></div>

  <!-- Smoke timeline controls -->
  <div id="smokeControls" aria-live="polite">
    <div class="sc-top">
      <button id="smokePlay" type="button" title="Play/Pause" aria-label="Play animation">▶</button>
      <input id="smokeTime" type="range" min="0" max="0" value="0" step="1" aria-label="Smoke time slider" />
    </div>
    <div class="sc-bottom">
      <span id="smokeLabel">Wildfire Smoke</span><span class="dot-sep">•</span><span id="smokeTimestamp">Loading…</span>
    </div>
  </div>

  <!-- Title -->
  <div id="mapTitle" class="map-title" aria-hidden="true"><i class="fa-solid fa-fire"></i> NB Fire Map</div>

  <!-- Overview toggle / reset / summary -->
  <button id="mapToggleBtn" class="map-btn map-toggle-btn" type="button" aria-pressed="false" title="Show Overview">
    <span class="icon"><i class="fa-solid fa-layer-group"></i></span><span id="mtb-text">Show Overview</span>
  </button>
  <button id="resetViewBtn" class="map-btn reset-view-btn" type="button" title="Reset map view">
    <span class="icon"><i class="fa-solid fa-compass"></i></span><span>Reset Map View</span>
  </button>
  <button id="fireSummaryBtn" class="map-btn fire-summary-btn" type="button" title="Open summary">
    <span class="icon"><i class="fa-solid fa-fire"></i></span><span>Fire Summary</span>
  </button>

  <!-- Fire Summary Modal -->
  <div id="fireSummaryOverlay" class="fire-summary-overlay" role="presentation" hidden>
    <div class="fire-summary" role="dialog" aria-modal="true" aria-labelledby="fs-title">
      <header>
        <h2 id="fs-title">New Brunswick Fire Summary</h2>
        <button id="fs-close" class="close-summary" type="button"><span class="icon"><i class="fa-solid fa-xmark"></i></span> Close</button>
      </header>
      <div id="fs-body" class="body"></div>
    </div>
  </div>

  <!-- Map Help Modal -->
  <div id="mapHelpOverlay" class="fire-summary-overlay" role="presentation" hidden>
    <div class="fire-summary" role="dialog" aria-modal="true" aria-labelledby="mh-title">
      <header>
        <h2 id="mh-title">Map Layers &amp; How to Use</h2>
        <button id="mh-close" class="close-summary" type="button"><span class="icon"><i class="fa-solid fa-xmark"></i></span> Close</button>
      </header>
      <div id="mh-body" class="body"></div>
    </div>
  </div>

  <div class="nb-footer">
    <a href="https://www.gnb.ca/en/topic/laws-safety/emergency-preparedness-alerts/fire-watch.html" target="_blank" rel="noopener">
      <i class="fa-solid fa-up-right-from-square"></i> NB Fire Watch &amp; Burn Restrictions
    </a>
  </div>

  <!-- Safe-area probe -->
  <div id="sai-probe" aria-hidden="true"></div>

  <!-- JS (deferred) -->
  <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script defer src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
  <script defer src="https://unpkg.com/esri-leaflet-image/dist/esri-leaflet-image.js"></script>
  <script defer src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
  <script defer src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script defer src="https://unpkg.com/esri-leaflet-cluster/dist/esri-leaflet-cluster.js"></script>

  <script>
    /* =========================================================================
       NB Fire Map — cleaned and organized. All symbols/clustering preserved.
       ========================================================================= */

    // --- Compass utils (used in station UI) ---------------------------------
    const COMPASS_16 = ['N','NNE','NE','ENE','E','ESE','SE','S','SSW','SW','WSW','W','WNW','NW','NNW','N'];
    function degToCompass(deg){
      if (!Number.isFinite(deg)) return '—';
      const d = ((deg % 360) + 360) % 360;
      return COMPASS_16[Math.round(d / 22.5)];
    }

    window.addEventListener('DOMContentLoaded', () => {
      'use strict';

      // --- DOM helpers & core constants -------------------------------------
      const D = document;
      const $  = (sel, root=D) => root.querySelector(sel);
      const $$ = (sel, root=D) => root.querySelectorAll(sel);

      const LS_KEY = 'nbMapView';
      const NB_BOUNDS = [[44.0, -69.5], [48.5, -62.0]];
      const INITIAL_VIEW = { center: [46.7, -66.2], zoom: 7 };
      const ATLANTIC_TZ = 'America/Moncton';

      // External data sources / intervals
      const OPEN_SKY_URL = 'https://opensky-network.org/api/states/all';
      const PLANE_REFRESH_MS = 250_000;
      const LIGHTNING_REFRESH_MS = 120_000;

      const NOAA_SMOKE_URL = 'https://mapservices.weather.noaa.gov/raster/rest/services/air_quality/ndgd_smoke_sfc_1hr_avg_time/ImageServer';
      const SMOKE_HOURS_EACH_SIDE = 24;
      const SMOKE_FRAME_MS = 1200;

      // --- CSS var reader & color map ---------------------------------------
      const cssVar = (name) => getComputedStyle(D.documentElement).getPropertyValue(name).trim();
      const COLORS = {
        oc:  cssVar('--oc'),
        cont: cssVar('--cont'),
        uc:  cssVar('--uc'),
        pat: cssVar('--pat'),
        mon: cssVar('--mon'),
        perimeter: cssVar('--perimeter'),
        boundary: cssVar('--boundary'),
        modis: cssVar('--modis'),
      };

      // --- Fire status helpers ----------------------------------------------
      const STATUS = new Map([
        ['out of control', { color: COLORS.oc,  sev: 3 }],
        ['contained',      { color: COLORS.cont, sev: 2 }],
        ['under control',  { color: COLORS.uc,   sev: 1 }],
        ['being patrolled',{ color: COLORS.pat,  sev: 0 }],
        ['being monitored',{ color: COLORS.mon,  sev: 2.5 }],
        ['extinguished',   { color: '#9aa0a6',   sev: -1 }],
      ]);
      const norm = (s) => (s || '').toString().trim().toLowerCase();
      const statusColor = (s) => STATUS.get(norm(s))?.color ?? '#9aa0a6';
      const severityRank = (s) => STATUS.get(norm(s))?.sev ?? -1;

      // --- Formatting & date helpers ----------------------------------------
      const isMobile = () => innerWidth < 768;
      const toNum = (v, d=1) => (v==null || Number.isNaN(Number(v))) ? '—'
        : Number(v).toLocaleString(undefined, { maximumFractionDigits: d });
      const fmtDateTime = (ms) => ms == null ? '—'
        : new Date(+ms).toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      const fmtDateTZ = (ms, tz=ATLANTIC_TZ) => ms == null ? '—'
        : new Date(+ms).toLocaleDateString(undefined, { year:'numeric', month:'2-digit', day:'2-digit', timeZone: tz });

      const ymdInTz = (ms, tz=ATLANTIC_TZ) => {
        const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' });
        const parts = fmt.formatToParts(new Date(ms));
        const val = (k) => +parts.find(p => p.type===k)?.value;
        return { y: val('year'), m: val('month'), d: val('day') };
      };
      const sameYMD = (a,b,tz) => { if (a==null || b==null) return false; const A=ymdInTz(a,tz), B=ymdInTz(b,tz); return A.y===B.y && A.m===B.m && A.d===B.d; };
      const yesterdayUTCms = (tz=ATLANTIC_TZ) => { const t = ymdInTz(Date.now(), tz); return Date.UTC(t.y, t.m-1, t.d) - 86_400_000; };
      const isToday = (ms) => sameYMD(ms, Date.now(), ATLANTIC_TZ);
      const isYesterday = (ms) => sameYMD(ms, yesterdayUTCms(ATLANTIC_TZ), ATLANTIC_TZ);

      const getExtinguishedMs = (p) => {
        for (const k of ['FIRE_OUT_DATE','OUT_DATE','DATE_OUT','DATE_EXTINGUISHED','OUT_TIME','EXTINGUISHED','FIRE_STAT_DATE']) {
          const v=p?.[k]; if(v==null) continue; const n=+v; if(Number.isFinite(n)) return n; const t=Date.parse(v); if(!Number.isNaN(t)) return t;
        } return null;
      };
      const getDetectedMs = (p) => {
        for (const k of ['TIME_DETECTED','DATE_DETECTED','DETECTED','FIRE_START_DATE','START_DATE']) {
          const v=p?.[k]; if(v==null) continue; const n=+v; if(Number.isFinite(n)) return n; const t=Date.parse(v); if(!Number.isNaN(t)) return t;
        } return null;
      };

      // Containment % & retrieval info (robust parsing)
      const firstProp = (p, keys) => { for (const k of keys) { const v = p?.[k]; if (v !== undefined && v !== null && v !== '') return [k, v]; } return [null, null]; };
      const clamp01 = (n) => Math.max(0, Math.min(100, n));
      const parseMaybeNumber = (v) => { if (v == null) return null; const n = Number(v); if (Number.isFinite(n)) return n; const m = String(v).match(/-?\d+(\.\d+)?/); return m ? Number(m[0]) : null; };
      const parseDateFlexible = (v) => {
        if (v == null || v === '') return null;
        const s = String(v).trim(); const ymd = s.match(/^(\d{4})(\d{2})(\d{2})$/);
        if (ymd) { const y=+ymd[1], m=+ymd[2], d=+ymd[3]; if(m>=1 && m<=12 && d>=1 && d<=31) return Date.UTC(y, m-1, d); }
        const parsed = Date.parse(s); if (!Number.isNaN(parsed)) return parsed;
        const n = Number(s); if (!Number.isFinite(n) || n <= 0) return null; return n < 1e12 ? n * 1000 : n;
      };
      const getContainPct = (p) => {
        const [, v] = firstProp(p, ['PCT_CONTAINED','PERCENT_CONTAINED','CONTAINMENT_PCT','CONTAINED_PCT','PCTCONTAINED','CONTAINMENT','CONTAINMENT_PERCENT']);
        if (v == null) return null; const num = parseMaybeNumber(v); return num == null ? null : clamp01(num);
      };
      const getRetrievedInfo = (p) => {
        const [, v] = firstProp(p, ['FETCHED_FROM_ERD','FETCHED_FROM_GNB','GNB_FETCHED','GNB_RETRIEVED_AT','RETRIEVED_FROM_GNB','FETCHED_AT','FETCH_TIMESTAMP','SOURCE_FETCHED_AT','ERD_FETCHED_AT']);
        if (v == null) return { ms:null, bool:null, raw:null };
        const ms = parseDateFlexible(v); if (ms != null) return { ms, bool:null, raw:v };
        const sv = String(v).trim().toLowerCase();
        if (typeof v === 'boolean' || ['true','yes','y','1'].includes(sv)) return { ms:null, bool:true, raw:v };
        if (['false','no','n','0'].includes(sv)) return { ms:null, bool:false, raw:v };
        return { ms:null, bool:null, raw:v };
      };

      // --- Title layout (guards to avoid overlap with buttons) ---------------
      const titleEl = $('#mapTitle');
      function layoutTitleBox(){
        const leftBtn  = $('#resetViewBtn');
        const rightBtn = $('#mapToggleBtn');
        const leftW  = leftBtn  ? Math.ceil(leftBtn.getBoundingClientRect().width)  : 0;
        const rightW = rightBtn ? Math.ceil(rightBtn.getBoundingClientRect().width) : 0;
        const GUTTER = 12;
        const LEFT_GUARD  = 12 + leftW  + GUTTER;
        const RIGHT_GUARD = 12 + rightW + GUTTER;
        const root = D.documentElement;
        root.style.setProperty('--left-guard',  LEFT_GUARD  + 'px');
        root.style.setProperty('--right-guard', RIGHT_GUARD + 'px');
        if (!titleEl) return;
        requestAnimationFrame(() => {
          const tooTight = titleEl.scrollWidth > titleEl.clientWidth;
          titleEl.classList.toggle('wrap', tooTight);
        });
      }

      // --- Map init ----------------------------------------------------------
      const saved = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
      const map = L.map('map', { center: saved?.center || INITIAL_VIEW.center, zoom: saved?.zoom || INITIAL_VIEW.zoom });
      map.on('moveend', () => {
        const c = map.getCenter();
        localStorage.setItem(LS_KEY, JSON.stringify({ center: [c.lat, c.lng], zoom: map.getZoom() }));
      });

      // Custom panes for z-order
      [
        ['alwaysOnTopPopup',9999],
        ['sentinelPane',400],
        ['nbBoundaryPane',405],
        ['smokePane',410],
        ['perimetersPane',412],
        ['radarPane',413],
        ['lightningPane',413],
        ['viirsPane',414],
        ['weatherPane',640],
        ['aqiPane',416],
        ['firesPane',650],
        ['planesPane',1000,true]
      ].forEach(([name, z, pe]) => { const p = map.createPane(name); p.style.zIndex = z; if (pe) p.style.pointerEvents = 'auto'; });

      L.esri.basemapLayer('Imagery').addTo(map);

      if (isMobile()) {
        L.control.locate({
          position: 'topleft', flyTo: true, showPopup: false, keepCurrentZoomLevel: true,
          icon: 'fa fa-location-crosshairs', strings: { title: 'Show me where I am' }
        }).addTo(map);
      }

      const fitProvinceToView = ({ animate=false } = {}) => {
        const padX = Math.round(innerWidth  * 0.04);
        const padY = Math.round(innerHeight * 0.04);
        map.fitBounds(NB_BOUNDS, { paddingTopLeft:[padX,padY], paddingBottomRight:[padX,padY], animate });
      };

      // --- Local fires (GeoJSON) + marker clustering ------------------------
      const fireStore = new Map();
      let fireClusters = null;
      function ensureFireClusters(){
        if (fireClusters) return;
        fireClusters = L.markerClusterGroup({
          disableClusteringAtZoom: 11,
          spiderfyOnMaxZoom: true,
          zoomToBoundsOnClick: true,
          showCoverageOnHover: false,
          iconCreateFunction:(cluster)=>{
            const markers = cluster.getAllChildMarkers();
            let worstSev = -2, worstKey = 'extinguished';
            for(const m of markers){
              const k = m.options._statusKey || 'extinguished';
              const sev = Number.isFinite(m.options._severity) ? m.options._severity : severityRank(k);
              if(sev > worstSev){ worstSev = sev; worstKey = k; }
            }
            const ring = statusColor(worstKey);
            const count = cluster.getChildCount();
            return L.divIcon({
              className:'fire-cluster-icon',
              html: `
                <div style="position:relative;display:inline-grid;place-items:center">
                  <div class="marker-badge" style="--ring:${ring};width:42px;height:42px">
                    <i class="fa-solid fa-fire"></i>
                  </div>
                  <div style="position:absolute;bottom:-6px;right:-6px;background:var(--panel-strong);border:2px solid ${ring};border-radius:999px;
                              font:800 12px/1.1 Inter,system-ui,Arial;padding:4px 7px;box-shadow:0 2px 8px rgba(0,0,0,.18)">${count}</div>
                </div>`,
              iconSize:[42,42], iconAnchor:[21,28], popupAnchor:[0,-24]
            });
          },
          pane: 'firesPane',
          clusterPane: 'firesPane'
        }).addTo(map);
      }

      const activeMarkersAll = [];
      const outMarkersAll = [];

      function bindHoverTogglePopup(layer){
        let clicked=false, openT=null, closeT=null;
        const OPEN_MS=150, CLOSE_MS=60;
        const clear=()=>{ if(openT){clearTimeout(openT);openT=null} if(closeT){clearTimeout(closeT);closeT=null} };
        layer.on('mouseover',function(){ if(clicked) return; if(closeT) clearTimeout(closeT);
          if(!openT){ openT=setTimeout(()=>{ openT=null; this.openPopup?.(); },OPEN_MS); }});
        layer.on('mouseout',function(){ if(clicked) return; if(openT) clearTimeout(openT);
          if(!closeT){ closeT=setTimeout(()=>{ closeT=null; this.closePopup?.(); },CLOSE_MS); }});
        layer.on('click',function(){ clicked=!clicked; clear(); clicked?this.openPopup?.():this.closePopup?.(); });
        layer.on('remove', clear);
      }

      function bindFirePopup(props, layer, explicitStatus) {
        const status = explicitStatus || props.FIRE_STAT_DESC_E || '—';
        const pct = getContainPct(props);
        const pctStr = pct != null ? `${toNum(pct,0)}%` : '—';
        const retrieved = getRetrievedInfo(props);
        const retrievedStr = (retrieved.ms != null)
          ? fmtDateTime(retrieved.ms)
          : (retrieved.bool != null ? (retrieved.bool ? 'Yes' : 'No') : (retrieved.raw ?? '—'));

        const html = `
          <div style="font:14px/1.45 Inter,system-ui,Segoe UI,Arial;min-width:240px;color:var(--text)">
            <div style="font-weight:800;font-size:16px;margin-bottom:6px;letter-spacing:.2px">${props.FIRE_NAME || props.FIRE_ID || 'Unnamed Fire'}</div>
            <div style="margin:6px 0 10px">
              <span style="display:inline-flex;align-items:center;gap:8px;padding:5px 10px;border-radius:999px;background:var(--panel);border:1px solid var(--border);font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,.12)">
                <span class="dot" style="background:${statusColor(status)}"></span>${status}
              </span>
            </div>
            <div><b>Area:</b> ${toNum(props.FIRE_SIZE ?? props.SIZE_HA ?? props.AREA,1)} ha</div>
            <div><b>Contained:</b> ${pctStr}</div>
            <div><b>Detected:</b> ${fmtDateTime(getDetectedMs(props))}</div>
            ${norm(status)==='extinguished'
              ? `<div><b>Extinguished:</b> ${fmtDateTime(getExtinguishedMs(props))}</div>`
              : `<div><b>Status updated:</b> ${fmtDateTime(props.FIRE_STAT_DATE)}</div>`}
            <div><b>Retrieved from GNB:</b> ${retrievedStr}</div>
          </div>`;
        layer.bindPopup(html,{maxWidth:340,pane:'alwaysOnTopPopup'});

        const rawId = props.GlobalID || props.OBJECTID || props.FIRE_ID || Math.random().toString(36).slice(2)+Date.now().toString(36);
        const id = String(rawId);
        fireStore.set(id,{ id, props, latlng: layer.getLatLng(), layer, statusKey: layer.options._statusKey });
        bindHoverTogglePopup(layer);
      }

      function makeFireMarker(props, coords, explicitStatus){
        const [lng, lat] = coords; // GeoJSON order
        const statusKey = norm(explicitStatus || props.FIRE_STAT_DESC_E || '—');
        const marker = L.marker([lat, lng], {
          pane: 'firesPane',
          icon: L.divIcon({
            className:'fire-badge-icon',
            html:`<div class="marker-badge" style="--ring:${statusColor(statusKey)}"><i class="fa-solid fa-fire"></i></div>`,
            iconSize:[38,38],iconAnchor:[19,26],popupAnchor:[0,-22]
          }),
          keyboard:false
        });
        marker.options._statusKey = statusKey;
        marker.options._severity  = severityRank(statusKey);
        bindFirePopup(props, marker, explicitStatus);
        return marker;
      }

      async function fetchLocalAny(base){
        const attempts = [
          `${base}.json`, `${base}.geojson`, `./${base}.json`, `./${base}.geojson`,
          `data/${base}.json`, `data/${base}.geojson`, `./data/${base}.json`, `./data/${base}.geojson`,
        ];
        for (const url of attempts) {
          try { const r = await fetch(url, { cache:'no-store' }); if (r.ok) return await r.json(); } catch {}
        }
      }

      function applyFireFilter(){
        ensureFireClusters();
        const cbs = $$('.fire-filter-block input[type="checkbox"]');
        const enabled = new Set(); cbs.forEach(cb => { if (cb.checked) enabled.add(norm(cb.getAttribute('data-status'))); });
        fireClusters.clearLayers();
        for (const m of activeMarkersAll) if (enabled.has(m.options._statusKey)) fireClusters.addLayer(m);
        if (enabled.has('extinguished')) for (const m of outMarkersAll) fireClusters.addLayer(m);
      }

      async function loadLocalFires(){
        try {
          const [activeData, outData] = await Promise.all([
            fetchLocalAny('active_fires'),
            fetchLocalAny('out_fires')
          ]);

          (activeData?.features||[]).forEach((f)=>{
            if (!f || f.geometry?.type !== 'Point') return;
            const m = makeFireMarker(f.properties||{}, f.geometry.coordinates, f.properties?.FIRE_STAT_DESC_E);
            activeMarkersAll.push(m);
          });

          (outData?.features||[]).forEach((f)=>{
            if (!f || f.geometry?.type !== 'Point') return;
            const m = makeFireMarker(f.properties||{}, f.geometry.coordinates, 'Extinguished');
            outMarkersAll.push(m);
          });

          applyFireFilter();
          refreshSummary();
        } catch (e) { console.error('Loading local fires failed:', e); }
      }

      map.whenReady(() => { fitProvinceToView({ animate:false }); loadLocalFires(); });

      // --- MODIS, perimeters, boundary --------------------------------------
      const modis48 = L.esri.featureLayer({
        url:'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/MODIS_Thermal_v1/FeatureServer/0',
        pane:'viirsPane',
        pointToLayer:(_f,latlng)=>L.circleMarker(latlng,{radius:5,color:'var(--modis)',fillColor:'var(--modis)',fillOpacity:.9})
      }).addTo(map); // on

      const modis7d = L.esri.featureLayer({
        url:'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/MODIS_Thermal_v1/FeatureServer/1',
        pane:'viirsPane',
        pointToLayer:(_f,latlng)=>L.circleMarker(latlng,{radius:4,color:'var(--modis)',fillColor:'var(--modis)',fillOpacity:.65})
      }); // off

      const perimeterLabelLayers = new Set();
      const activefires = L.esri.featureLayer({
        url:'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Active_Wildfire_Perimeters_in_Canada_View/FeatureServer/0',
        pane:'perimetersPane',
        style:()=>({color:COLORS.perimeter,weight:1.2,fillOpacity:.18}),
        onEachFeature:(feature,layer)=>{
          const ha = feature?.properties?.AREA;
          layer.bindTooltip(`<span class="perimeter-label" style="color:${COLORS.perimeter}">${toNum(ha,1)} ha</span>`,
            {permanent:true,className:'perimeter-label-tooltip',direction:'center',opacity:0});
          perimeterLabelLayers.add(layer);
        }
      }).addTo(map);

      const setPerimeterLabels = ()=> {
        const show = map.getZoom() >= 11;
        perimeterLabelLayers.forEach((l)=>l.getTooltip()?.setOpacity(show?1:0));
      };
      activefires.on('load', setPerimeterLabels);
      map.on('zoomend', setPerimeterLabels);

      const nbBoundary = L.esri.featureLayer({
        url:'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Provinces_and_Territories_of_Canada/FeatureServer/0',
        where:"Name_EN = 'New Brunswick'",
        pane:'nbBoundaryPane',
        style:()=>({color: COLORS.boundary, weight:5, fill:false}),
        interactive:false
      }).addTo(map);

      // --- Sentinel imagery & burn bans -------------------------------------
      const sentinel2 = L.esri.imageMapLayer({ url:'https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer', opacity:0.75, pane:'sentinelPane' });
      sentinel2.on('load', ()=> sentinel2.bringToFront());
      const nbBurnBans = L.esri.dynamicMapLayer({
        url:'https://gis-erd-der.gnb.ca/gisserver/rest/services/FireWeather/BurnCategories/MapServer',
        opacity:.7, pane:'perimetersPane'
      }); // off

      // --- Weather (clustered), radar, lightning, AQHI ----------------------
      function stationPopupHTML(p) {
        const fromDeg = Number(p.WindDirection);
        const kmh = Number(p.WindSpeed_kmh);
        const temp = p.Temperature_C !== '' && p.Temperature_C != null ? Math.round(Number(p.Temperature_C)) : null;
        const hum  = p.Humidity_Percent !== '' && p.Humidity_Percent != null ? Math.round(Number(p.Humidity_Percent)) : null;
        const name = p.StationName || p.location_name_en || 'Weather station';
        const when = p.observation_datetime_text_en || '';
        return `
          <div style="min-width:240px">
            <div style="font-weight:800;margin-bottom:4px">${name}</div>
            <div><b>Wind:</b> ${Number.isFinite(kmh) ? kmh : '—'} km/h • From ${degToCompass(fromDeg)}${Number.isFinite(fromDeg) ? ' ('+Math.round(fromDeg)+'°)' : ''}</div>
            <div><b>Temp:</b> ${temp != null ? temp + '°C' : '—'}${hum != null ? ' • ' + hum + '%' : ''}</div>
            ${when ? `<div style="opacity:.8">${when}</div>` : ''}
          </div>`;
      }
      function stationSVG(p, size=84){
        const fromDeg = Number(p.WindDirection);
        const toDeg = Number.isFinite(fromDeg) ? (fromDeg + 180) % 360 : 0;
        const kmh = Number(p.WindSpeed_kmh);
        const temp = p.Temperature_C !== '' && p.Temperature_C != null ? Math.round(Number(p.Temperature_C)) : null;
        const hum  = p.Humidity_Percent !== '' && p.Humidity_Percent != null ? Math.round(Number(p.Humidity_Percent)) : null;
        const arrowPathD = "M42 14 Q52 30 58 58 Q42 48 42 48 Q42 48 26 58 Q32 30 42 14 Z";
        const scale = size/84;
        return `
          <svg class="ws-svg" width="${84*scale}" height="${92*scale}" viewBox="0 0 84 92" aria-hidden="true" role="img"
               style="position:relative; z-index:1; filter:drop-shadow(0 2px 2px rgba(0,0,0,.25))">
            <circle cx="42" cy="42" r="34" fill="#0b0f19" stroke="#ffffff" stroke-width="2.5"/>
            <g transform="rotate(${toDeg} 42 42)">
              <path d="${arrowPathD}" fill="#999999" stroke="#999999" stroke-width="1.8" stroke-linejoin="round"></path>
              <g transform="rotate(${-toDeg} 42 42)">
                <text x="42" y="26" text-anchor="middle" class="ws-small">From ${degToCompass(fromDeg)}</text>
                <text x="42" y="42" text-anchor="middle" class="ws-speed">${Number.isFinite(kmh) ? kmh : '—'} km/h</text>
                <text x="42" y="58" text-anchor="middle" class="ws-small">
                  ${temp != null ? temp + '°C' : '—'}${hum != null ? ' • ' + hum + '%' : ''}
                </text>
              </g>
            </g>
          </svg>`;
      }
      function makeStationMarker(feature, latlng) {
        const p = feature.properties || {};
        const icon = L.divIcon({ className: 'ws-div', html: stationSVG(p, 84), iconSize: [84, 92], iconAnchor: [42, 54], popupAnchor: [0, -44] });
        const m = L.marker(latlng, { icon, pane: 'weatherPane' });
        m.options._stationProps = p;
        const fromDeg = Number(p.WindDirection);
        const kmh = Number(p.WindSpeed_kmh);
        const temp = p.Temperature_C !== '' && p.Temperature_C != null ? Math.round(Number(p.Temperature_C)) : null;
        const hum  = p.Humidity_Percent !== '' && p.Humidity_Percent != null ? Math.round(Number(p.Humidity_Percent)) : null;
        m.bindTooltip(
          `Wind: ${Number.isFinite(kmh) ? kmh : '—'} km/h • From ${degToCompass(fromDeg)}${temp != null ? ' • ' + temp + '°C' : ''}${hum != null ? ' • ' + hum + '%' : ''}`,
          { direction: 'top', offset: [0, -36], opacity: 0 }
        );
        m.bindPopup(stationPopupHTML(p), { pane: 'alwaysOnTopPopup' });
        return m;
      }
      const weatherStations = L.esri.Cluster.featureLayer({
        url: 'https://services.arcgis.com/zmLUiqh7X11gGV2d/ArcGIS/rest/services/EnvironmentCanada/FeatureServer/0',
        pane: 'weatherPane',
        clusterPane: 'weatherPane',
        spiderfyOnMaxZoom: true,
        disableClusteringAtZoom: 10,
        zoomToBoundsOnClick: false,
        showCoverageOnHover: false,
        pointToLayer: makeStationMarker,
        iconCreateFunction: (cluster) => {
          const center = cluster.getLatLng();
          const markers = cluster.getAllChildMarkers();
          let best = null, bestDist = Infinity;
          for (const m of markers) {
            const d = map.distance(center, m.getLatLng());
            if (d < bestDist) { bestDist = d; best = m; }
          }
          const p = best?.options?._stationProps || {};
          return L.divIcon({
            className: 'ws-cluster-icon',
            html: `
              <div style="position:relative;display:inline-grid;place-items:center">
                ${stationSVG(p, 84)}
                <div style="position:absolute;bottom:8px;right:8px;z-index:2;background:var(--panel-strong);border:2px solid #111827;border-radius:999px;
                            font:800 12px/1.1 Inter,system-ui,Arial;padding:4px 7px;box-shadow:0 2px 8px rgba(0,0,0,.18);pointer-events:none">
                  ${cluster.getChildCount()}
                </div>
              </div>`,
            iconSize: [84, 92], iconAnchor: [42, 54], popupAnchor: [0, -44] });
        }
      }); // off

      const noaaRadar = L.esri.imageMapLayer({
        url:'https://mapservices.weather.noaa.gov/eventdriven/rest/services/radar/radar_base_reflectivity_time/ImageServer',
        opacity:.8, pane:'radarPane'
      }); // off

      const lightningLayer = L.tileLayer.wms('https://geo.weather.gc.ca/geomet',{
        layers:'Lightning_2.5km_Density',version:'1.3.0',format:'image/png',transparent:true,opacity:1,pane:'lightningPane'
      }); // off

      let lightningTimer=null;
      const startLightningRefresh=()=>{ if(!lightningTimer){ lightningTimer=setInterval(()=>{ lightningLayer.setParams({_ :Date.now()}); }, LIGHTNING_REFRESH_MS); } };
      const stopLightningRefresh = ()=>{ if(lightningTimer){ clearInterval(lightningTimer); lightningTimer=null; } };
      map.on('overlayadd',(e)=>{ if(e.layer===lightningLayer) startLightningRefresh(); if(e.layer===sentinel2) sentinel2.bringToFront(); });
      map.on('overlayremove',(e)=>{ if(e.layer===lightnessLayer) stopLightningRefresh(); });

      const fireRisk = L.layerGroup().addLayer(L.tileLayer.wms('https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms', {
        layers:'public:fdr_current', format:'image/png', transparent:true, version:'1.1.1',
        opacity:.4, pane:'perimetersPane', attribution:'CWFIS © Natural Resources Canada'
      })); // on

      // --- NOAA Smoke timeline ----------------------------------------------
      const smokeLayer = L.esri.imageMapLayer({ url: NOAA_SMOKE_URL, format:'png32', transparent:true, opacity:0.72, pane:'smokePane' });
      smokeLayer.addTo(map); // on

      const smokeControls   = $('#smokeControls');
      const smokePlayBtn    = $('#smokePlay');
      const smokeSlider     = $('#smokeTime');
      const smokeTsLabel    = $('#smokeTimestamp');

      let smokeTimesMs = [];
      let smokeIdx = 0;
      let smokeTimer = null;

      // AUTO-PLAY tweak
      let smokeShouldAutoplayNextOn = false;
      let smokePendingAutoplay = false;

      const smokeFmt = (ms) => {
        const d = new Date(ms);
        return isMobile()
          ? d.toLocaleString(undefined, { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', hour12:false })
          : `${d.toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false })} (local)`;
      };

      function smokeSetIndex(i){
        if (!smokeTimesMs.length) return;
        smokeIdx = Math.max(0, Math.min(smokeTimesMs.length - 1, i));
        const t = smokeTimesMs[smokeIdx];
        const dt = new Date(t);
        smokeLayer.setTimeRange(dt, dt);
        smokeSlider.value = String(smokeIdx);
        smokeTsLabel.textContent = smokeFmt(t);
      }
      function smokePlay(){
        if (smokeTimer || !smokeTimesMs.length) return;
        smokePlayBtn.textContent = '⏸';
        smokeTimer = setInterval(() => smokeSetIndex((smokeIdx + 1) % smokeTimesMs.length), SMOKE_FRAME_MS);
      }
      function smokePause(){ smokePlayBtn.textContent = '▶'; if (smokeTimer){ clearInterval(smokeTimer); smokeTimer = null; } }
      smokePlayBtn.addEventListener('click', () => (smokeTimer ? smokePause() : smokePlay()));
      smokeSlider.addEventListener('input', (e) => { smokePause(); smokeSetIndex(parseInt(e.target.value, 10)); });

      const nearestIndex = (arr, target) => {
        let bestI = 0, bestD = Infinity;
        for (let i=0;i<arr.length;i++){ const d = Math.abs(arr[i]-target); if(d<bestD){ bestD=d; bestI=i; } }
        return bestI;
      };

      async function initSmokeTimes(){
        try{
          smokeTsLabel.textContent = 'Loading…';
          const r = await fetch(NOAA_SMOKE_URL + '/slices?f=json');
          if(!r.ok) throw new Error('Failed to load time slices');
          const json = await r.json();
          const allTimes = (json.slices || [])
            .map(s => s.multidimensionalDefinition?.[0]?.values?.[0])
            .filter(v => typeof v === 'number')
            .sort((a,b)=>a-b);

          if(!allTimes.length){ smokeTsLabel.textContent = 'No time frames available'; return; }

          const now = Date.now();
          const windowMs = SMOKE_HOURS_EACH_SIDE * 3600 * 1000;
          let within = allTimes.filter(t => t >= (now - windowMs) && t <= (now + windowMs));

          if(within.length === 0){
            let lo=0, hi=allTimes.length-1, best=0, bestDiff=Infinity;
            while(lo<=hi){
              const mid=(lo+hi)>>1, diff=Math.abs(allTimes[mid]-now);
              if(diff<bestDiff){ bestDiff=diff; best=mid; }
              if(allTimes[mid] < now) lo=mid+1; else hi=mid-1;
            }
            const start = Math.max(0, best - SMOKE_HOURS_EACH_SIDE);
            const end   = Math.min(allTimes.length - 1, best + SMOKE_HOURS_EACH_SIDE);
            within = allTimes.slice(start, end+1);
          }

          smokeTimesMs = within;
          smokeSlider.max = String(within.length - 1);
          smokeIdx = nearestIndex(within, now);
          smokeSlider.value = String(smokeIdx);

          if (map.hasLayer(smokeLayer)) {
            smokeSetIndex(smokeIdx);
            if (smokePendingAutoplay || smokeShouldAutoplayNextOn) {
              smokePlay();
              smokePendingAutoplay = false;
              smokeShouldAutoplayNextOn = false;
            }
          } else {
            smokeTsLabel.textContent = smokeFmt(within[smokeIdx]);
          }

        } catch (e){
          console.error('Smoke slices error:', e);
          smokeTsLabel.textContent = 'Error loading smoke timeline';
        }
      }
      initSmokeTimes();

      // --- Mobile stacking + legend sizing ----------------------------------
      const safeProbe = $('#sai-probe');
      const getSafeBottom = () => (safeProbe?.offsetHeight || 0);

      const BASE_GAP = 10;
      const LEGEND_SMOKE_GAP = 16;
      const FOOTER_SMOKE_GAP = 10;

      function sizeLegendWidth(){
        const legend = D.querySelector('.leaflet-control-layers');
        if (!legend) return;
        const vvW = (window.visualViewport && window.visualViewport.width) || window.innerWidth || D.documentElement.clientWidth || 0;
        const cap = Math.max(240, Math.floor(vvW - 24));
        legend.style.maxWidth = cap + 'px';
        legend.style.width = 'fit-content';
        const desired = Math.min(legend.scrollWidth, cap);
        legend.style.width = desired + 'px';
        legend.style.overflowX = (legend.scrollWidth > desired) ? 'auto' : 'hidden';
        return desired;
      }

      function sizeLegendHeight(){
        const legend = D.querySelector('.leaflet-control-layers');
        if (!legend) return;

        const vvH = (window.visualViewport && window.visualViewport.height) || window.innerHeight || D.documentElement.clientHeight || 0;
        const rect = legend.getBoundingClientRect();
        const topY = Math.max(0, rect.top);

        const footer = $('.nb-footer');
        const footerH = footer?.getBoundingClientRect().height || 0;

        const smokeVisible = getComputedStyle(smokeControls).display !== 'none';
        const smokeH = smokeVisible ? (smokeControls.getBoundingClientRect().height || 0) : 0;

        const safeB = getSafeBottom();

        const reserve = footerH
          + (smokeVisible ? (smokeH + LEGEND_SMOKE_GAP) : 0)
          + (BASE_GAP * 2)
          + safeB
          + 8;

        const maxH = Math.max(120, Math.floor(vvH - topY - reserve));

        legend.style.maxHeight = maxH + 'px';
        legend.style.overflowY = 'auto';
        legend.style.webkitOverflowScrolling = 'touch';
      }

      const sizeLegend = () => { sizeLegendWidth(); sizeLegendHeight(); };

      function updateBottomStackAndLegend(){
        const mobile = isMobile();
        const root = D.documentElement;

        if (!mobile){
          root.style.setProperty('--fs-bottom', '86px');
          root.style.setProperty('--smoke-bottom', '28px');
          root.style.setProperty('--legend-bottom-reserve', '180px');
          sizeLegend();
          return;
        }

        const footer = $('.nb-footer');
        const footerH = footer?.getBoundingClientRect().height || 0;

        const smokeVisible = getComputedStyle(smokeControls).display !== 'none';
        const smokeH = smokeVisible ? (smokeControls.getBoundingClientRect().height || 0) : 0;

        const safeB = getSafeBottom();

        const smokeBottom = footerH + FOOTER_SMOKE_GAP + safeB + FOOTER_SMOKE_GAP;
        root.style.setProperty('--smoke-bottom', smokeBottom + 'px');
        root.style.setProperty('--fs-bottom', (footerH + FOOTER_SMOKE_GAP + safeB + FOOTER_SMOKE_GAP) + 'px');

        const reserve = footerH
          + (smokeVisible ? (smokeH + LEGEND_SMOKE_GAP) : 0)
          + (BASE_GAP * 2)
          + safeB
          + 8;

        root.style.setProperty('--legend-bottom-reserve', Math.max(140, Math.round(reserve)) + 'px');

        sizeLegend();
      }

      const rAF = (fn)=>requestAnimationFrame(()=>requestAnimationFrame(fn));

      // Initial layout
      updateBottomStackAndLegend();
      layoutTitleBox();

      // Recompute on resize/orientation/address-bar changes
      const onGlobalReflow = () => { requestAnimationFrame(() => { updateBottomStackAndLegend(); layoutTitleBox(); const t = smokeTimesMs[smokeIdx]; if (smokeTimesMs.length && t != null) smokeTsLabel.textContent = smokeFmt(t); }); };
      window.addEventListener('resize', onGlobalReflow, { passive:true });
      window.addEventListener('orientationchange', () => rAF(onGlobalReflow), { passive:true });
      if (window.visualViewport){
        const onVV = () => rAF(onGlobalReflow);
        visualViewport.addEventListener('resize', onVV, { passive:true });
        visualViewport.addEventListener('scroll', onVV, { passive:true });
      }
      if (document.fonts && document.fonts.ready) { document.fonts.ready.then(() => rAF(onGlobalReflow)); }

      map.on('overlayadd', (e) => {
        if (e.layer === smokeLayer) {
          smokeControls.style.display = 'flex';
          smokeTimesMs.length ? smokeSetIndex(smokeIdx) : (smokeTsLabel.textContent = 'Loading…');
          smokeLayer.bringToBack();
          rAF(onGlobalReflow);

          if (smokeShouldAutoplayNextOn) {
            if (smokeTimesMs.length) {
              smokePlay();
              smokeShouldAutoplayNextOn = false;
            } else {
              smokePendingAutoplay = true;
            }
          }
        }
      });
      map.on('overlayremove', (e) => {
        if (e.layer === smokeLayer) {
          smokePause();
          smokeControls.style.display = 'none';
          rAF(onGlobalReflow);
          smokeShouldAutoplayNextOn = true;
          smokePendingAutoplay = false;
        }
      });
      if (map.hasLayer(smokeLayer)) {
        smokeControls.style.display = 'flex';
        smokeLayer.bringToBack();
        smokeTsLabel.textContent = smokeTimesMs.length ? smokeFmt(smokeTimesMs[smokeIdx]) : 'Loading…';
        rAF(onGlobalReflow);
      }

      const ro = ('ResizeObserver' in window) ? new ResizeObserver(() => rAF(onGlobalReflow)) : null;
      ro?.observe(smokeControls);
      const footerEl = $('.nb-footer'); footerEl && ro?.observe(footerEl);

      // --- AQHI --------------------------------------------------------------
      const aqhiLayer = L.esri.featureLayer({
        url:'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/aqhi_stations_observations_realtime/FeatureServer/1',
        pane:'aqiPane',
        pointToLayer:(feature,latlng)=> {
          const p=feature.properties||{};
          const raw=p.aqhi??p.aqhi_round; const val=(raw==null||Number.isNaN(Number(raw)))?null:Number(raw);
          const label=val==null?'—':val>=10?'Very High Risk':val>=7?'High Risk':val>=4?'Moderate Risk':'Low Risk';
          const color=val==null?'#6b7280':val>=10?'#8b5cf6':val>=7?'#ef4444':val>=4?'#eab308':'#22c55e';
          const icon=L.divIcon({className:'aqi-badge-icon',html:`
            <div style="display:flex;flex-direction:column;align-items:center;">
              <svg width="26" height="26" viewBox="0 0 26 26" style="filter:drop-shadow(0 2px 2px rgba(0,0,0,.25));">
                <circle cx="13" cy="13" r="11" stroke="#111827" stroke-width="2" fill="${color}" />
              </svg>
              <div style="margin-top:2px;font-size:12px;font-weight:800;color:var(--text);background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:4px 8px;line-height:1.15;text-align:center;box-shadow:var(--shadow-soft)">
                AQHI ${val ?? '—'} <span style="opacity:.8">${label}</span>
              </div>
            </div>`, iconSize:[28,48], iconAnchor:[14,24], popupAnchor:[0,-22]});
          const m=L.marker(latlng,{icon});
          const loc=p.location_name_en||''; const when=p.observation_datetime_text_en||'';
          m.bindTooltip(`${loc?loc+' — ':''}AQHI ${val ?? '—'} • ${label}${when?' • '+when:''}`,{direction:'top',offset:[0,-20],opacity:0});
          return m;
        }
      }); // off

      // --- Aircraft ----------------------------------------------------------
      const planesLayer = L.layerGroup();
      const planeMarkers=new Map();
      const planeIcon=(heading)=> L.divIcon({
        className:'plane-div-icon',
        html:`<div style="transform:rotate(-45deg);transform-origin:center;display:inline-block;">
                <div style="transform:rotate(${Number.isFinite(heading)?heading:0}deg);font-size:26px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.25))">✈️</div>
              </div>`,
        iconSize:[30,46],iconAnchor:[15,23]
      });
      const upsertPlane=(id,lat,lon,hdg,callsign,vel)=> {
        const html = `<b>${callsign||'Unknown'}</b><br>Heading: ${Number.isFinite(hdg)?Math.round(hdg):'—'}°<br>Speed: ${vel!=null?Math.round(vel*1.94384):'—'} kt`;
        let m=planeMarkers.get(id);
        if(!m){
          m=L.marker([lat,lon],{icon:planeIcon(hdg),pane:'planesPane',keyboard:false,zIndexOffset:10000}).bindPopup(html,{pane:'alwaysOnTopPopup'});
          bindHoverTogglePopup(m);
          m.addTo(planesLayer); planeMarkers.set(id,m);
        } else {
          m.setLatLng([lat,lon]); m.setIcon(planeIcon(hdg)); m.setPopupContent(html);
        }
      };
      const pruneMissing=(seen)=>{ for(const [k,m] of planeMarkers.entries()){ if(!seen.has(k)){ planesLayer.removeLayer(m); planeMarkers.delete(k); } } };
      async function fetchOpenSky(){ try{
        const [[lamin,lomin],[lamax,lomax]] = NB_BOUNDS;
        const r=await fetch(`${OPEN_SKY_URL}?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`, { cache:'no-store' });
        if(!r.ok) throw new Error(r.statusText);
        const data=await r.json(); const states=Array.isArray(data.states)?data.states:[]; const seen=new Set();
        for(const s of states){
          const icao24=s[0], callsign=(s[1]||'').trim().toUpperCase(), lon=s[5], lat=s[6], vel=s[9], hdg=s[10];
          if(!icao24||lat==null||lon==null) continue; seen.add(icao24); upsertPlane(icao24,lat,lon,hdg,callsign,vel);
        }
        pruneMissing(seen);
      } catch(e){ console.warn('OpenSky fetch failed:', e); } }
      let planesTimer=null;
      planesLayer.on('add',()=>{ fetchOpenSky(); if(!planesTimer) planesTimer=setInterval(fetchOpenSky,PLANE_REFRESH_MS); });
      planesLayer.on('remove',()=>{ if(planesTimer){ clearInterval(planesTimer); planesTimer=null; } });

      // --- City labels (clustered label markers) -----------------------------
const CITY_DATA = [
  ['Moncton',46.0878,-64.7782,79000],
  ['Saint John',45.2733,-66.0633,69000],
  ['Fredericton',45.9636,-66.6431,63000],
  ['Dieppe',46.0842,-64.6877,28500],
  ['Riverview',46.0617,-64.8052,20500],
  ['Miramichi',47.0281,-65.5019,17500],
  ['Edmundston',47.3730,-68.3251,16000],
  ['Rothesay',45.3830,-65.9965,12000],
  ['Bathurst',47.6186,-65.6517,12000],
  ['Quispamsis',45.4319,-65.9469,19500],
  ['Oromocto',45.8491,-66.4828,9500],
  ['Campbellton',48.0075,-66.6731,6700],
  ['Sackville',45.8960,-64.3688,5500],
  ['Grand Bay-Westfield',45.3629,-66.2306,5200],
  ['Woodstock',46.1527,-67.6016,5200],
  ['Grand Falls',47.0469,-67.7394,5200],
  ['Shediac',46.2197,-64.5403,7000],
  ['Tracadie',47.5081,-64.9117,16000],
  ['Caraquet',47.7943,-64.9386,4200],
  ['Shippagan',47.7400,-64.7078,2700],
  ['Bouctouche',46.4711,-64.7400,2400],
  ['Sussex',45.7221,-65.5060,4300],
  ['St. Stephen',45.1942,-67.2756,4500],
  ['St. Andrews',45.0730,-67.0530,2100],
  ['Hampton',45.5322,-65.8332,4400],
  ['Dalhousie',48.0658,-66.3737,2900],
  ['Florenceville-Bristol',46.4448,-67.6170,1600],
  ['Saint-Quentin',47.5120,-67.3920,2100],
  ['Kedgwick',47.6450,-67.3430,950],
  ['Plaster Rock',46.9108,-67.3949,1100],
  ['Perth-Andover',46.7372,-67.7089,1600],
  ['Saint-Léonard',47.1640,-67.9250,1300],
  ['Neguac',47.2420,-65.0580,1500],
  ['Petit-Rocher',47.7900,-65.7130,1400],
  ['Bas-Caraquet',47.7860,-64.9730,1400],
  ['Richibucto',46.6770,-64.8710,1300],
  ['Rexton',46.6490,-64.8750,830],
  ['Rogersville',46.7370,-65.4380,1200],
  ['Hillsborough',45.9190,-64.7630,1300],
  ['St. George',45.1290,-66.8270,1500],
  ['Blacks Harbour',45.0520,-66.7880,900],
  ['McAdam',45.5940,-67.3250,1100],
  ['Minto',46.1480,-66.0840,2400],
  ['Chipman',46.1680,-65.8820,1200],
  ['Doaktown',46.5550,-66.1180,800],
  ['Nackawic',45.9960,-67.2510,950],
  ['Hartland',46.2990,-67.5150,950],
  ['Cap-Pelé',46.2260,-64.2750,2400],
  ['Memramcook',46.0020,-64.5480,5000],
];

function makeCityMarker(name, lat, lng, pop){
  const m = L.marker([lat, lng], {
    icon: L.divIcon({ html:'', iconSize:[0,0] }),
    interactive: true,
    zIndexOffset: 1000
  }).bindTooltip(
    `<span class="city-label">${name}</span>`,
    {
      permanent: true,
      direction: 'top',
      className: 'city-label-tooltip',
      interactive: true
    }
  );

  m.options._name = name;
  m.options._pop  = Number.isFinite(pop) ? pop : 0;

  const handler = () => cityToFires(name, m.getLatLng());
  m.on('click', handler);
  m.getTooltip()?.on('click', handler);

  return m;
}

const cityClusters = L.markerClusterGroup({
  disableClusteringAtZoom: 9,
  spiderfyOnMaxZoom: false,
  zoomToBoundsOnClick: true,
  showCoverageOnHover: false,
  iconCreateFunction: (cluster) => {
    const markers = cluster.getAllChildMarkers();
    let top = null, best = -1;
    for (const m of markers){
      const p = m.options?._pop ?? 0;
      if (p > best){ best = p; top = m; }
    }
    const label = top?.options?._name || `×${markers.length}`;
    return L.divIcon({
      className: 'city-cluster-icon',
      html: `<span class="city-label">${label}</span>`,
      iconSize: [0,0],
      popupAnchor: [0,0]
    });
  }
});

CITY_DATA.forEach(([name,lat,lng,pop]) => {
  cityClusters.addLayer(makeCityMarker(name, lat, lng, pop));
});

cityClusters.addTo(map); // on

      // --- Overlays and layer control ---------------------------------------
      const overlays = {
        Smoke: smokeLayer,
        'MODIS Hotspots — Last 48 hours': modis48,
        'MODIS Hotspots — Last 7 days': modis7d,
        'Fire Perimeters': activefires,
        'Cities & Towns': cityClusters,
        Aircraft: planesLayer,
        'Weather Stations': weatherStations,
        'AQHI Risk': aqhiLayer,
        'Weather Radar': noaaRadar,
        'Lightning Density': lightningLayer,
        'NB Burn Bans': nbBurnBans,
        'Fire Risk': fireRisk,
        'Sentinel-2 Imagery': sentinel2
      };
      L.control.layers(null, overlays, { collapsed: false }).addTo(map);

      // --- Fire-status filter panel (checkboxes) -----------------------------
      const FIRE_STATUS = [
        ['Out of Control', COLORS.oc, true],
        ['Contained',      COLORS.cont, true],
        ['Under Control',  COLORS.uc, true],
        ['Being Patrolled',COLORS.pat, true],
        ['Being Monitored',COLORS.mon, true],
        ['Extinguished',   '#9aa0a6', false]
      ];
      function applyFireFilterAndMaybeInit(){ ensureFireClusters(); applyFireFilter(); }
      function injectFireStatusPanel(){
        const overlaysList = D.querySelector('.leaflet-control-layers-overlays');
        if(!overlaysList || overlaysList.querySelector('.fire-filter-block')) return;
        const block = D.createElement('div');
        block.className = 'fire-filter-block';
        block.innerHTML = `
          <div class="fire-filter-title">Fire Status</div>
          ${FIRE_STATUS.map(([label, ring, checked]) => `
            <label class="fire-filter-row" style="display:grid;grid-template-columns:18px 26px 1fr;align-items:center;gap:8px;margin:4px 0;">
              <input type="checkbox" data-status="${label}" ${checked ? 'checked' : ''} />
              <span class="legend-badge" style="--ring:${ring}">
                <i class="fa-solid fa-fire"></i>
              </span>
              <span class="text">${label}</span>
            </label>
          `).join('')}
        `;
        overlaysList.prepend(block);
        block.addEventListener('change', applyFireFilterAndMaybeInit);
        requestAnimationFrame(sizeLegend);
      }
      injectFireStatusPanel();

      // --- Move Summary & Help into the legend -------------------------------
      function mountSummaryInLegend(){
        const layersBox = D.querySelector('.leaflet-control-layers');
        const fsBtn = $('#fireSummaryBtn');
        if (!layersBox || !fsBtn) return;
        const topbar = D.createElement('div');
        topbar.className = 'overview-topbar';
        fsBtn.classList.add('in-legend');
        topbar.append(fsBtn);
        layersBox.prepend(topbar);
        requestAnimationFrame(sizeLegend);
      }
      function mountHelpInLegend(){
        const layersBox = D.querySelector('.leaflet-control-layers');
        if (!layersBox || layersBox.querySelector('.overview-footbar')) return;
        const footbar = D.createElement('div');
        footbar.className = 'overview-footbar';
        const helpBtn = D.createElement('button');
        helpBtn.type = 'button';
        helpBtn.className = 'legend-help-btn';
        helpBtn.innerHTML = '<span class="icon"><i class="fa-solid fa-circle-info"></i></span><span>Map Info &amp; How to Use</span>';
        helpBtn.addEventListener('click', openHelp);
        footbar.append(helpBtn);
        layersBox.append(footbar);
        requestAnimationFrame(sizeLegend);
      }
      mountSummaryInLegend();
      mountHelpInLegend();

      // --- Benchmarks / Summary (unchanged) ----------------------------------
      let SUMS_BENCH = null;
      async function loadSumsBenchmarks(){
        try{
          const data = await fetchLocalAny('sums_table');
          const attrs = data?.features?.[0]?.attributes || null;
          if (!attrs) return;
          SUMS_BENCH = {
            avg10Burn: attrs.AVG_10Y_BURN,
            avg10Fires: attrs.AVG_10Y_FIRES,
            lastCount: attrs.LAST_YEARS_COUNT,
            lastBurn: attrs.LAST_YEARS_BURN,
            thisCount: attrs.THIS_YEARS_COUNT,
            thisBurn: attrs.THIS_YEARS_BURN,
            fetchedAt: attrs.FETCHED_FROM_ERD ?? null
          };
          refreshSummary();
        } catch (e){
          console.warn('sums_table load failed:', e);
        }
      }
      loadSumsBenchmarks();

      const fsOverlay=$('#fireSummaryOverlay');
      const fsBody=$('#fs-body');
      const fsBtn=$('#fireSummaryBtn');
      const fsClose=$('#fs-close');
      const sizeOf=(p)=> Number((p?.FIRE_SIZE ?? p?.SIZE_HA ?? p?.AREA) ?? 0) || 0;
      const fireStoreMap = fireStore;

      function pieCSSSegments(counts){
        const order = [
          ['out of control', 'Out of Control'],
          ['contained', 'Contained'],
          ['under control', 'Under Control'],
          ['being patrolled', 'Being Patrolled'],
          ['being monitored', 'Being Monitored']
        ];
        const total = order.reduce((sum,[k]) => sum + (counts[k]||0), 0);
        if (total === 0) return { css:'conic-gradient(#e5e7eb 0 360deg)', legendHTML:'<div class="legend-item"><span class="legend-swatch" style="background:#e5e7eb"></span><span>No active statuses</span></div>' };

        let acc = 0;
        const segs = [];
        const legend = [];
        for (const [k, label] of order){
          const val = counts[k] || 0;
          if (val <= 0) continue;
          const start = acc / total * 360;
          const end   = (acc + val) / total * 360;
          acc += val;
          const color = statusColor(k);
          segs.push(`${color} ${start}deg ${end}deg`);
          legend.push(`
            <div class="legend-item" role="button" tabindex="0" data-status-key="${k}">
              <span class="legend-swatch" style="background:${color}"></span>
              <span>${label}</span>
              <span class="legend-count">${val}</span>
            </div>`);
        }
        return { css:`conic-gradient(${segs.join(',')})`, legendHTML:legend.join('') };
      }

      function buildBenchmarksHTML(){
        if (!SUMS_BENCH) return '';
        const fetched = SUMS_BENCH.fetchedAt ? ` <span style="opacity:.7">• fetched ${fmtDateTime(SUMS_BENCH.fetchedAt)}</span>` : '';
        return `
          <table class="pro-table compact" aria-label="Historic/season benchmarks">
            <thead><tr><th>Historic</th><th>Value</th></tr></thead>
            <tbody>
              <tr><td>10-year Avg YTD Fires</td><td>${toNum(SUMS_BENCH.avg10Fires,0)}</td></tr>
              <tr><td>10-year Avg YTD Area Burned</td><td>${toNum(SUMS_BENCH.avg10Burn,1)} ha</td></tr>
              <tr><td>Last Year YTD Fires</td><td>${toNum(SUMS_BENCH.lastCount,0)}</td></tr>
              <tr><td>Last Year YTD Area Burned</td><td>${toNum(SUMS_BENCH.lastBurn,1)} ha</td></tr>
              <tr><td>YTD Fires</td><td class="pro-kpi">${toNum(SUMS_BENCH.thisCount,0)}</td></tr>
              <tr><td>YTD Area Burned</td><td class="pro-kpi">${toNum(SUMS_BENCH.thisBurn,1)} ha</td></tr>
            </tbody>
          </table>
        `;
      }

      function buildSummaryHTML(){
        const items=[...fireStoreMap.values()]; const year = new Date().getFullYear();
        let totalArea=0, counts={'out of control':0,contained:0,'under control':0,'being patrolled':0,'being monitored':0,extinguished:0,other:0};
        let newToday=0, newYesterday=0, extToday=0, extYesterday=0, totalActive=0, totalExt=0;

        for(const it of items){
          const p=it.props||{};
          totalArea += sizeOf(p);
          const key=norm(it.statusKey || p.FIRE_STAT_DESC_E);
          if (key in counts) counts[key]++; else counts.other++;
          if (key === 'extinguished') totalExt++; else totalActive++;

          const det = getDetectedMs(p);
          if(det!=null){ if(isToday(det)) newToday++; else if(isYesterday(det)) newYesterday++; }

          if (key === 'extinguished') {
            const outMs = getExtinguishedMs(p);
            if (outMs!=null){ if (isToday(outMs)) extToday++; else if (isYesterday(outMs)) extYesterday++; }
          }
        }

        const { css:pieCSS, legendHTML } = pieCSSSegments(counts);
        const totalFiresYear = totalActive + totalExt;

        const tableHTML = `
          <table class="pro-table compact" aria-label="Fire summary table">
            <thead><tr><th>Current</th><th>Value</th></tr></thead>
            <tbody>
              <tr><td>Total (${year})</td><td class="pro-kpi">${toNum(totalFiresYear,0)}</td></tr>
              <tr><td>Active</td><td class="pro-kpi">${toNum(totalActive,0)}</td></tr>
              <tr><td>Out</td><td class="pro-kpi">${toNum(totalExt,0)}</td></tr>
              <tr><td>New Today</td><td>${toNum(newToday,0)}</td></tr>
              <tr><td>New Yesterday</td><td>${toNum(newYesterday,0)}</td></tr>
              <tr><td>Out Today</td><td>${toNum(extToday,0)}</td></tr>
              <tr><td>Out Yesterday</td><td>${toNum(extYesterday,0)}</td></tr>
              <tr><td>Area Burned</td><td>${toNum(totalArea,0)} ha</td></tr>
            </tbody>
          </table>
        `;

        const byStatus = new Map();
        for (const it of items) {
          const st = norm(it.statusKey || it.props?.FIRE_STAT_DESC_E || 'other');
          if (!byStatus.has(st)) byStatus.set(st, []);
          byStatus.get(st).push(it);
        }
        for (const arr of byStatus.values()) arr.sort((a,b)=> sizeOf(b.props) - sizeOf(a.props));
        const statusOrder = ['out of control','contained','under control','being patrolled','being monitored','extinguished','other'];

        const detailSections = statusOrder
          .filter(k => byStatus.has(k))
          .map(k => {
            const label = k==='other' ? 'Other' : k.replace(/\b\w/g, c=>c.toUpperCase());
            const list = byStatus.get(k).map((it) => {
              const p=it.props||{};
              const name = p.FIRE_NAME || p.FIRE_ID || 'Unnamed Fire';
              const size = toNum(sizeOf(p),0);
              const det  = fmtDateTZ(getDetectedMs(p));
              const extra = (k==='extinguished') ? ` • Out: ${fmtDateTZ(getExtinguishedMs(p))}` : '';
              return `<li style="margin:4px 0;"><a href="#" data-fireid="${it.id}"><span style="font-weight:700">${name}</span>&nbsp;—&nbsp;${size} ha <span style="opacity:.8">• ${label}</span> <span style="opacity:.8">• Detected: ${det}${extra}</span></a></li>`;
            }).join('') || '<li>None</li>';
            return `<div style="margin:10px 0"><b>${label}</b><ol class="summary-list">${list}</ol></div>`;
          }).join('');

        return `
          <div style="margin:10px 0"><b>Status (Active Only)</b></div>
          <div class="pie-wrap" aria-label="Fires by status pie chart">
            <div class="pie" style="background:${pieCSS}"></div>
            <div class="pie-legend">${legendHTML}</div>
          </div>

          <div style="margin:10px 0 2px"><b>Overview</b></div>
          ${tableHTML}

          ${buildBenchmarksHTML()}

          <div style="margin-top:10px"><b>Fires (largest → smallest)</b></div>
          <div class="fs-scroll" id="fs-scroll">
            ${detailSections}
          </div>`;
      }

      function refreshSummary(){ fsBody.innerHTML = buildSummaryHTML(); wireSummaryClicks(); wirePieLegendClicks(); }

      function ensureStatusEnabled(statusKey){
        const target = norm(statusKey);
        const cbs = $$('.fire-filter-block input[type="checkbox"]');
        if (!cbs.length) return;
        let changed = false;
        cbs.forEach(cb => {
          const k = norm(cb.getAttribute('data-status'));
          if (k === target && !cb.checked) { cb.checked = true; changed = true; }
        });
        if (changed) applyFireFilter();
      }

      // NEW: ensure ALL active statuses are enabled (so all active points show)
      function enableAllActiveStatuses(){
        const set = new Set(['out of control','contained','under control','being patrolled','being monitored']);
        const cbs = $$('.fire-filter-block input[type="checkbox"]');
        let changed=false;
        cbs.forEach(cb=>{
          const k = norm(cb.getAttribute('data-status'));
          if (set.has(k) && !cb.checked){ cb.checked = true; changed = true; }
        });
        if (changed) applyFireFilter();
      }

      function wireSummaryClicks(){
        const cont = $('#fs-scroll'); if(!cont) return;
        cont.addEventListener('click', (e)=>{
          const a = e.target.closest('a[data-fireid]'); if(!a) return;
          e.preventDefault();
          const rec = fireStore.get(a.getAttribute('data-fireid')); if(!rec) return;
          const statusKey = rec.statusKey || norm(rec.props?.FIRE_STAT_DESC_E || '');
          if (statusKey) ensureStatusEnabled(statusKey);
          closeSummary();
          hideOverviewPanel();
          map.flyTo(rec.latlng, Math.max(map.getZoom(), 12), { duration:.6 });
          map.once('moveend', ()=> rec.layer?.openPopup && rec.layer.openPopup());
        }, { passive: false });
      }

      function setExclusiveStatusAndZoom(statusKey){
        const target = norm(statusKey);
        const cbs = $$('.fire-filter-block input[type="checkbox"]');
        if (!cbs.length) return;
        cbs.forEach(cb => { cb.checked = (norm(cb.getAttribute('data-status')) === target); });
        applyFireFilter();
        closeSummary();
        hideOverviewPanel();
        const matches = [];
        for (const m of activeMarkersAll) if (m.options._statusKey === target) matches.push(m);
        if (!matches.length) return;
        if (matches.length === 1){
          map.flyTo(matches[0].getLatLng(), Math.max(map.getZoom(), 11), { duration: 0.6 });
          return;
        }
        const latlngs = matches.map(m => m.getLatLng());
        const bounds = L.latLngBounds(latlngs);
        const padX = Math.round(innerWidth * 0.06);
        const padY = Math.round(innerHeight * 0.06);
        map.fitBounds(bounds, { paddingTopLeft:[padX,padY], paddingBottomRight:[padX,padY], animate:true });
      }

      function wirePieLegendClicks(){
        const legend = fsBody.querySelector('.pie-legend'); if(!legend) return;
        const handler = (el) => {
          const key = el.getAttribute('data-status-key');
          if (!key) return;
          setExclusiveStatusAndZoom(key);
        };
        legend.addEventListener('click', (e)=>{
          const item = e.target.closest('.legend-item[data-status-key]'); if(item) handler(item);
        });
        legend.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter' || e.key === ' ') {
            const item = e.target.closest('.legend-item[data-status-key]'); if(item){ e.preventDefault(); handler(item); }
          }
        });
      }

      const openSummary = () => { refreshSummary(); fsOverlay.hidden=false; fsOverlay.style.display='flex'; fsClose.focus(); };
      const closeSummary = () => { fsOverlay.style.display='none'; fsOverlay.hidden=true; fsBtn.focus(); };
      fsBtn.addEventListener('click', openSummary);
      fsClose.addEventListener('click', closeSummary);
      fsOverlay.addEventListener('click',(e)=>{ if(e.target===fsOverlay) closeSummary(); });
      window.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && !fsOverlay.hidden) closeSummary(); });

      // --- Help modal --------------------------------------------------------
const mhOverlay = $('#mapHelpOverlay');
const mhBody = $('#mh-body');
const mhClose = $('#mh-close');

function buildHelpHTML(){
  const desc = {
    'Smoke': 'Forecast surface smoke (from NOAA). Use the timeline control at the bottom to scrub or play an animation.',
    'MODIS Hotspots — Last 48 hours': 'Thermal hotspots detected by NASA MODIS within the last 2 days. Useful for spotting new ignition points.',
    'MODIS Hotspots — Last 7 days': 'MODIS hotspots detected in the last week (slightly older data).',
    'Fire Perimeters': 'Current wildfire perimeter polygons, with area labels visible when zoomed in.',
    'Cities & Towns': 'Labels for NB communities. Click a town name to see nearby fires (within 30 km).',
    'Aircraft': 'Aircraft in NB airspace from the OpenSky network. Includes waterbombers and other planes.',
    'Weather Stations': 'Environment Canada stations showing live wind, temperature and humidity.',
    'AQHI Risk': 'Air Quality Health Index (AQHI) observations at reporting stations.',
    'Weather Radar': 'NOAA radar reflectivity mosaic (precipitation).',
    'Lightning Density': 'Recent lightning strike density. Updates automatically.',
    'NB Burn Bans': 'Official New Brunswick burn restriction map from GNB.',
    'Fire Risk': 'Daily Fire Danger Rating from the Canadian Wildland Fire Information System.',
    'Sentinel-2 Imagery': 'Recent high-resolution satellite imagery. Clouds may obscure view.'
  };

  const list = Object.keys(overlays).map(name => {
    const d = desc[name] || 'No description available.';
    return `<li style="margin:6px 0;"><b>${name}</b><br><span style="opacity:.9">${d}</span></li>`;
  }).join('');

  const statusDefs = `
    <div style="margin-top:14px">
      <h3 style="margin:6px 0;font-size:15px;font-weight:800">Fire Status Definitions</h3>
      <ul style="padding-left:16px; margin:6px 0; line-height:1.5">
        <li><b>Out of Control</b> – Any new start or fire not contained and still growing. Escape probable along established breaks. Requires a percent contained value.</li>
        <li><b>Being Monitored</b> – A known, out of control fire that is not immediately threatening life or infrastructure. Observed by aircraft or satellite with no resources assigned.</li>
        <li><b>Contained</b> – Fire is within a bulldozed break or wet line that should restrict growth with continued suppression. Still active on some flanks; jump/escape possible.</li>
        <li><b>Under Control</b> – Control line established and fire activity is low with occasional flare-ups. Jump/escape unlikely. Sustained mop-up underway.</li>
        <li><b>Being Patrolled</b> – Fire secured within all breaks/wet lines. Activity nil, occasional smokes only. Jump/escape probability nil. Minimal staff required.</li>
        <li><b>Out</b> – Fire is cold with no visible smoke for at least 24 hours. Declared out when IC confirms all hotspots are extinguished.</li>
        <li><b>Percent Contained</b> – Estimate of the fire perimeter secured by wet line, dozer break, or natural barriers (roads, lakes, rivers).</li>
      </ul>
    </div>
  `;

  return `
    <p><b>Basic Navigation:</b> Drag to move the map, scroll or use <b>+</b>/<b>−</b> to zoom. The <b>Reset Map View</b> button fits back to New Brunswick.</p>
    <p><b>Overview Panel:</b> Use the layer checkboxes to toggle data on/off. At the top you’ll find a fire summary button, and at the bottom this help button.</p>
    <p><b>Fires:</b> Click fire icons for details (size, status, dates). Hover or tap to preview quickly. Filters let you show/hide statuses (Out of Control, Contained, etc.).</p>
    <p><b>Smoke Forecast:</b> When the Smoke layer is active, a timeline appears at the bottom. Press ▶ to play or drag the slider to view a specific hour.</p>
    <p><b>Cities:</b> Click city labels to see all active fires within 30 km, with distance lines and a quick-jump list.</p>
    <p><b>Layers Explained:</b></p>
    <ul style="padding-left:16px; margin:8px 0 0;">${list}</ul>
    ${statusDefs}
    <p style="margin-top:10px; font-size:12px; color:var(--muted);">
      This map is an unofficial tool. Data sources include GNB ERD, Esri, NOAA, Environment Canada, CWFIS, and the OpenSky Network.
    </p>
  `;
}

function openHelp(){ 
  mhBody.innerHTML = buildHelpHTML(); 
  mhOverlay.hidden=false; 
  mhOverlay.style.display='flex'; 
  mhClose.focus(); 
}
function closeHelp(){ 
  mhOverlay.style.display='none'; 
  mhOverlay.hidden=true; 
}
mhClose.addEventListener('click', closeHelp);
mhOverlay.addEventListener('click', (e)=>{ if(e.target === mhOverlay) closeHelp(); });
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !mhOverlay.hidden) closeHelp(); });



      // --- Overview toggle & reset ------------------------------------------
      const mapToggleBtn = $('#mapToggleBtn');
      const mtbText = $('#mtb-text');
      const updateOverviewButton=()=>{
        const hidden = D.body.classList.contains('map-ui-hidden');
        const label = hidden ? 'Show Overview' : 'Hide Overview';
        mapToggleBtn.setAttribute('aria-pressed', String(!hidden));
        mapToggleBtn.title = label;
        mtbText.textContent = label;
        layoutTitleBox();
      };
      D.body.classList.add('map-ui-hidden');
      updateOverviewButton();

      mapToggleBtn.addEventListener('click', () => {
        D.body.classList.toggle('map-ui-hidden'); updateOverviewButton(); requestAnimationFrame(sizeLegend);
      });
      $('#resetViewBtn').addEventListener('click', () => {
        localStorage.removeItem(LS_KEY);
        fitProvinceToView({ animate:true });
      });

      function hideOverviewPanel(){
        if (!D.body.classList.contains('map-ui-hidden')){
          D.body.classList.add('map-ui-hidden');
          updateOverviewButton();
          requestAnimationFrame(sizeLegend);
        }
      }

      // --- City → Fires proximity (30 km, ACTIVE ONLY) ----------------------
      const CITY_RADIUS_M = 30_000;
      const cityProximityLayer = L.layerGroup({ pane: 'firesPane' }).addTo(map);

      // keep a reference to the current city popup, so we can clear lines when it closes
      let cityProximityPopup = null;

      function kmStr(meters) { return (meters / 1000).toFixed(1); }

      // clear proximity graphics when *that* city popup closes
      map.on('popupclose', (e) => {
        if (e.popup === cityProximityPopup) {
          cityProximityLayer.clearLayers();
          cityProximityPopup = null;
        }
      });

      function cityToFires(name, cityLatLng) {
        // show all ACTIVE fire points (doesn't affect extinguished)
        enableAllActiveStatuses();

        // Clear previous graphics
        cityProximityLayer.clearLayers();
        cityProximityPopup = null;

        // Collect ONLY ACTIVE fires within radius
        const nearby = [];
        for (const rec of fireStore.values()) {
          const statusKey = norm(rec.statusKey || rec.props?.FIRE_STAT_DESC_E || '');
          if (statusKey === 'extinguished') continue; // <- only active fires
          const d = map.distance(cityLatLng, rec.latlng);
          if (Number.isFinite(d) && d <= CITY_RADIUS_M) nearby.push({ rec, d });
        }

        // If none: say so and center the city
        if (!nearby.length) {
          const p = L.popup({ pane: 'alwaysOnTopPopup', maxWidth: 360 })
            .setLatLng(cityLatLng)
            .setContent(`<b>${name}</b><br>No active fires within 30&nbsp;km.`)
            .openOn(map);
          cityProximityPopup = p;

          hideOverviewPanel();
          map.flyTo(cityLatLng, Math.max(map.getZoom(), 9), { duration: 0.5 });
          return;
        }

        // Draw lines + distance labels; build list & bounds
        nearby.sort((a, b) => a.d - b.d);
        const bounds = L.latLngBounds([cityLatLng]);
        const listHTML = nearby.map(({ rec, d }) => {
          const km = kmStr(d);

          // high-contrast line with soft casing for dark basemaps
          L.polyline([cityLatLng, rec.latlng], {
            color: '#000000', weight: 6, opacity: 0.55
          }).addTo(cityProximityLayer);
          L.polyline([cityLatLng, rec.latlng], {
            color: '#ffffff', weight: 3, opacity: 0.95, dashArray: '6,8'
          }).addTo(cityProximityLayer);

          // midpoint distance label
          const mid = L.latLng(
            (cityLatLng.lat + rec.latlng.lat) / 2,
            (cityLatLng.lng + rec.latlng.lng) / 2
          );
          L.tooltip({
            permanent: true, direction: 'center',
            className: 'distance-label-tooltip', opacity: 1
          })
            .setLatLng(mid)
            .setContent(`<span class="distance-label">${km} km</span>`)
            .addTo(cityProximityLayer);

          bounds.extend(rec.latlng);

          // NEW: include status + distance in the list
          const fname = rec.props.FIRE_NAME || rec.props.FIRE_ID || 'Fire';
          const statusKey = norm(rec.statusKey || rec.props?.FIRE_STAT_DESC_E || '—');
          const statusLabel = statusKey.replace(/\b\w/g, c => c.toUpperCase());
          const color = statusColor(statusKey);
          return `<li>
            <a href="#" data-fireid="${rec.id}">
              <span class="dot" style="background:${color}; margin-right:6px"></span>
              <b>${fname}</b>
              <span style="opacity:.85">• ${statusLabel}</span>
              <span style="opacity:.85">• ${km} km</span>
            </a>
          </li>`;
        }).join('');

        // Popup with list (click-through to the fire)
        const html = `
          <div style="min-width:260px">
            <div style="font-weight:800;margin-bottom:6px">${name}</div>
            <div><b>Active fires within 30&nbsp;km:</b></div>
            <ol class="summary-list">${listHTML}</ol>
          </div>`;

        const p = L.popup({ pane: 'alwaysOnTopPopup', maxWidth: 420 })
          .setLatLng(cityLatLng)
          .setContent(html);

        // IMPORTANT: attach click handler on popup "add" so it always exists
        p.once('add', () => {
          const el = p.getElement();
          el?.addEventListener('click', (evt) => {
            const a = evt.target.closest('a[data-fireid]');
            if (!a) return;
            evt.preventDefault();
            const rec = fireStore.get(a.getAttribute('data-fireid'));
            if (!rec) return;
            ensureStatusEnabled(rec.statusKey || norm(rec.props?.FIRE_STAT_DESC_E || ''));
            hideOverviewPanel();
            // Reliable zoom + open: wait for moveend, then open popup
            map.flyTo(rec.latlng, Math.max(map.getZoom(), 12), { duration: 0.6 });
            map.once('moveend', () => { rec.layer?.openPopup?.(); });
          }, { passive: false });
        });

        p.openOn(map);
        cityProximityPopup = p;

        // Fit all lines + city
        const pad = Math.round(Math.min(innerWidth, innerHeight) * 0.08);
        hideOverviewPanel();
        map.fitBounds(bounds, { padding: [pad, pad], animate: true });
      }

      // Final sizing once legend is in DOM
      requestAnimationFrame(() => { sizeLegend(); layoutTitleBox(); });
    });
  </script>
</body>
</html>
