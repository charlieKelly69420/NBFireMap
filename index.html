<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>New Brunswick Wildfire Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light" />

    <!-- Fonts / Leaflet / Plugins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <style>
      :root {
        color-scheme: light;
        --bg: #f7f8fc;
        --text: #0f172a;
        --muted: #5b6474;
        --panel: rgba(255, 255, 255, 0.85);
        --panel-strong: #fff;
        --border: #e6eaf1;
        --radius: 14px;
        --radius-sm: 10px;
        --shadow: 0 10px 30px rgba(2, 8, 20, 0.08);
        --shadow-soft: 0 6px 16px rgba(2, 8, 20, 0.06);
        --btn-bg: #fff;
        --btn-border: #d9dee6;
        --btn-hover: #f2f4f7;
        --link: #2563eb;
        --focus: 0 0 0 3px rgba(37, 99, 235, 0.28);
        --oc: #ef4444;
        --cont: #fb923c;
        --uc: #facc15;
        --pat: #22c55e;
        --modis: #f59e0b; /* MODIS hotspot color */
        --perimeter: #ef4444;
        --boundary: #0b0f19;
        --fs-12: 12px;
        --fs-14: 14px;
        --fs-16: 16px;
        --fs-18: 18px;
      }

      html, body, #map { height: 100%; margin: 0; }

      body {
        background: var(--bg);
        color: var(--text);
        font: var(--fs-14) / 1.45 Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
        letter-spacing: 0.1px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Leaflet controls */
      .leaflet-bar a, .leaflet-bar a:hover {
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--text);
        box-shadow: var(--shadow-soft);
      }
      .leaflet-bar a { width: 34px; height: 34px; line-height: 34px; font-size: 16px; }

      .leaflet-control-attribution {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-soft);
        padding: 4px 8px;
      }
      .leaflet-top.leaflet-left  { top: 52px !important; }
      .leaflet-top.leaflet-right { top: 72px !important; }

      /* Layers/legend panel — desktop wide, mobile can wrap */
      .leaflet-control-layers {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        font-size: var(--fs-14);
        padding: 8px 40px 8px 14px; /* extra right padding */
        backdrop-filter: blur(6px);
        min-width: 260px; /* wide enough for “Fires — Being Patrolled” on desktop */
        width: auto;
        max-width: none;
        white-space: nowrap; /* prevent wrapping by default (desktop) */
      }
      .leaflet-control-layers-expanded,
      .leaflet-control-layers-list { max-height: none !important; overflow: visible !important; }
      .leaflet-control-layers-overlays label {
        display: grid; grid-template-columns: 18px 26px 1fr; align-items: center; column-gap: 8px;
        min-width: max-content; line-height: 1.25;
      }
      .leaflet-control-layers-overlays input { margin: 0; width: max-content; height: 18px; }
      .leaflet-control-layers-overlays .text { min-width: max-content; white-space: nowrap; overflow: visible; text-overflow: clip; }

      /* Mobile: allow wrapping and fit within viewport */
      @media (max-width: 640px) {
        .leaflet-control-layers {
          min-width: auto;
          max-width: calc(100vw - 24px);
          width: auto;
          white-space: normal; /* allow wrapping on mobile */
        }
        .leaflet-control-layers-overlays .text { white-space: normal; } /* labels can wrap on mobile */
      }
      @media (max-width: 767.98px) { .leaflet-control-layers { font-size: var(--fs-12); } }

      /* Buttons */
      .map-btn {
        position: absolute; z-index: 1001; background: var(--btn-bg); border: 1px solid var(--btn-border);
        border-radius: 999px; padding: 10px 14px; font-size: var(--fs-14); font-weight: 700; color: var(--text);
        cursor: pointer; box-shadow: var(--shadow); display: inline-flex; align-items: center; gap: 8px;
        transition: background .2s, transform .06s, box-shadow .2s;
      }
      .map-btn:hover { background: var(--btn-hover); box-shadow: 0 8px 22px rgba(0,0,0,.08); }
      .map-btn:active { transform: translateY(1px); }
      .map-btn:focus-visible { outline: none; box-shadow: var(--focus); }
      .map-toggle-btn { top: 12px; right: 12px; }
      .reset-view-btn { top: 12px; left: 12px; z-index: 1002; }
      .map-btn .icon { width: 18px; height: 18px; display: inline-grid; place-items: center; }

      .map-ui-hidden .leaflet-control-layers { opacity: 0; pointer-events: none; }

      /* Tooltips/labels */
      .city-label-tooltip, .perimeter-label-tooltip { background: none !important; border: none !important; box-shadow: none !important; padding: 0 !important; }
      .city-label { font-size: 15px; font-weight: 800; color: #fff;
        text-shadow: 0 0 2px rgba(0,0,0,.7), 0 0 8px rgba(0,0,0,.6), 1px 1px 0 rgba(0,0,0,.9); }
      .perimeter-label { font-size: 12px; font-weight: 800; pointer-events: none; padding: 2px 6px; border-radius: 6px;
        background: color-mix(in oklab, var(--perimeter) 12%, transparent); backdrop-filter: blur(2px); }

      /* Summary modal */
      .fire-summary-btn { position: fixed; left: 12px; bottom: 86px; z-index: 2001; }
      .fire-summary-overlay { position: fixed; inset: 0; display: none; align-items: start; justify-content: center; z-index: 3000;
        background: rgba(0,0,0,.25); backdrop-filter: blur(2px); }
      .fire-summary { margin-top: 16px; background: var(--panel-strong); border: 1px solid var(--border); border-radius: 16px;
        box-shadow: var(--shadow); width: min(560px, calc(100% - 24px)); color: var(--text); }
      .fire-summary header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px 8px; }
      .fire-summary h2 { font-size: var(--fs-18); font-weight: 800; margin: 0; }
      .fire-summary .body { padding: 0 16px 16px; line-height: 1.5; }
      .close-summary { background: var(--btn-bg); border: 1px solid var(--btn-border); color: var(--text); border-radius: var(--radius-sm);
        padding: 8px 12px; cursor: pointer; font-weight: 700; box-shadow: var(--shadow-soft); }
      .close-summary:hover { background: var(--btn-hover); }
      .close-summary:focus-visible { outline: none; box-shadow: var(--focus); }
      .chip { display: inline-flex; align-items: center; gap: 8px; background: var(--panel); border: 1px solid var(--border);
        border-radius: 999px; padding: 6px 10px; margin: 0 8px 8px 0; font-weight: 700; box-shadow: var(--shadow-soft); }
      .dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; }
      .summary-list { margin: 8px 0 0; padding-left: 12px; list-style: decimal; list-style-position: inside; }
      .summary-list a { color: var(--link); text-decoration: none; font-weight: 700; }
      .summary-list a:hover { text-decoration: underline; }
      .fs-scroll { max-height: 260px; overflow-y: auto; margin-top: 6px; }
      .fs-meta-row { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 6px; font-weight: 800; }

      /* Markers + legend bits */
      .marker-badge { width: 38px; height: 38px; border-radius: 999px; display: grid; place-items: center;
        background: var(--panel-strong); border: 2.5px solid var(--ring, #9aa0a6); box-shadow: 0 2px 10px rgba(0,0,0,.18); }
      .marker-badge i { font-size: 18px; color: var(--ring, #9aa0a6); }
      .legend-icon { width: 18px; height: 18px; display: inline-grid; place-items: center; }
      .icons-pack { display: inline-flex; gap: 6px; vertical-align: middle; justify-content: center; width: 26px; }
      .legend-sub { margin: 6px 0 6px 52px; display: grid; row-gap: 6px; }
      .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); }
      .legend-line { width: 18px; height: 3px; border-radius: 2px; display: inline-block; }
      .legend-badge { width: 18px; height: 18px; border-radius: 999px; display: grid; place-items: center; background: #fff; border: 2.5px solid var(--ring); }
      .legend-badge i { font-size: 11px; color: var(--ring); }
      .legend-modis-dot { width: 10px; height: 10px; border-radius: 999px; background: var(--modis); display: inline-block; box-shadow: 0 0 0 1.5px #111827 inset; }

      /* Footer link */
      .nb-footer { position: fixed; bottom: 10px; left: 0; width: 100%; text-align: center; z-index: 2000; }
      .nb-footer a {
        background: var(--btn-bg); border: 1px solid var(--btn-border); border-radius: 12px; padding: 10px 18px;
        box-shadow: var(--shadow); color: var(--link); font-weight: 800; text-decoration: none; display: inline-flex; align-items: center; gap: 10px;
      }

      /* --- Wind arrow bead animation --- */
      @keyframes windDots { 0%{transform:translateY(18px);opacity:0;} 10%{opacity:1;} 100%{transform:translateY(-18px);opacity:0;} }
      .wind-dots { position: absolute; top: 6px; left: 50%; transform: translateX(-50%); width: 8px; height: 28px; pointer-events: none; }
      .wind-dots .dot { position: absolute; left: 1px; width: 6px; height: 6px; border-radius: 50%; background: #fff; filter: drop-shadow(0 1px 1px rgba(0,0,0,.45)); animation: windDots var(--spd,1.6s) linear infinite; }
      .wind-dots .dot:nth-child(2){ animation-delay: calc(var(--spd,1.6s) * .20); }
      .wind-dots .dot:nth-child(3){ animation-delay: calc(var(--spd,1.6s) * .40); }
      @media (prefers-reduced-motion: reduce){ .wind-dots .dot { animation: none; } }
    
    /* Mobile: make the legend box fit the viewport and allow wrapping correctly */
/* Mobile: keep legend within the viewport, allow wrapping + internal scroll */
/* Mobile: hard-cap the grey legend box and make only the list scroll */
/* Mobile: hard-cap the grey legend box and make only the list scroll */
@media (max-width: 640px) {
  /* The outer grey box */
  .leaflet-control-layers {
    box-sizing: border-box;
    width: calc(100vw - 24px);
    max-width: calc(100vw - 24px);
    min-width: 0;
    padding: 8px 14px;
    border-radius: 14px;
    white-space: normal;
    display: flex;              /* key: make container a column */
    flex-direction: column;
    max-height: 60vh;           /* cap the grey box height */
    overflow: hidden;           /* hide overflow outside the list */
  }

  /* The inner <form> that contains the lists (this must scroll) */
  .leaflet-control-layers .leaflet-control-layers-list {
    flex: 1 1 auto;             /* fill remaining space IN the grey box */
    min-height: 0;              /* allow it to actually shrink */
    overflow-y: auto;           /* only this scrolls */
    overscroll-behavior: contain;
    max-height: none;           /* let flex, not max-height, do the work */
  }

  /* Let rows shrink so label text wraps within available width */
  .leaflet-control-layers-overlays label,
  .leaflet-control-layers-base label {
    min-width: 0;               /* overrides desktop max-content */
    grid-template-columns: 18px 26px 1fr;
  }

  /* Ensure long labels wrap instead of pushing the box taller */
  .leaflet-control-layers-overlays .text,
  .leaflet-control-layers-base .text {
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
  }

  /* Optional: collapse sublegend to save vertical space on phones */
  .leaflet-control-layers-overlays .legend-sub {
    display: none;
  }
}




    </style>
  </head>
  <body>
    <div id="map" aria-label="Interactive wildfire map"></div>

    <button id="mapToggleBtn" class="map-btn map-toggle-btn" type="button" aria-pressed="false" title="Show/Hide layers">
      <span class="icon"><i class="fa-solid fa-layer-group"></i></span><span>Show Layers</span>
    </button>
    <button id="resetViewBtn" class="map-btn reset-view-btn" type="button" title="Reset map view">
      <span class="icon"><i class="fa-solid fa-compass"></i></span><span>Reset Map View</span>
    </button>
    <button id="fireSummaryBtn" class="map-btn fire-summary-btn" type="button" title="Open summary">
      <span class="icon"><i class="fa-solid fa-fire"></i></span><span>Fire Summary</span>
    </button>

    <div id="fireSummaryOverlay" class="fire-summary-overlay" role="presentation" hidden>
      <div class="fire-summary" role="dialog" aria-modal="true" aria-labelledby="fs-title">
        <header>
          <h2 id="fs-title">New Brunswick Fire Summary</h2>
          <button id="fs-close" class="close-summary" type="button"><span class="icon"><i class="fa-solid fa-xmark"></i></span> Close</button>
        </header>
        <div id="fs-body" class="body"></div>
      </div>
    </div>

    <div class="nb-footer">
      <a href="https://www.gnb.ca/en/topic/laws-safety/emergency-preparedness-alerts/fire-watch.html" target="_blank" rel="noopener">
        <i class="fa-solid fa-up-right-from-square"></i> NB Fire Watch &amp; Burn Restrictions
      </a>
    </div>

    <!-- JS (deferred) -->
    <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script defer src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
    <script defer src="https://unpkg.com/esri-leaflet-image/dist/esri-leaflet-image.js"></script>
    <script defer src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script defer src="callsigns.js"></script>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        'use strict';

        /* ---------- Shorthands & config ---------- */
        const $  = (s, r=document) => r.querySelector(s);
        const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

        const LS_KEY = 'nbMapView';
        const NB_BOUNDS = [[44.0, -69.5],[48.5, -62.0]]; // kept for other logic (e.g., OpenSky bbox)

        // ⬇ Default view set to screenshot framing
        const INITIAL_VIEW = { center: [46.7, -66.2], zoom: 7 };
        const isMobile = () => innerWidth < 768;   /* define ONCE here */
        const ATLANTIC_TZ = 'America/Moncton';

        /* ---------- Utilities ---------- */
        const getSavedView = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch { return null; } };
        const saveView = (map) => {
          const c = map.getCenter();
          localStorage.setItem(LS_KEY, JSON.stringify({ center: [c.lat, c.lng], zoom: map.getZoom() }));
        };
        const norm = (s) => (s || '').toString().trim().toLowerCase();
        const cssVal = (n) => getComputedStyle(document.documentElement).getPropertyValue(n).trim();
        const fireStatusColor = (s) => ({ 'out of control': cssVal('--oc'), contained: cssVal('--cont'), 'under control': cssVal('--uc'), 'being patrolled': cssVal('--pat') }[norm(s)] || '#9aa0a6');
        const fmtDT = (v) => v==null ? '—' : new Date(+v).toLocaleString(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'});
        const fmtDate = (v) => v==null ? '—' : new Date(+v).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit',timeZone:ATLANTIC_TZ});
        const num = (n,d=1) => (n==null||isNaN(n)) ? '—' : Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
        const ymdInTz = (ms, tz=ATLANTIC_TZ) => {
          const fmt=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'});
          const parts=fmt.formatToParts(new Date(ms)); const g=(k)=>+parts.find(p=>p.type===k)?.value;
          return {y:g('year'),m:g('month'),d:g('day')};
        };
        const sameYMD = (a,b,tz)=>{ if(a==null||b==null) return false; const A=ymdInTz(a,tz),B=ymdInTz(b,tz); return A.y===B.y&&A.m===B.m&&A.d===B.d; };
        const yesterdayUTCms = (tz=ATLANTIC_TZ)=>{ const t=ymdInTz(Date.now(),tz); return Date.UTC(t.y,t.m-1,t.d)-86400000; };
        const isToday = (ms)=>sameYMD(ms, Date.now(), ATLANTIC_TZ);
        const isYesterday = (ms)=>sameYMD(ms, yesterdayUTCms(ATLANTIC_TZ), ATLANTIC_TZ);
        const aqhiCategory = (n)=>{ const v=Number(n); if(!isFinite(v)) return {label:'—',color:'#6b7280'}; if(v>=10) return {label:'Very High',color:'#8b5cf6'}; if(v>=7) return {label:'High',color:'#ef4444'}; if(v>=4) return {label:'Moderate',color:'#eab308'}; return {label:'Low',color:'#22c55e'}; };

        /* ---------- Map init ---------- */
        const restored = getSavedView();
        const map = L.map('map', {
          center: restored?.center || INITIAL_VIEW.center,
          zoom:   restored?.zoom   || INITIAL_VIEW.zoom,
        });

        map.on('moveend', () => saveView(map));

        // Panes
        [
          ['alwaysOnTopPopup', 9999],
          ['sentinelPane', 400],
          ['nbBoundaryPane', 405],
          ['perimetersPane', 412],
          ['radarPane', 413],
          ['lightningPane', 413],
          ['viirsPane', 414],     // reuse this pane for MODIS hotspots
          ['weatherPane', 415],
          ['aqiPane', 416],
          ['firesPane', 420],
          ['planesPane', 1000, true]
        ].forEach(([name, z, pe]) => {
          const p = map.createPane(name);
          p.style.zIndex = z;
          if (pe) p.style.pointerEvents = 'auto';
        });

        // Basemap
        L.esri.basemapLayer('Imagery').addTo(map);

        const sentinel2c = L.esri.imageMapLayer({
          url: 'https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer',
          opacity: 0.7,
          pane: 'sentinelPane'
        });

        // Locate control (mobile only)
        if (isMobile()) {
          L.control.locate({
            position: 'topleft', flyTo: true, showPopup: false, keepCurrentZoomLevel: true,
            icon: 'fa fa-location-crosshairs', strings: { title: 'Show me where I am' }
          }).addTo(map);
        }

        /* ---------- Fire layers (split by status) + store ---------- */
        const fireStore = new Map(); // for summary

        const statusDefs = [
          { key: 'out of control',  label: 'Fires — Out of Control',  where: "FIRE_STAT_DESC_E = 'Out of Control'",  varName: '--oc'  },
          { key: 'contained',       label: 'Fires — Contained',       where: "FIRE_STAT_DESC_E = 'Contained'",       varName: '--cont'},
          { key: 'under control',   label: 'Fires — Under Control',   where: "FIRE_STAT_DESC_E = 'Under Control'",   varName: '--uc'  },
          { key: 'being patrolled', label: 'Fires — Being Patrolled', where: "FIRE_STAT_DESC_E = 'Being Patrolled'", varName: '--pat' }
        ];

        function fireBadgeIcon(status) {
          const ring = fireStatusColor(status);
          return L.divIcon({
            className: 'fire-badge-icon',
            html: `<div class="marker-badge" style="--ring:${ring}"><i class="fa-solid fa-fire" aria-hidden="true"></i></div>`,
            iconSize: [38, 38], iconAnchor: [19, 26], popupAnchor: [0, -22]
          });
        }

        function bindFireFeature(feature, layer) {
          const p = feature.properties || {};
          const html = `
            <div style="font:14px/1.45 Inter,system-ui,Segoe UI,Arial;min-width:240px;color:var(--text)">
              <div style="font-weight:800;font-size:16px;margin-bottom:6px;letter-spacing:.2px">${p.FIRE_NAME || 'Unnamed Fire'}</div>
              <div style="margin:6px 0 10px">
                <span style="display:inline-flex;align-items:center;gap:8px;padding:5px 10px;border-radius:999px;background:var(--panel);border:1px solid var(--border);font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,.12)">
                  <span class="dot" style="background:${fireStatusColor(p.FIRE_STAT_DESC_E)}"></span>${p.FIRE_STAT_DESC_E || '—'}
                </span>
              </div>
              <div><b>Area:</b> ${num(p.FIRE_SIZE, 1)} ha</div>
              <div><b>Detected:</b> ${fmtDT(p.TIME_DETECTED)}</div>
              <div><b>Status updated:</b> ${fmtDT(p.FIRE_STAT_DATE)}</div>
            </div>`;
          layer.bindPopup(html, { maxWidth: 340, pane: 'alwaysOnTopPopup' });

          const rawId = feature.id ?? p.OBJECTID ?? p.GlobalID ?? p.FIRE_ID ?? Math.random();
          const id = String(rawId);
          fireStore.set(id, { id, props: p, latlng: layer.getLatLng(), layer });

          // hover/click behavior
          let clicked = false, openT = null, closeT = null;
          const OPEN = 150, CLOSE = 60;
          const clear = () => { if (openT){clearTimeout(openT); openT=null;} if (closeT){clearTimeout(closeT); closeT=null;} };

          layer.on('mouseover', function () { if (clicked) return; clearTimeout(closeT);
            if (!openT) openT = setTimeout(() => { openT=null; this.openPopup(); }, OPEN); });
          layer.on('mouseout',  function () { if (clicked) return; clearTimeout(openT);
            if (!closeT) closeT = setTimeout(() => { closeT=null; this.closePopup(); }, CLOSE); });
          layer.on('click',    function () { clicked = !clicked; clear(); clicked ? this.openPopup() : this.closePopup(); });
          layer.on('remove', clear);
        }

        function makeStatusLayer(def) {
          const lyr = L.esri.featureLayer({
            url: 'https://gis-erd-der.gnb.ca/arcgis/rest/services/Fire_Dashboards/Public_Fires/MapServer/0',
            where: def.where,
            pane: 'firesPane',
            refreshInterval: 30,
            pointToLayer: (f, latlng) => L.marker(latlng, { icon: fireBadgeIcon(f.properties?.FIRE_STAT_DESC_E) }),
            onEachFeature: bindFireFeature
          }).addTo(map); // ON by default
          // keep fireStore tidy when features disappear
          lyr.on('removefeature', (e) => {
            const p = (e.feature && e.feature.properties) || {};
            const id = String(e.feature && (e.feature.id ?? p.OBJECTID ?? p.GlobalID ?? p.FIRE_ID));
            fireStore.delete(id);
          });
          return lyr;
        }

        const fireStatusLayers = {};
        statusDefs.forEach(d => { fireStatusLayers[d.label] = makeStatusLayer(d); });

        /* ---------- MODIS hotspots (48h ON, 7d OFF by default) ---------- */
        const modis48 = L.esri.featureLayer({
          url: 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/MODIS_Thermal_v1/FeatureServer/0',
          pane: 'viirsPane', refreshInterval: 1,
          pointToLayer: (_f, latlng) => L.circleMarker(latlng, { radius: 5, color: 'var(--modis)', fillColor: 'var(--modis)', fillOpacity: 0.9 })
        }).addTo(map);

        const modis7d = L.esri.featureLayer({
          url: 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/MODIS_Thermal_v1/FeatureServer/1',
          pane: 'viirsPane', refreshInterval: 1,
          pointToLayer: (_f, latlng) => L.circleMarker(latlng, { radius: 4, color: 'var(--modis)', fillColor: 'var(--modis)', fillOpacity: 0.65 })
        }); // NOTE: not added to map (OFF by default)

        /* ---------- Other operational layers ---------- */
        const PERIMETER_COLOR = cssVal('--perimeter');

        const perimeterLabelLayers = new Set();

        const activefires = L.esri.featureLayer({
          url: 'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Active_Wildfire_Perimeters_in_Canada_View/FeatureServer/0',
          pane: 'perimetersPane', refreshInterval: 1,
          style: () => ({ color: PERIMETER_COLOR, weight: 1.2, fillOpacity: 0.18 }),
          onEachFeature: (feature, layer) => {
            const ha = feature?.properties?.AREA;
            layer.bindTooltip(
              `<span class="perimeter-label" style="color:${PERIMETER_COLOR}">${num(ha,1)} ha</span>`,
              { permanent: true, className: 'perimeter-label-tooltip', direction: 'center', opacity: 0 }
            );
            perimeterLabelLayers.add(layer);
          }
        }).addTo(map);

        const setPerimeterLabels = () => {
          const show = map.getZoom() >= 11;
          perimeterLabelLayers.forEach((l) => l.getTooltip()?.setOpacity(show ? 1 : 0));
        };
        activefires.on('load', setPerimeterLabels);
        map.on('zoomend', setPerimeterLabels);

        const nbCrownLands = L.esri.featureLayer({
          url: 'https://gis-erd-der.gnb.ca/server/rest/services/OpenData/Crown_Lands/FeatureServer/0',
          pane: 'perimetersPane', style: () => ({ color: '#a855f7', weight: 1, fillOpacity: 0.18 })
        });

        map.on('zoomend', () => { if (map.getZoom() < 10 && map.hasLayer(nbCrownLands)) map.removeLayer(nbCrownLands); });

        const nbBurnBans = L.esri.dynamicMapLayer({
          url: 'https://gis-erd-der.gnb.ca/gisserver/rest/services/FireWeather/BurnCategories/MapServer',
          opacity: 0.7, refreshInterval: 30, pane: 'perimetersPane'
        });

        const weatherStations = L.esri.featureLayer({
          url: 'https://services.arcgis.com/zmLUiqh7X11gGV2d/ArcGIS/rest/services/EnvironmentCanada/FeatureServer/0',
          pane: 'weatherPane', refreshInterval: 1,
          pointToLayer: (feature, latlng) => {
            const p = feature.properties || {};
            const windDir = Number(p.WindDirection) || 0;
            const windSpeed = Number(p.WindSpeed_kmh);
            const temp = p.Temperature_C, humidity = p.Humidity_Percent;

            const clamped = Math.max(0, Math.min(80, isFinite(windSpeed) ? windSpeed : 0));
            const duration = Math.max(0.6, 3.5 - clamped * 0.035).toFixed(2);

            const icon = L.divIcon({
              className: 'weather-arrow-icon',
              html: `
                <div style="display:flex;flex-direction:column;align-items:center;">
                  <div style="position:relative; display:block; transform:rotate(${windDir}deg); filter:drop-shadow(0 2px 2px rgba(0,0,0,.25));">
                    <svg width="38" height="38" aria-hidden="true">
                      <polygon points="19,4 30,30 19,24 8,30" style="fill:#cbd5e1;stroke:#111827;stroke-width:2"/>
                    </svg>
                    <div class="wind-dots" style="--spd:${duration}s">
                      <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                  </div>
                  <div style="font-size:12px;font-weight:800;color:var(--text);background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:4px 8px;line-height:1.15;text-align:center;box-shadow:var(--shadow-soft)">
                    ${isFinite(windSpeed) ? `${windSpeed}<span style="font-size:10px;"> km/h</span>` : ''}<br />
                    ${temp != null ? `${temp}<span style="font-size:10px;">°C</span>` : ''}<br />
                    ${humidity != null ? `${humidity}<span style="font-size:10px;">%</span>` : ''}
                  </div>
                </div>`,
              iconSize: [38, 58], iconAnchor: [19, 34]
            });
            return L.marker(latlng, { icon });
          }
        }).addTo(map);

        // Cities (labels only)
        const cityMarkers = L.layerGroup(
          [
            ['Fredericton',45.9636,-66.6431],['Saint John',45.2733,-66.0633],['Moncton',46.0878,-64.7782],
            ['Bathurst',47.6186,-65.6517],['Miramichi',47.0281,-65.5019],['Edmundston',47.3730,-68.3251],
            ['Campbellton',48.0075,-66.6731],['Dieppe',46.0842,-64.6877],['Riverview',46.0617,-64.8052],
            ['Quispamsis',45.4319,-65.9469],['Oromocto',45.8491,-66.4828],['Woodstock',46.1527,-67.6016],
            ['Grand Falls',47.0469,-67.7394],['Shediac',46.2197,-64.5403],['Tracadie',47.5081,-64.9117],
            ['St. Stephen',45.1942,-67.2756],['Shippagan',47.7400,-64.7078],['Caraquet',47.7943,-64.9386],
            ['Bouctouche',46.4711,-64.7400],['Sussex',45.7221,-65.5060]
          ].map(([name, lat, lng]) =>
            L.marker([lat, lng], { icon: L.divIcon({ html: '', iconSize: [0, 0] }), interactive: false, zIndexOffset: 1000 })
             .bindTooltip(`<span class="city-label">${name}</span>`, { permanent: true, direction: 'top', className: 'city-label-tooltip' })
          )
        );

        // NB boundary
        L.esri.featureLayer({
          url: 'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Provinces_and_Territories_of_Canada/FeatureServer/0',
          where: "Name_EN = 'New Brunswick'",
          pane: 'nbBoundaryPane',
          style: () => ({ color: cssVal('--boundary'), weight: 5, fill: false }),
          interactive: false
        }).addTo(map);

        /* ---------- Planes (fetch only when visible) ---------- */
        const OPEN_SKY_URL = 'https://opensky-network.org/api/states/all';
        const WHITELIST_CALLSIGNS = window.WHITELIST_CALLSIGNS || new Set();
        const planesLayer = L.layerGroup();
        const planeMarkers = new Map();

        const makePlaneIcon = (heading, callsign) => {
          const ICON_OFFSET = -45;
          const wl = (window.WHITELIST_CALLSIGNS || new Set()).has(callsign);
          const baseShadow = 'drop-shadow(0 2px 2px rgba(0,0,0,.25))';
          const filterChain = wl ? `hue-rotate(-90deg) saturate(5) ${baseShadow}` : baseShadow;
          const rotate = Number.isFinite(heading) ? heading : 0;

        return L.divIcon({
            className: 'plane-div-icon',
            html: `<div style="transform:rotate(${ICON_OFFSET}deg);transform-origin:center;display:inline-block;">
                     <div style="transform:rotate(${rotate}deg);font-size:26px;filter:${filterChain}">✈️</div>
                   </div>`,
            iconSize: [30, 46], iconAnchor: [15, 23]
          });
        };

        const upsertPlane = (id, lat, lon, hdg, callsign, vel) => {
          let m = planeMarkers.get(id);
          const html = `<b>${callsign || 'Unknown'}</b><br>Heading: ${Number.isFinite(hdg)?Math.round(hdg):'—'}°<br>Speed: ${vel!=null?Math.round(vel*1.94384):'—'} kt`;
          if (!m) {
            m = L.marker([lat, lon], { icon: makePlaneIcon(hdg, callsign), pane: 'planesPane', keyboard: false, zIndexOffset: 10000 })
                  .bindPopup(html, { pane: 'alwaysOnTopPopup' });
            let clicked = false;
            m.on('mouseover', function(){ if(!clicked) this.openPopup(); });
            m.on('mouseout',  function(){ if(!clicked) this.closePopup(); });
            m.on('click',     function(){ clicked=!clicked; clicked?this.openPopup():this.closePopup(); });
            m.addTo(planesLayer);
            planeMarkers.set(id, m);
          } else {
            m.setLatLng([lat, lon]); m.setIcon(makePlaneIcon(hdg, callsign)); m.setPopupContent(html);
          }
        };

        const pruneMissing = (seen) => {
          for (const [k, m] of planeMarkers.entries()) {
            if (!seen.has(k)) { planesLayer.removeLayer(m); planeMarkers.delete(k); }
          }
        };

        async function fetchOpenSky() {
          try {
            const [lamin,lomin] = NB_BOUNDS[0];
            const [lamax,lomax] = NB_BOUNDS[1];
            const r = await fetch(`${OPEN_SKY_URL}?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`);
            if (!r.ok) throw new Error(r.statusText);
            const data = await r.json();
            const states = Array.isArray(data.states) ? data.states : [];
            const seen = new Set();
            for (const s of states) {
              const icao24 = s[0], callsign = (s[1] || '').trim().toUpperCase(), lon = s[5], lat = s[6], vel = s[9], hdg = s[10];
              if (!icao24 || lat == null || lon == null) continue;
              seen.add(icao24);
              upsertPlane(icao24, lat, lon, hdg, callsign, vel);
            }
            pruneMissing(seen);
          } catch (e) { console.warn('OpenSky fetch failed:', e); }
        }

        const OPEN_SKY_INTERVAL_MS = 250000;
        let planesTimer = null;
        planesLayer.on('add', () => { fetchOpenSky(); if (!planesTimer) planesTimer = setInterval(fetchOpenSky, OPEN_SKY_INTERVAL_MS); });
        planesLayer.on('remove', () => { if (planesTimer) { clearInterval(planesTimer); planesTimer = null; } });

        /* ---------- WMS + Smoke + AQHI ---------- */
        const fireRiskGroup = L.layerGroup().addLayer(L.tileLayer.wms(
          'https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms',
          { layers: 'public:fdr_current', format: 'image/png', transparent: true, version: '1.1.1', opacity: 0.4, refreshInterval: 1, pane: 'perimetersPane', attribution: 'CWFIS © Natural Resources Canada' }
        ));

        const smokeLayer = L.esri.imageMapLayer({
          url: 'https://enterpriseim.esriservices.ca/server/rest/services/Hosted/Aug12/ImageServer',
          opacity: 0.5, refreshInterval: 1, pane: 'sentinelPane'
        });

        const aqiLayer = L.esri.featureLayer({
          url: 'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/aqhi_stations_observations_realtime/FeatureServer/1',
          pane: 'aqiPane', refreshInterval: 1,
          pointToLayer: (feature, latlng) => {
            const p = feature.properties || {};
            const raw = p.aqhi ?? p.aqhi_round;
            const val = raw == null || Number.isNaN(Number(raw)) ? null : Number(raw);
            const { label, color } = aqhiCategory(val);
            const icon = L.divIcon({
              className: 'aqi-badge-icon',
              html: `
                <div style="display:flex;flex-direction:column;align-items:center;">
                  <svg width="26" height="26" viewBox="0 0 26 26" style="filter:drop-shadow(0 2px 2px rgba(0,0,0,.25));">
                    <circle cx="13" cy="13" r="11" stroke="#111827" stroke-width="2" fill="${color}" />
                  </svg>
                  <div style="margin-top:2px;font-size:12px;font-weight:800;color:var(--text);background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:4px 8px;line-height:1.15;text-align:center;box-shadow:var(--shadow-soft)">
                    AQHI ${val ?? '—'} <span style="opacity:.8">${label}</span>
                  </div>
                </div>`,
              iconSize: [28, 48], iconAnchor: [14, 24], popupAnchor: [0, -22]
            });
            const m = L.marker(latlng, { icon });
            const loc = p.location_name_en || '';
            const when = p.observation_datetime_text_en || '';
            m.bindTooltip(`${loc ? loc + ' — ' : ''}AQHI ${val ?? '—'} • ${label}${when ? ' • ' + when : ''}`, { direction: 'top', offset: [0, -20], opacity: 0 });
            return m;
          }
        });

        /* ---------- Weather radar + Lightning (OFF by default) ---------- */
        const noaaRadar = L.esri.imageMapLayer({
          url: 'https://mapservices.weather.noaa.gov/eventdriven/rest/services/radar/radar_base_reflectivity_time/ImageServer',
          opacity: 0.8, pane: 'radarPane', refreshInterval: 2
        });

        const lightningLayer = L.tileLayer.wms('https://geo.weather.gc.ca/geomet', {
          layers: 'Lightning_2.5km_Density', version: '1.3.0', format: 'image/png', transparent: true, opacity: 1, pane: 'lightningPane'
        });

        let lightningTimer = null;
        function startLightningRefresh(){ if (!lightningTimer) lightningTimer = setInterval(()=>{ lightningLayer.setParams({ _: Date.now() }); }, 120000); }
        function stopLightningRefresh(){ if (lightningTimer){ clearInterval(lightningTimer); lightningTimer = null; } }
        map.on('overlayadd', (e)=>{ if (e.layer === lightningLayer) startLightningRefresh(); });
        map.on('overlayremove', (e)=>{ if (e.layer === lightningLayer) stopLightningRefresh(); });

        /* ---------- Overlays + control ---------- */
        const overlays = {
          // split fire layers:
          ...fireStatusLayers,

          // MODIS hotspots (two separate toggles)
          'MODIS Hotspots — Last 48 hours': modis48,
          'MODIS Hotspots — Last 7 days': modis7d,

          'Weather Stations': weatherStations,
          'Fire Perimeters': activefires,
          Aircraft: planesLayer,
          'Major Cities & Towns': cityMarkers,
          'NB Burn Bans': nbBurnBans,
          'AQHI Risk': aqiLayer,
          'Weather Radar': noaaRadar,
          'Lightning Density': lightningLayer,
          Smoke: smokeLayer,
          'Fire Risk': fireRiskGroup,
          'Sentinel-2C Imagery': sentinel2c
        };

        L.control.layers(null, overlays, { collapsed: false }).addTo(map);

        /* ---------- Legend makeover (updated for split layers + MODIS) ---------- */
        function decorateLayersControl() {
          const list = document.querySelector('.leaflet-control-layers-overlays');
          if (!list) return;
          list.querySelectorAll('.icons-pack,.legend-sub').forEach((el)=>el.remove());

          const packs = {
            'MODIS Hotspots — Last 48 hours':'<span class="icons-pack"><span class="legend-modis-dot"></span></span>',
            'MODIS Hotspots — Last 7 days':'<span class="icons-pack"><span class="legend-modis-dot"></span></span>',
            'Weather Stations':'<span class="icons-pack"><i class="fa-solid fa-location-arrow legend-icon" style="transform:rotate(45deg)"></i></span>',
            'Fire Perimeters':'<span class="icons-pack"><i class="fa-regular fa-square legend-icon"></i></span>',
            Aircraft:'<span class="icons-pack"><span style="font-size:14px;display:inline-block;transform:rotate(-45deg)">✈️</span></span>',
            'Major Cities & Towns':'<span class="icons-pack"><i class="fa-solid fa-city legend-icon"></i></span>',
            'NB Crown Lands':'<span class="icons-pack"><i class="fa-solid fa-tree legend-icon"></i></span>',
            'NB Burn Bans':'<span class="icons-pack"><i class="fa-solid fa-ban legend-icon"></i></span>',
            'AQHI Risk':'<span class="icons-pack"><i class="fa-solid fa-wind legend-icon"></i></span>',
            'Weather Radar':'<span class="icons-pack"><i class="fa-solid fa-broadcast-tower legend-icon"></i></span>',
            'Lightning Density':'<span class="icons-pack"><i class="fa-solid fa-bolt legend-icon"></i></span>',
            Smoke:'<span class="icons-pack"><i class="fa-solid fa-smog legend-icon"></i></span>',
            'Fire Risk':'<span class="icons-pack"><i class="fa-solid fa-fire-extinguisher legend-icon"></i></span>',
            'Sentinel-2C Imagery':'<span class="icons-pack"><i class="fa-regular fa-image legend-icon"></i></span>'
          };

          // per-status fire icons (match map symbol: ringed fire badge)
          const statusIconHTML = (varName) => `
            <span class="icons-pack">
              <span class="legend-badge" style="--ring:${cssVal(varName)}">
                <i class="fa-solid fa-fire"></i>
              </span>
            </span>`;
          packs['Fires — Out of Control']  = statusIconHTML('--oc');
          packs['Fires — Contained']       = statusIconHTML('--cont');
          packs['Fires — Under Control']   = statusIconHTML('--uc');
          packs['Fires — Being Patrolled'] = statusIconHTML('--pat');

          list.querySelectorAll('label').forEach((label) => {
            const textSpan = Array.from(label.querySelectorAll('span')).find((s)=>s.textContent.trim());
            if (!textSpan) return;
            const name = textSpan.textContent.trim();
            label.insertAdjacentHTML('afterbegin', packs[name] || `<span class="icons-pack"><i class="fa-solid fa-layer-group legend-icon"></i></span>`);
            textSpan.classList.add('text');

            // Add a four-row sublegend only under the first fire-status group (optional)
            
          });
        }
        decorateLayersControl();
        document.querySelector('.leaflet-control-layers')?.addEventListener('click', ()=>queueMicrotask(decorateLayersControl));

        /* ---------- UI: hide/show panel + reset ---------- */
        const setMapUIHidden = (hidden) => {
          const mapDiv = document.querySelector('#map');
          const btn = document.querySelector('#mapToggleBtn');
          mapDiv.classList.toggle('map-ui-hidden', hidden);
          btn.querySelector('span:last-child').textContent = hidden ? 'Show Layers' : 'Hide Layers';
          btn.setAttribute('aria-pressed', String(!hidden));
        };
        setMapUIHidden(isMobile());

        document.querySelector('#mapToggleBtn').addEventListener('click', () =>
          setMapUIHidden(!document.querySelector('#map').classList.contains('map-ui-hidden'))
        );

        document.querySelector('#resetViewBtn').addEventListener('click', () => {
          map.setView(INITIAL_VIEW.center, INITIAL_VIEW.zoom);
          localStorage.removeItem(LS_KEY);
        });

        /* ---------- Fire Summary ---------- */
        const overlay = document.querySelector('#fireSummaryOverlay');
        const bodyEl = document.querySelector('#fs-body');
        const chip = (label, n) => `<span class="chip"><span class="dot" style="background:${fireStatusColor(label)}"></span>${label} <span style="font-weight:800;margin-left:6px">${n}</span></span>`;

        function buildSummaryHTML() {
          const items = [...fireStore.values()];
          let totalArea = 0;
          const counts = { 'out of control':0, contained:0, 'under control':0, 'being patrolled':0, other:0 };
          let newToday = 0, newYesterday = 0;

          for (const it of items) {
            const p = it.props || {};
            const sz = +p.FIRE_SIZE; if (isFinite(sz)) totalArea += sz;
            const key = norm(p.FIRE_STAT_DESC_E); counts.hasOwnProperty(key) ? counts[key]++ : counts.other++;
            const det = p.TIME_DETECTED != null ? +p.TIME_DETECTED : null;
            if (det != null) { if (isToday(det)) newToday++; else if (isYesterday(det)) newYesterday++; }
          }

          const chips = [
            ['Out of Control', counts['out of control']],
            ['Contained', counts['contained']],
            ['Under Control', counts['under control']],
            ['Being Patrolled', counts['being patrolled']]
          ].map(([l,n])=>chip(l,n)).join('');

          const sorted = items.slice().sort((a,b)=>(+b.props.FIRE_SIZE||0) - (+a.props.FIRE_SIZE||0));
          const list = sorted.map((it)=> {
            const p = it.props || {};
            return `<li style="margin:4px 0;">
              <a href="#" data-fireid="${it.id}">
                <span style="font-weight:700">${p.FIRE_NAME || 'Unnamed Fire'}</span>
                &nbsp;—&nbsp;${num(p.FIRE_SIZE, 0)} ha
                <span style="opacity:.8">• ${p.FIRE_STAT_DESC_E || '—'}</span>
                <span style="opacity:.8">• Detected: ${fmtDate(p.TIME_DETECTED)}</span>
              </a>
            </li>`;
          }).join('') || '<li>No active fires</li>';

          return `
            <div class="fs-meta-row">
              <div>New fires today: ${num(newToday, 0)}</div>
              <div>New fires yesterday: ${num(newYesterday, 0)}</div>
              <div>Total area burned: ${num(totalArea, 0)} ha</div>
            </div>
            <div style="margin:8px 0 6px"><b>Fires by status</b></div>
            <div>${chips}</div>
            <div style="margin-top:10px">
              <b>All active fires <span style="font-weight:600;color:var(--muted)">(largest → smallest)</span></b>
              <ol class="summary-list fs-scroll" id="fs-all">${list}</ol>
            </div>
            <div style="margin-top:10px;font-size:12px;color:var(--muted)">
              “Today / yesterday” uses Atlantic Time (TIME_DETECTED). Source: NB Active Fires (Public_Fires/MapServer/0).
            </div>`;
        }

        const openSummary = () => {
          bodyEl.innerHTML = buildSummaryHTML();
          overlay.hidden = false; overlay.style.display = 'flex';
          document.querySelector('#fs-all')?.addEventListener('click', (e) => {
            const a = e.target.closest('a[data-fireid]'); if (!a) return;
            e.preventDefault();
            const rec = fireStore.get(a.getAttribute('data-fireid')); if (!rec) return;
            overlay.style.display = 'none'; overlay.hidden = true;
            map.flyTo(rec.latlng, Math.max(map.getZoom(), 12), { duration: 0.6 });
            map.once('moveend', () => rec.layer?.openPopup && rec.layer.openPopup());
          }, { once: true });
        };
        document.querySelector('#fireSummaryBtn').addEventListener('click', openSummary);
        document.querySelector('#fs-close').addEventListener('click', () => { overlay.style.display = 'none'; overlay.hidden = true; });
        overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlay.style.display = 'none'; overlay.hidden = true; } });
      });
    </script>
  </body>
</html>

