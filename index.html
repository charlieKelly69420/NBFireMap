<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>New Brunswick Wildfire Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light" />

    <!-- Fonts / Leaflet / Plugins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <!-- Leaflet markercluster (CSS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

    <style>
      :root{
        color-scheme: light;
        --bg:#f7f8fc; --text:#0f172a; --muted:#5b6474;
        --panel:rgba(255,255,255,.85); --panel-strong:#fff; --border:#e6eaf1;
        --radius:14px; --radius-sm:10px;
        --shadow:0 10px 30px rgba(2,8,20,.08); --shadow-soft:0 6px 16px rgba(2,8,20,.06);
        --btn-bg:#fff; --btn-border:#d9dee6; --btn-hover:#f2f4f7;
        --link:#2563eb; --focus:0 0 0 3px rgba(37,99,235,.28);
        --oc:#ef4444; --cont:#fb923c; --uc:#facc15; --pat:#22c55e; --mon:#3b82f6;
        --modis:#f59e0b; --perimeter:#ef4444; --boundary:#0b0f19;
        --fs-12:12px; --fs-14:14px; --fs-16:16px; --fs-18:18px;
      }

      html,body,#map{height:100%;margin:0}
      body{background:var(--bg);color:var(--text);font:var(--fs-14)/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;letter-spacing:.1px;
        -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

      /* Leaflet controls */
      .leaflet-bar a,.leaflet-bar a:hover{background:var(--panel);border:1px solid var(--border);color:var(--text);box-shadow:var(--shadow-soft)}
      .leaflet-bar a{width:34px;height:34px;line-height:34px;font-size:16px}
      .leaflet-control-attribution{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow-soft);padding:4px 8px}
      .leaflet-top.leaflet-left{top:52px!important}
      .leaflet-top.leaflet-right{top:72px!important}

      /* Layers panel */
      .leaflet-control-layers{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
        font-size:var(--fs-14);padding:8px 40px 8px 14px;backdrop-filter:blur(6px);min-width:260px;white-space:nowrap}
      .leaflet-control-layers-expanded,.leaflet-control-layers-list{max-height:none!important;overflow:visible!important}
      .leaflet-control-layers-overlays label{display:grid;grid-template-columns:18px 26px 1fr;align-items:center;column-gap:8px;min-width:max-content;line-height:1.25}
      .leaflet-control-layers-overlays input{margin:0;width:max-content;height:18px}
      .leaflet-control-layers-overlays .text{min-width:max-content;white-space:nowrap;overflow:visible;text-overflow:clip}

      @media (max-width: 640px) {
        .leaflet-control-layers { width: var(--layers-w, auto); max-width: calc(100vw - 24px); min-width: 0 !important; white-space: nowrap; overflow-x: auto; }
        .leaflet-control-layers-overlays label { grid-template-columns: 18px 26px auto; }
        .leaflet-control-layers-overlays .text { white-space: nowrap; min-width: max-content; }
      }
      @media (max-width:767.98px){.leaflet-control-layers{font-size:var(--fs-12)}}

      /* Buttons */
      .map-btn{position:absolute;z-index:1001;background:var(--btn-bg);border:1px solid var(--btn-border);border-radius:999px;padding:10px 14px;
        font-size:var(--fs-14);font-weight:700;color:var(--text);cursor:pointer;box-shadow:var(--shadow);display:inline-flex;align-items:center;gap:8px;
        transition:background .2s,transform .06s,box-shadow .2s}
      .map-btn:hover{background:var(--btn-hover);box-shadow:0 8px 22px rgba(0,0,0,.08)}
      .map-btn:active{transform:translateY(1px)}
      .map-btn:focus-visible{outline:none;box-shadow:var(--focus)}
      .map-toggle-btn{top:12px;right:12px}
      .reset-view-btn{top:12px;left:12px;z-index:1002}
      .map-btn .icon{width:18px;height:18px;display:inline-grid;place-items:center}
      .map-ui-hidden .leaflet-control-layers{opacity:0;pointer-events:none}

      /* Labels */
      .city-label-tooltip,.perimeter-label-tooltip{background:none!important;border:none!important;box-shadow:none!important;padding:0!important}
      .city-label{font-size:15px;font-weight:800;color:#fff;text-shadow:0 0 2px rgba(0,0,0,.7),0 0 8px rgba(0,0,0,.6),1px 1px 0 rgba(0,0,0,.9)}
      .perimeter-label{font-size:12px;font-weight:800;pointer-events:none;padding:2px 6px;border-radius:6px;background:rgba(239,68,68,.12);backdrop-filter:blur(2px)}

      /* Summary modal (make whole panel scrollable on small screens) */
      .fire-summary-btn{position:fixed;left:12px;bottom:86px;z-index:2001}
      .fire-summary-overlay{position:fixed;inset:0;display:none;align-items:start;justify-content:center;z-index:3000;background:rgba(0,0,0,.25);backdrop-filter:blur(2px)}
      .fire-summary{margin-top:16px;background:var(--panel-strong);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);width:min(680px,calc(100% - 24px));color:var(--text);
        max-height:90vh; display:flex; flex-direction:column; overflow:hidden;}
      .fire-summary header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 8px; flex:0 0 auto;}
      .fire-summary h2{font-size:var(--fs-18);font-weight:800;margin:0}
      .fire-summary .body{padding:0 16px 16px;line-height:1.5; overflow:auto; flex:1 1 auto; min-height:0;}
      .close-summary{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--text);border-radius:var(--radius-sm);padding:8px 12px;cursor:pointer;font-weight:700;box-shadow:var(--shadow-soft)}
      .close-summary:hover{background:var(--btn-hover)}
      .close-summary:focus-visible{outline:none;box-shadow:var(--focus)}
      .chip{display:inline-flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:0 8px 8px 0;font-weight:700;box-shadow:var(--shadow-soft)}
      .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
      .summary-list{margin:8px 0 0;padding-left:12px;list-style:decimal;list-style-position:inside}
      .summary-list a{color:var(--link);text-decoration:none;font-weight:700}
      .summary-list a:hover{text-decoration:underline}
      .fs-scroll{margin-top:8px;border:1px solid var(--border);border-radius:12px;padding:8px;background:var(--panel)}
      .fs-meta-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:10px 0}
      .stat{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:var(--shadow-soft)}
      .stat .h{font:800 13px/1.2 Inter,system-ui,Arial;color:var(--muted);text-transform:uppercase;letter-spacing:.02em;margin-bottom:4px}
      .stat .v{font:800 18px/1.15 Inter,system-ui,Arial}
      @media (max-width: 520px){ .fs-meta-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }

      /* Legend icons */
      .marker-badge{width:38px;height:38px;border-radius:999px;display:grid;place-items:center;background:var(--panel-strong);border:2.5px solid var(--ring,#9aa0a6);box-shadow:0 2px 10px rgba(0,0,0,.18)}
      .marker-badge i{font-size:18px;color:var(--ring,#9aa0a6)}
      .legend-icon{width:18px;height:18px;display:inline-grid;place-items:center}
      .icons-pack{display:inline-flex;gap:6px;vertical-align:middle;justify-content:center;width:26px}
      .legend-badge{width:18px;height:18px;border-radius:999px;display:grid;place-items:center;background:#fff;border:2.5px solid var(--ring)}
      .legend-badge i{font-size:11px;color:var(--ring)}
      .legend-modis-dot{width:10px;height:10px;border-radius:999px;background:var(--modis);display:inline-block;box-shadow:0 0 0 1.5px #111827 inset}

      /* Footer */
      .nb-footer{position:fixed;bottom:10px;left:0;width:100%;text-align:center;z-index:2000}
      .nb-footer a{background:var(--btn-bg);border:1px solid var(--btn-border);border-radius:12px;padding:10px 18px;box-shadow:var(--shadow);color:var(--link);font-weight:800;text-decoration:none;display:inline-flex;align-items:center;gap:10px}

      /* Weather-station text */
      .ws-svg text{fill:#fff;stroke:rgba(0,0,0,.45);stroke-width:.9px;paint-order:stroke;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
      .ws-speed{font-weight:800;font-size:14px}
      .ws-small{font-weight:700;font-size:10px;opacity:.95}

      /* Soft “data may be unavailable” modal */
      .service-alert-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:4000;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
      .service-alert{background:var(--panel-strong);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);width:min(560px,calc(100% - 24px));color:var(--text)}
      .service-alert header{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border)}
      .service-alert h2{font-size:var(--fs-18);font-weight:800;margin:0}
      .service-alert .body{padding:14px 16px;line-height:1.55}
      .service-alert .footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
      .service-btn{background:var(--btn-bg);border:1px solid var(--btn-border);color:var(--text);border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:800;box-shadow:var(--shadow-soft)}
      .service-btn:hover{background:var(--btn-hover)}

      /* Fire status filter */
      .fire-filter-block{ margin:8px 0 6px; padding:6px 0 2px 0; }
      .fire-filter-title{ margin:0 0 4px; font:800 12px/1.1 Inter,system-ui,Arial; color:var(--muted); letter-spacing:.02em; text-transform:uppercase; }
      .fire-filter-row{ display:grid; grid-template-columns:18px 26px auto; align-items:center; column-gap:8px; margin:4px 0; }
      .fire-filter-row .legend-badge{ width:18px; height:18px; }
      .fire-filter-row .legend-badge i{ font-size:11px; }
    </style>
  </head>
  <body>
    <div id="map" aria-label="Interactive wildfire map"></div>

    <button id="mapToggleBtn" class="map-btn map-toggle-btn" type="button" aria-pressed="false" title="Show/Hide layers">
      <span class="icon"><i class="fa-solid fa-layer-group"></i></span><span id="mtb-text">Show Layers</span>
    </button>
    <button id="resetViewBtn" class="map-btn reset-view-btn" type="button" title="Reset map view">
      <span class="icon"><i class="fa-solid fa-compass"></i></span><span>Reset Map View</span>
    </button>
    <button id="fireSummaryBtn" class="map-btn fire-summary-btn" type="button" title="Open summary">
      <span class="icon"><i class="fa-solid fa-fire"></i></span><span>Fire Summary</span>
    </button>

    <div id="fireSummaryOverlay" class="fire-summary-overlay" role="presentation" hidden>
      <div class="fire-summary" role="dialog" aria-modal="true" aria-labelledby="fs-title">
        <header>
          <h2 id="fs-title">New Brunswick Fire Summary</h2>
          <button id="fs-close" class="close-summary" type="button"><span class="icon"><i class="fa-solid fa-xmark"></i></span> Close</button>
        </header>
        <div id="fs-body" class="body"></div>
      </div>
    </div>

    <!-- Soft “data may be unavailable” modal -->
    <div id="serviceAlertOverlay" class="service-alert-overlay" role="presentation" hidden>
      <div class="service-alert" role="dialog" aria-modal="true" aria-labelledby="svc-title">
        <header>
          <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
          <h2 id="svc-title">Data May Be Unavailable</h2>
        </header>
        <div id="svc-body" class="body">
          <p>We couldn’t load one of the layers.</p>
          <p>Please try refreshing the page later.</p>
        </div>
        <div class="footer">
          <button id="svc-ack" class="service-btn" type="button">OK</button>
        </div>
      </div>
    </div>

    <div class="nb-footer">
      <a href="https://www.gnb.ca/en/topic/laws-safety/emergency-preparedness-alerts/fire-watch.html" target="_blank" rel="noopener">
        <i class="fa-solid fa-up-right-from-square"></i> NB Fire Watch &amp; Burn Restrictions
      </a>
    </div>

    <!-- JS (deferred) -->
    <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script defer src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
    <script defer src="https://unpkg.com/esri-leaflet-image/dist/esri-leaflet-image.js"></script>
    <script defer src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script defer src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <!-- needed for clustered Esri feature layers (weather) -->
    <script defer src="https://unpkg.com/esri-leaflet-cluster/dist/esri-leaflet-cluster.js"></script>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        'use strict';

        /* ====================== Config ====================== */
        const LS_KEY = 'nbMapView';
        const INITIAL_VIEW = { center: [46.7, -66.2], zoom: 7 };
        const ATLANTIC_TZ = 'America/Moncton';
        const LIGHTNING_REFRESH_MS = 120_000;

        /* ====================== Utilities ====================== */
        const isMobile = () => innerWidth < 768;
        const cssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        const norm = (s) => (s || '').toString().trim().toLowerCase();
        const toNum = (v, d = 1) => (v == null || Number.isNaN(Number(v))) ? '—' : Number(v).toLocaleString(undefined, { maximumFractionDigits: d });
        const fmtDateTime = (ms) => ms == null ? '—' : new Date(+ms).toLocaleString(undefined, { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        const fmtDateTZ = (ms, tz = ATLANTIC_TZ) => ms == null ? '—' : new Date(+ms).toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: tz });

        const statusColor = (s) => ({
          'out of control': cssVar('--oc'),
          contained: cssVar('--cont'),
          'under control': cssVar('--uc'),
          'being patrolled': cssVar('--pat'),
          'being monitored': cssVar('--mon'),
          extinguished: '#9aa0a6'
        }[norm(s)] || '#9aa0a6');

        const severityRank = (s) => ({
          'out of control': 3,
          contained: 2,
          'under control': 1,
          'being patrolled': 0,
          'being monitored': 0,
          extinguished: -1
        }[norm(s)] ?? -1);

        // date helpers (today/yesterday in Atlantic)
        const ymdInTz = (ms, tz = ATLANTIC_TZ) => {
          const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' });
          const parts = fmt.formatToParts(new Date(ms));
          const grab = (k) => +parts.find((p) => p.type === k)?.value;
          return { y: grab('year'), m: grab('month'), d: grab('day') };
        };
        const sameYMD = (a, b, tz) => { if (a == null || b == null) return false; const A = ymdInTz(a, tz); const B = ymdInTz(b, tz); return A.y===B.y && A.m===B.m && A.d===B.d; };
        const yesterdayUTCms = (tz = ATLANTIC_TZ) => { const t = ymdInTz(Date.now(), tz); return Date.UTC(t.y, t.m - 1, t.d) - 86_400_000; };
        const isToday = (ms) => sameYMD(ms, Date.now(), ATLANTIC_TZ);
        const isYesterday = (ms) => sameYMD(ms, yesterdayUTCms(ATLANTIC_TZ), ATLANTIC_TZ);
        const getExtinguishedMs = (p) => { for (const k of ['FIRE_OUT_DATE','OUT_DATE','DATE_OUT','DATE_EXTINGUISHED','OUT_TIME','EXTINGUISHED','FIRE_STAT_DATE']) { const v=p?.[k]; if(v==null) continue; const n=+v; if(Number.isFinite(n)) return n; const t=Date.parse(v); if(!Number.isNaN(t)) return t; } return null; };
        const getDetectedMs = (p) => { for (const k of ['TIME_DETECTED','DATE_DETECTED','DETECTED','FIRE_START_DATE','START_DATE']) { const v=p?.[k]; if(v==null) continue; const n=+v; if(Number.isFinite(n)) return n; const t=Date.parse(v); if(!Number.isNaN(t)) return t; } return null; };

        /* ====================== Map init ====================== */
        const restored = (() => { try { return JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch { return null; } })();
        const map = L.map('map', { center: restored?.center || INITIAL_VIEW.center, zoom: restored?.zoom || INITIAL_VIEW.zoom });

        map.on('moveend', () => {
          const c = map.getCenter();
          localStorage.setItem(LS_KEY, JSON.stringify({ center: [c.lat, c.lng], zoom: map.getZoom() }));
        });

        // Panes
        [['alwaysOnTopPopup',9999],['sentinelPane',400],['nbBoundaryPane',405],['perimetersPane',412],['radarPane',413],['lightningPane',413],['viirsPane',414],['weatherPane',415],['aqiPane',416],['firesPane',420]]
          .forEach(([name, z]) => { const p = map.createPane(name); p.style.zIndex = z; });

        L.esri.basemapLayer('Imagery').addTo(map);

        if (isMobile()) {
          L.control.locate({
            position: 'topleft', flyTo: true, showPopup: false, keepCurrentZoomLevel: true,
            icon: 'fa fa-location-crosshairs', strings: { title: 'Show me where I am' }
          }).addTo(map);
        }

        /* ====================== Fires: GeoJSON-only + clustering + status checkboxes ====================== */
        const fireStore = new Map(); // id -> { id, props, latlng, layer, statusKey }
        const fireClusters = L.markerClusterGroup({
          disableClusteringAtZoom: 11,
          spiderfyOnMaxZoom: true,
          zoomToBoundsOnClick: true,
          showCoverageOnHover: false,
          iconCreateFunction:(cluster)=>{
            const markers = cluster.getAllChildMarkers();
            let worst = { sev:-2, key:'extinguished' };
            for(const m of markers){
              const k = m.options._statusKey || 'extinguished';
              const sev = Number.isFinite(m.options._severity) ? m.options._severity : severityRank(k);
              if(sev > worst.sev){ worst = { sev, key: k }; }
            }
            const ring = statusColor(worst.key);
            const count = cluster.getChildCount();
            return L.divIcon({
              className:'fire-cluster-icon',
              html: `
                <div style="position:relative;display:inline-grid;place-items:center">
                  <div class="marker-badge" style="--ring:${ring};width:42px;height:42px">
                    <i class="fa-solid fa-fire"></i>
                  </div>
                  <div style="position:absolute;bottom:-6px;right:-6px;background:var(--panel-strong);border:2px solid ${ring};border-radius:999px;
                              font:800 12px/1.1 Inter,system-ui,Arial;padding:4px 7px;box-shadow:0 2px 8px rgba(0,0,0,.18)">${count}</div>
                </div>`,
              iconSize:[42,42], iconAnchor:[21,28], popupAnchor:[0,-24]
            });
          },
          pane: 'firesPane'
        }).addTo(map);

        const activeMarkers = [];
        const outMarkers = [];

        function bindFireFeature(props, layer, explicitStatus) {
          const status = explicitStatus || props.FIRE_STAT_DESC_E || '—';
          const html = `
            <div style="font:14px/1.45 Inter,system-ui,Segoe UI,Arial;min-width:240px;color:var(--text)">
              <div style="font-weight:800;font-size:16px;margin-bottom:6px;letter-spacing:.2px">${props.FIRE_NAME || props.FIRE_ID || 'Unnamed Fire'}</div>
              <div style="margin:6px 0 10px">
                <span style="display:inline-flex;align-items:center;gap:8px;padding:5px 10px;border-radius:999px;background:var(--panel);border:1px solid var(--border);font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,.12)">
                  <span class="dot" style="background:${statusColor(status)}"></span>${status}
                </span>
              </div>
              <div><b>Area:</b> ${toNum(props.FIRE_SIZE ?? props.SIZE_HA ?? props.AREA,1)} ha</div>
              <div><b>Detected:</b> ${fmtDateTime(getDetectedMs(props))}</div>
              ${norm(status)==='extinguished'
                ? `<div><b>Extinguished:</b> ${fmtDateTime(getExtinguishedMs(props))}</div>`
                : `<div><b>Status updated:</b> ${fmtDateTime(props.FIRE_STAT_DATE)}</div>`}
            </div>`;
          layer.bindPopup(html,{maxWidth:340,pane:'alwaysOnTopPopup'});

          const rawId = props.GlobalID || props.OBJECTID || props.FIRE_ID || Math.random().toString(36).slice(2)+Date.now().toString(36);
          const id = String(rawId);
          fireStore.set(id,{ id, props, latlng: layer.getLatLng(), layer, statusKey: norm(status) });

          // hover/click UX
          let clicked=false, openT=null, closeT=null;
          const OPEN_MS=150, CLOSE_MS=60;
          const clearTimers=()=>{ if(openT){clearTimeout(openT);openT=null} if(closeT){clearTimeout(closeT);closeT=null} };
          layer.on('mouseover',function(){ if(clicked) return; if(closeT) clearTimeout(closeT);
            if(!openT){ openT=setTimeout(()=>{ openT=null; this.openPopup(); },OPEN_MS); }});
          layer.on('mouseout',function(){ if(clicked) return; if(openT) clearTimeout(openT);
            if(!closeT){ closeT=setTimeout(()=>{ closeT=null; this.closePopup(); },CLOSE_MS); }});
          layer.on('click',function(){ clicked=!clicked; clearTimers(); clicked?this.openPopup():this.closePopup(); });
          layer.on('remove', clearTimers);
        }

        function makeFireMarker(props, coords, explicitStatus){
          const [lng, lat] = coords; // GeoJSON order
          const statusKey = norm(explicitStatus || props.FIRE_STAT_DESC_E || '—');
          const marker = L.marker([lat, lng], {
            icon: L.divIcon({
              className:'fire-badge-icon',
              html:`<div class="marker-badge" style="--ring:${statusColor(statusKey)}"><i class="fa-solid fa-fire"></i></div>`,
              iconSize:[38,38],iconAnchor:[19,26],popupAnchor:[0,-22]
            }),
            keyboard:false
          });
          marker.options._statusKey = statusKey;
          marker.options._severity  = severityRank(statusKey);
          bindFireFeature(props, marker, explicitStatus);
          return marker;
        }

        async function fetchLocalAny(base){
          const attempts = [
            `${base}.json`, `${base}.geojson`,
            `./${base}.json`, `./${base}.geojson`,
            `data/${base}.json`, `data/${base}.geojson`,
            `./data/${base}.json`, `./data/${base}.geojson`,
          ];
          for (const url of attempts) {
            try { const r = await fetch(url, { cache:'no-store' }); if (r.ok) return await r.json(); } catch {}
          }
          throw new Error(`Could not load ${base} from any known path`);
        }

        async function loadLocalFires(){
          const [activeData, outData] = await Promise.all([
            fetchLocalAny('active_fires'),
            fetchLocalAny('out_fires')
          ]);

          (activeData.features||[]).forEach((f)=>{
            if (!f || f.geometry?.type !== 'Point') return;
            const m = makeFireMarker(f.properties||{}, f.geometry.coordinates, f.properties?.FIRE_STAT_DESC_E);
            activeMarkers.push(m);
            fireClusters.addLayer(m); // active visible on load
          });

          (outData.features||[]).forEach((f)=>{
            if (!f || f.geometry?.type !== 'Point') return;
            const m = makeFireMarker(f.properties||{}, f.geometry.coordinates, 'Extinguished');
            outMarkers.push(m);
            // not added yet; controlled by status checkbox (default OFF)
          });

          refreshSummary();
        }
        loadLocalFires().catch(err => console.warn(err));

        /* ====================== MODIS, Perimeters, NB boundary ====================== */
        const modis48 = L.esri.featureLayer({
          url:'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/MODIS_Thermal_v1/FeatureServer/0',
          pane:'viirsPane',
          pointToLayer:(_f,latlng)=>L.circleMarker(latlng,{radius:5,color:'var(--modis)',fillColor:'var(--modis)',fillOpacity:.9})
        }).addTo(map);

        const modis7d = L.esri.featureLayer({
          url:'https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/MODIS_Thermal_v1/FeatureServer/1',
          pane:'viirsPane',
          pointToLayer:(_f,latlng)=>L.circleMarker(latlng,{radius:4,color:'var(--modis)',fillColor:'var(--modis)',fillOpacity:.65})
        });

        const PERIMETER_COLOR = cssVar('--perimeter');
        const perimeterLabelLayers = new Set();

        const activefires = L.esri.featureLayer({
          url:'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Active_Wildfire_Perimeters_in_Canada_View/FeatureServer/0',
          pane:'perimetersPane',
          style:()=>({color:PERIMETER_COLOR,weight:1.2,fillOpacity:.18}),
          onEachFeature:(feature,layer)=>{
            const ha = feature?.properties?.AREA;
            layer.bindTooltip(
              `<span class="perimeter-label" style="color:${PERIMETER_COLOR}">${toNum(ha,1)} ha</span>`,
              {permanent:true,className:'perimeter-label-tooltip',direction:'center',opacity:0}
            );
            perimeterLabelLayers.add(layer);
          }
        }).addTo(map);

        const setPerimeterLabels = ()=> {
          const show = map.getZoom() >= 11;
          perimeterLabelLayers.forEach((l)=>l.getTooltip()?.setOpacity(show?1:0));
        };
        activefires.on('load', setPerimeterLabels);
        map.on('zoomend', setPerimeterLabels);

        const nbBoundary = L.esri.featureLayer({
          url:'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Provinces_and_Territories_of_Canada/FeatureServer/0',
          where:"Name_EN = 'New Brunswick'",
          pane:'nbBoundaryPane',
          style:()=>({color:cssVar('--boundary'),weight:5,fill:false}), interactive:false
        }).addTo(map);

        /* ====================== Weather (clustered), Radar, Lightning, AQHI ====================== */
        function stationPopupHTML(p) {
          const fromDeg = Number(p.WindDirection);
          const dirTxt = Number.isFinite(fromDeg)
            ? (() => { const d=((fromDeg%360)+360)%360; const dirs=['N','NNE','NE','ENE','E','ESE','SE','S','SSW','SW','WSW','W','WNW','NW','NNW','N']; return dirs[Math.round(d/22.5)]; })()
            : '—';
          const kmh = Number(p.WindSpeed_kmh);
          const temp = p.Temperature_C !== '' && p.Temperature_C != null ? Math.round(Number(p.Temperature_C)) : null;
          const hum  = p.Humidity_Percent !== '' && p.Humidity_Percent != null ? Math.round(Number(p.Humidity_Percent)) : null;
          const name = p.StationName || p.location_name_en || 'Weather station';
          const when = p.observation_datetime_text_en || '';
          return `
            <div style="min-width:240px">
              <div style="font-weight:800;margin-bottom:4px">${name}</div>
              <div><b>Wind:</b> ${Number.isFinite(kmh) ? kmh : '—'} km/h • From ${dirTxt}${Number.isFinite(fromDeg) ? ' ('+Math.round(fromDeg)+'°)' : ''}</div>
              <div><b>Temp:</b> ${temp != null ? temp + '°C' : '—'}${hum != null ? ' • ' + hum + '%' : ''}</div>
              ${when ? `<div style="opacity:.8">${when}</div>` : ''}
            </div>`;
        }
        function stationSVG(p, size=84){
          const fromDeg = Number(p.WindDirection);
          const toDeg = Number.isFinite(fromDeg) ? (fromDeg + 180) % 360 : 0;
          const kmh = Number(p.WindSpeed_kmh);
          const dirTxt = Number.isFinite(fromDeg)
            ? (() => { const d=((fromDeg%360)+360)%360; const dirs=['N','NNE','NE','ENE','E','ESE','SE','S','SSW','SW','WSW','W','WNW','NW','NNW','N']; return dirs[Math.round(d/22.5)]; })()
            : '—';
          const temp = p.Temperature_C !== '' && p.Temperature_C != null ? Math.round(Number(p.Temperature_C)) : null;
          const hum  = p.Humidity_Percent !== '' && p.Humidity_Percent != null ? Math.round(Number(p.Humidity_Percent)) : null;
          const arrowPathD = "M42 14 Q52 30 58 58 Q42 48 42 48 Q42 48 26 58 Q32 30 42 14 Z";
          const scale = size/84;
          return `
            <svg class="ws-svg" width="${84*scale}" height="${92*scale}" viewBox="0 0 84 92" aria-hidden="true" role="img"
                 style="position:relative; z-index:1; filter:drop-shadow(0 2px 2px rgba(0,0,0,.25))">
              <circle cx="42" cy="42" r="34" fill="#0b0f19" stroke="#ffffff" stroke-width="2.5"/>
              <g transform="rotate(${toDeg} 42 42)">
                <path d="${arrowPathD}" fill="#999999" stroke="#999999" stroke-width="1.8" stroke-linejoin="round"></path>
                <g transform="rotate(${-toDeg} 42 42)">
                  <text x="42" y="26" text-anchor="middle" class="ws-small">From ${dirTxt}</text>
                  <text x="42" y="42" text-anchor="middle" class="ws-speed">${Number.isFinite(kmh) ? kmh : '—'} km/h</text>
                  <text x="42" y="58" text-anchor="middle" class="ws-small">
                    ${temp != null ? temp + '°C' : '—'}${hum != null ? ' • ' + hum + '%' : ''}
                  </text>
                </g>
              </g>
            </svg>`;
        }
        function makeStationMarker(feature, latlng) {
          const p = feature.properties || {};
          const icon = L.divIcon({ className: 'ws-div', html: stationSVG(p, 84), iconSize: [84, 92], iconAnchor: [42, 54], popupAnchor: [0, -44] });
          const m = L.marker(latlng, { icon, pane: 'weatherPane' });
          m.options._stationProps = p;

          const fromDeg = Number(p.WindDirection);
          const dirTxt = Number.isFinite(fromDeg)
            ? (() => { const d=((fromDeg%360)+360)%360; const dirs=['N','NNE','NE','ENE','E','ESE','SE','S','SSW','SW','WSW','W','WNW','NW','NNW','N']; return dirs[Math.round(d/22.5)]; })()
            : '—';
          const kmh = Number(p.WindSpeed_kmh);
          const temp = p.Temperature_C !== '' && p.Temperature_C != null ? Math.round(Number(p.Temperature_C)) : null;
          const hum  = p.Humidity_Percent !== '' && p.Humidity_Percent != null ? Math.round(Number(p.Humidity_Percent)) : null;

          m.bindTooltip(
            `Wind: ${Number.isFinite(kmh) ? kmh : '—'} km/h • From ${dirTxt}${
              temp != null ? ' • ' + temp + '°C' : ''
            }${hum != null ? ' • ' + hum + '%' : ''}`,
            { direction: 'top', offset: [0, -36], opacity: 0 }
          );
          m.bindPopup(stationPopupHTML(p), { pane: 'alwaysOnTopPopup' });
          return m;
        }
        const weatherStations = L.esri.Cluster.featureLayer({
          url: 'https://services.arcgis.com/zmLUiqh7X11gGV2d/ArcGIS/rest/services/EnvironmentCanada/FeatureServer/0',
          pane: 'weatherPane',
          spiderfyOnMaxZoom: true,
          disableClusteringAtZoom: 10,
          zoomToBoundsOnClick: false,
          showCoverageOnHover: false,
          pointToLayer: makeStationMarker,
          // Make cluster icon show the nearest station symbol + count (like fires)
          iconCreateFunction: (cluster) => {
            const center = cluster.getLatLng();
            const markers = cluster.getAllChildMarkers();
            // pick the child whose marker is closest to cluster center
            let best = null, bestDist = Infinity;
            for (const m of markers) {
              const d = map.distance(center, m.getLatLng());
              if (d < bestDist) { bestDist = d; best = m; }
            }
            const p = best?.options?._stationProps || {};
            return L.divIcon({
              className: 'ws-cluster-icon',
              html: `
                <div style="position:relative;display:inline-grid;place-items:center">
                  ${stationSVG(p, 84)}
                  <div style="position:absolute;bottom:8px;right:8px;z-index:2;background:var(--panel-strong);border:2px solid #111827;border-radius:999px;
                              font:800 12px/1.1 Inter,system-ui,Arial;padding:4px 7px;box-shadow:0 2px 8px rgba(0,0,0,.18);pointer-events:none">
                    ${cluster.getChildCount()}
                  </div>
                </div>`,
              iconSize: [84, 92], iconAnchor: [42, 54], popupAnchor: [0, -44]
            });
          }
        }).addTo(map);

        const noaaRadar = L.esri.imageMapLayer({
          url:'https://mapservices.weather.noaa.gov/eventdriven/rest/services/radar/radar_base_reflectivity_time/ImageServer',
          opacity:.8, pane:'radarPane'
        });
        const lightningLayer = L.tileLayer.wms('https://geo.weather.gc.ca/geomet',{
          layers:'Lightning_2.5km_Density',version:'1.3.0',format:'image/png',transparent:true,opacity:1,pane:'lightningPane'
        });
        let lightningTimer=null;
        const startLightningRefresh=()=>{ if(!lightningTimer){ lightningTimer=setInterval(()=>{ lightningLayer.setParams({_ :Date.now()}); }, LIGHTNING_REFRESH_MS); } };
        const stopLightningRefresh = ()=>{ if(lightningTimer){ clearInterval(lightningTimer); lightningTimer=null; } };
        map.on('overlayadd',(e)=>{ if(e.layer===lightningLayer) startLightningRefresh(); });
        map.on('overlayremove',(e)=>{ if(e.layer===lightningLayer) stopLightningRefresh(); });

        const fireRiskGroup = L.layerGroup().addLayer(L.tileLayer.wms('https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms', {
          layers:'public:fdr_current', format:'image/png', transparent:true, version:'1.1.1',
          opacity:.4, pane:'perimetersPane', attribution:'CWFIS © Natural Resources Canada'
        }));
        const smokeLayer = L.esri.imageMapLayer({
          url:'https://enterpriseim.esriservices.ca/server/rest/services/Hosted/Aug12/ImageServer',
          opacity:.5, pane:'sentinelPane'
        });
        const aqhiLayer = L.esri.featureLayer({
          url:'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/aqhi_stations_observations_realtime/FeatureServer/1',
          pane:'aqiPane',
          pointToLayer:(feature,latlng)=> {
            const p=feature.properties||{};
            const raw=p.aqhi??p.aqhi_round; const val=(raw==null||Number.isNaN(Number(raw)))?null:Number(raw);
            const label=val==null?'—':val>=10?'Very High Risk':val>=7?'High Risk':val>=4?'Moderate Risk':'Low Risk';
            const color=val==null?'#6b7280':val>=10?'#8b5cf6':val>=7?'#ef4444':val>=4?'#eab308':'#22c55e';
            const icon=L.divIcon({className:'aqi-badge-icon',html:`
              <div style="display:flex;flex-direction:column;align-items:center;">
                <svg width="26" height="26" viewBox="0 0 26 26" style="filter:drop-shadow(0 2px 2px rgba(0,0,0,.25));">
                  <circle cx="13" cy="13" r="11" stroke="#111827" stroke-width="2" fill="${color}" />
                </svg>
                <div style="margin-top:2px;font-size:12px;font-weight:800;color:var(--text);background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:4px 8px;line-height:1.15;text-align:center;box-shadow:var(--shadow-soft)">
                  AQHI ${val ?? '—'} <span style="opacity:.8">${label}</span>
                </div>
              </div>`, iconSize:[28,48], iconAnchor:[14,24], popupAnchor:[0,-22]});
            const m=L.marker(latlng,{icon});
            const loc=p.location_name_en||''; const when=p.observation_datetime_text_en||'';
            m.bindTooltip(`${loc?loc+' — ':''}AQHI ${val ?? '—'} • ${label}${when?' • '+when:''}`,{direction:'top',offset:[0,-20],opacity:0});
            return m;
          }
        });

        /* ====================== Overlays + control (no fire toggles here) ====================== */
        const overlaysFull = {
          'MODIS Hotspots — Last 48 hours': modis48,
          'MODIS Hotspots — Last 7 days': modis7d,
          'Weather Stations': weatherStations,
          'Fire Perimeters': activefires,
          //'NB Boundary': nbBoundary,
          'AQHI Risk': aqhiLayer,
          'Weather Radar': noaaRadar,
          'Lightning Density': lightningLayer,
          'Fire Danger (CWFIS)': fireRiskGroup,
          Smoke: smokeLayer
        };
        L.control.layers(null, overlaysFull, { collapsed: false }).addTo(map);

        // decorate legend (no Active/Extinguished entries anymore)
        (function decorateLayersControl(){
          const list=document.querySelector('.leaflet-control-layers-overlays'); if(!list) return;
          const packs={
            'MODIS Hotspots — Last 48 hours':'<span class="icons-pack"><span class="legend-modis-dot"></span></span>',
            'MODIS Hotspots — Last 7 days':'<span class="icons-pack"><span class="legend-modis-dot"></span></span>',
            'Weather Stations':'<span class="icons-pack"><i class="fa-solid fa-location-arrow legend-icon" style="transform:rotate(45deg)"></i></span>',
            'Fire Perimeters':'<span class="icons-pack"><i class="fa-regular fa-square legend-icon"></i></span>',
            //'NB Boundary':'<span class="icons-pack"><i class="fa-regular fa-square legend-icon"></i></span>',
            'AQHI Risk':'<span class="icons-pack"><i class="fa-solid fa-wind legend-icon"></i></span>',
            'Weather Radar':'<span class="icons-pack"><i class="fa-solid fa-broadcast-tower legend-icon"></i></span>',
            'Lightning Density':'<span class="icons-pack"><i class="fa-solid fa-bolt legend-icon"></i></span>',
            'Fire Danger (CWFIS)':'<span class="icons-pack"><i class="fa-solid fa-fire legend-icon"></i></span>',
            Smoke:'<span class="icons-pack"><i class="fa-solid fa-smog legend-icon"></i></span>'
          };
          list.querySelectorAll('label').forEach((label)=>{
            const textSpan=Array.from(label.querySelectorAll('span')).find(s=>s.textContent.trim());
            if(!textSpan) return; const name=textSpan.textContent.trim();
            label.insertAdjacentHTML('afterbegin',packs[name]||`<span class="icons-pack"><i class="fa-solid fa-layer-group legend-icon"></i></span>`);
            textSpan.classList.add('text');
          });
        })();

        // replace the whole FIRE_STATUS + injectFireStatusPanel block header
const FIRE_STATUS = [
  ['Out of Control', cssVar('--oc'), true],
  ['Contained',      cssVar('--cont'), true],
  ['Under Control',  cssVar('--uc'), true],
  ['Being Patrolled',cssVar('--pat'), true],
  ['Being Monitored',cssVar('--mon'), true],
  ['Extinguished',   '#9aa0a6', false] // default OFF
];

(function injectFireStatusPanel(){
  const overlaysList = document.querySelector('.leaflet-control-layers-overlays'); if(!overlaysList) return;
  if (overlaysList.querySelector('.fire-filter-block')) return;
  const block = document.createElement('div');
  block.className = 'fire-filter-block';
  block.innerHTML = `
    <div class="fire-filter-title">Fire Status</div>
    ${FIRE_STATUS.map(([label, ring, checked]) => `
      <label class="fire-filter-row">
        <input type="checkbox" data-status="${label}" ${checked ? 'checked' : ''}>
        <span class="legend-badge" style="--ring:${ring}">
          <i class="fa-solid fa-fire"></i>
        </span>
        <span class="text">${label}</span>
      </label>
    `).join('')}
  `;
  overlaysList.prepend(block);
  block.addEventListener('change', applyFireFilter);
  applyFireFilter();
})();


        function applyFireFilter(){
          const cbs = document.querySelectorAll('.fire-filter-block input[type="checkbox"]');
          const enabled = new Set(); cbs.forEach(cb => { if (cb.checked) enabled.add(norm(cb.getAttribute('data-status'))); });

          // Remove all markers first…
          activeMarkers.forEach(m => fireClusters.removeLayer(m));
          outMarkers.forEach(m => fireClusters.removeLayer(m));

          // …then add back the ones whose status is enabled
          activeMarkers.forEach(m => { if (enabled.has(m.options._statusKey)) fireClusters.addLayer(m); });
          if (enabled.has('extinguished')) { outMarkers.forEach(m => fireClusters.addLayer(m)); }

          // If everything is off, you’ll see no fire points (as requested).
        }

        /* ====================== Summary ====================== */
        const fsOverlay=document.getElementById('fireSummaryOverlay');
        const fsBody=document.getElementById('fs-body');
        const chip=(label,n)=>`<span class="chip"><span class="dot" style="background:${statusColor(label)}"></span>${label} <span style="font-weight:800;margin-left:6px">${n}</span></span>`;
        const sizeOf=(p)=> Number((p?.FIRE_SIZE ?? p?.SIZE_HA ?? p?.AREA) ?? 0) || 0;

        function buildSummaryHTML(){
          const items=[...fireStore.values()];
          const year = new Date().getFullYear();
          let totalArea=0, counts={'out of control':0,contained:0,'under control':0,'being patrolled':0,'being monitored':0,extinguished:0,other:0};
          let newToday=0, newYesterday=0, extToday=0, extYesterday=0, totalActive=0, totalExt=0;

          for(const it of items){
            const p=it.props||{};
            totalArea += sizeOf(p);
            const key=norm(it.statusKey || p.FIRE_STAT_DESC_E);
            if (Object.prototype.hasOwnProperty.call(counts,key)) counts[key]++; else counts.other++;
            if (key === 'extinguished') totalExt++; else totalActive++;

            const det = getDetectedMs(p);
            if(det!=null){ if(isToday(det)) newToday++; else if(isYesterday(det)) newYesterday++; }

            if (key === 'extinguished') {
              const outMs = getExtinguishedMs(p);
              if (outMs!=null){ if (isToday(outMs)) extToday++; else if (isYesterday(outMs)) extYesterday++; }
            }
          }

          const chipsHTML=[
            ['Out of Control',counts['out of control']],
            ['Contained',counts['contained']],
            ['Under Control',counts['under control']],
            ['Being Patrolled',counts['being patrolled']],
            ['Being Monitored',counts['being monitored']],
            ['Extinguished',counts['extinguished']]
          ].map(([l,n])=>chip(l,n)).join('');

          const byStatus = new Map();
          for (const it of items) {
            const st = norm(it.statusKey || it.props?.FIRE_STAT_DESC_E || 'other');
            if (!byStatus.has(st)) byStatus.set(st, []);
            byStatus.get(st).push(it);
          }
          for (const arr of byStatus.values()) arr.sort((a,b)=> sizeOf(b.props) - sizeOf(a.props));
          const statusOrder = ['out of control','contained','under control','being patrolled','being monitored','extinguished','other'];

          const detailSections = statusOrder
            .filter(k => byStatus.has(k))
            .map(k => {
              const label = k==='other' ? 'Other' : k.replace(/\b\w/g, c=>c.toUpperCase());
              const list = byStatus.get(k).map((it) => {
                const p=it.props||{}; const name = p.FIRE_NAME || p.FIRE_ID || 'Unnamed Fire';
                const size = toNum(sizeOf(p),0); const det  = fmtDateTZ(getDetectedMs(p));
                const extra = (k==='extinguished') ? ` • Out: ${fmtDateTZ(getExtinguishedMs(p))}` : '';
                return `<li style="margin:4px 0;"><a href="#" data-fireid="${it.id}"><span style="font-weight:700">${name}</span>&nbsp;—&nbsp;${size} ha <span style="opacity:.8">• ${label}</span> <span style="opacity:.8">• Detected: ${det}${extra}</span></a></li>`;
              }).join('') || '<li>None</li>';
              return `<div style="margin:10px 0"><b>${label}</b><ol class="summary-list">${list}</ol></div>`;
            }).join('');

          const totalFiresYear = totalActive + totalExt;

          return `
            <div class="fs-meta-grid">
              <div class="stat"><div class="h">Total Fires (${year})</div><div class="v">${toNum(totalFiresYear,0)}</div></div>
              <div class="stat"><div class="h">Active</div><div class="v">${toNum(totalActive,0)}</div></div>
              <div class="stat"><div class="h">Extinguished</div><div class="v">${toNum(totalExt,0)}</div></div>
              <div class="stat"><div class="h">New Fires Today</div><div class="v">${toNum(newToday,0)}</div></div>
              <div class="stat"><div class="h">New Fires Yesterday</div><div class="v">${toNum(newYesterday,0)}</div></div>
              <div class="stat"><div class="h">Total Area Burned</div><div class="v">${toNum(totalArea,0)} ha</div></div>
              <div class="stat"><div class="h">Extinguished Today</div><div class="v">${toNum(extToday,0)}</div></div>
              <div class="stat"><div class="h">Extinguished Yesterday</div><div class="v">${toNum(extYesterday,0)}</div></div>
            </div>

            <div style="margin:8px 0 6px"><b>Fires by status</b></div>
            <div>${chipsHTML}</div>

            <div style="margin-top:12px"><b>Fires (largest → smallest)</b></div>
            <div class="fs-scroll" id="fs-scroll">
              ${detailSections}
            </div>

            <div style="margin-top:10px;font-size:12px;color:var(--muted)">“Today / yesterday” uses Atlantic Time. Sources: local <b>active_fires</b> &amp; <b>out_fires</b>.</div>`;
        }

        function refreshSummary(){ fsBody.innerHTML = buildSummaryHTML(); wireSummaryClicks(); }
        function wireSummaryClicks(){
          const cont = document.getElementById('fs-scroll'); if(!cont) return;
          cont.addEventListener('click', (e)=>{
            const a = e.target.closest('a[data-fireid]'); if(!a) return;
            e.preventDefault();
            const rec=fireStore.get(a.getAttribute('data-fireid')); if(!rec) return;
            fsOverlay.style.display='none'; fsOverlay.hidden=true;
            map.flyTo(rec.latlng,Math.max(map.getZoom(),12),{duration:.6});
            map.once('moveend',()=>rec.layer?.openPopup&&rec.layer.openPopup());
          });
        }

        /* ====================== Buttons ====================== */
        document.getElementById('fireSummaryBtn').addEventListener('click',()=>{ refreshSummary(); fsOverlay.hidden=false; fsOverlay.style.display='flex'; });
        document.getElementById('fs-close').addEventListener('click',()=>{ fsOverlay.style.display='none'; fsOverlay.hidden=true; });
        fsOverlay.addEventListener('click',(e)=>{ if(e.target===fsOverlay){ fsOverlay.style.display='none'; fsOverlay.hidden=true; } });

        const mapToggleBtn = document.getElementById('mapToggleBtn');
        const mtbText = document.getElementById('mtb-text');
        mapToggleBtn.addEventListener('click', () => {
          const hidden = document.body.classList.toggle('map-ui-hidden');
          mapToggleBtn.setAttribute('aria-pressed', String(!hidden));
          mtbText.textContent = hidden ? 'Show Layers' : 'Hide Layers';
        });
        document.getElementById('resetViewBtn').addEventListener('click', () => {
          localStorage.removeItem(LS_KEY);
          map.flyTo(INITIAL_VIEW.center, INITIAL_VIEW.zoom, { duration: 0.6 });
        });

        /* ====================== Mobile layers panel width ====================== */
        function sizeLayersPanel() {
          const panel = document.querySelector('.leaflet-control-layers');
          if (!panel) return;
          if (window.innerWidth > 640) { panel.style.removeProperty('--layers-w'); panel.style.overflowX = 'visible'; return; }
          const measureText = 'MODIS Hotspots — Last 48 hours';
          const measurer = document.createElement('span');
          measurer.style.visibility = 'hidden'; measurer.style.position = 'absolute'; measurer.style.whiteSpace = 'nowrap';
          measurer.style.font = getComputedStyle(panel).font; measurer.textContent = measureText;
          document.body.appendChild(measurer);
          const labelWidth = Math.ceil(measurer.getBoundingClientRect().width);
          document.body.removeChild(measurer);
          const extra = 18 + 26 + 8 + 14 + 40;
          const desired = labelWidth + extra;
          const max = Math.max(240, Math.min(desired, window.innerWidth - 24));
          panel.style.setProperty('--layers-w', max + 'px');
          panel.style.overflowX = desired > max ? 'auto' : 'visible';
        }
        sizeLayersPanel();
        window.addEventListener('resize', sizeLayersPanel);
        document.querySelector('.leaflet-control-layers')?.addEventListener('click', () => queueMicrotask(sizeLayersPanel));
      });
    </script>
  </body>
</html>
