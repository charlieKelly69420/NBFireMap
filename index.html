<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>New Brunswick Wildfire Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet / Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- ============================ CSS ============================ -->
  <style>
    /* Base layout */
    html, body, #map { height: 100%; margin: 0; padding: 0; }

    /* Layer control / legend */
    .leaflet-control-layers-expanded { max-height: 300px; overflow-y: auto; }
    .leaflet-control-layers, .info.legend { transition: opacity 0.2s; }
    .info.legend { bottom: 70px !important; }

    /* Position tweaks so custom buttons don’t overlap native controls */
    .leaflet-top.leaflet-left { top: 40px !important; }
    .leaflet-top.leaflet-right { top: 60px !important; }

    /* Generic map buttons */
    .map-btn {
      position: absolute;
      z-index: 1001;
      background: #fff;
      border: 1px solid #bbb;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 15px;
      font-family: 'Segoe UI', Arial, sans-serif;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.13);
      transition: background 0.2s;
    }
    .map-btn:hover { background: #f0f0f0; }
    .map-toggle-btn { top: 12px; right: 12px; }
    .reset-view-btn { top: 12px; left: 12px; z-index: 1002; }

    /* Hide UI helper class */
    .map-ui-hidden .leaflet-control-layers,
    .map-ui-hidden .info.legend { opacity: 0; pointer-events: none; }

    /* City/perimeter tooltips (no bubble chrome) */
    .city-label-tooltip,
    .perimeter-label-tooltip {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
    }
    .city-label-tooltip::before,
    .perimeter-label-tooltip::before { display: none !important; }

    .city-label {
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 15px; font-weight: 700; color: #fff;
      text-shadow:
        -1px -1px 0 #000, 1px -1px 0 #000,
        -1px  1px 0 #000, 1px  1px 0 #000;
    }
    .perimeter-label {
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 12px; font-weight: 800; pointer-events: none;
    }

    /* Fire Summary panel */
    .fire-summary-btn {
      position: fixed;
      left: 12px; bottom: 64px; z-index: 2001;
      background: #fff; border: 1px solid #bbb; border-radius: 6px;
      padding: 6px 12px; font: 15px 'Segoe UI', Arial, sans-serif;
      cursor: pointer; box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }
    .fire-summary-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.25);
      display: none; align-items: start; justify-content: center;
      z-index: 3000;
    }
    .fire-summary {
      margin-top: 14px; background: #fff; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      width: min(520px, calc(100% - 24px));
      font: 14px 'Segoe UI', Arial, sans-serif; color: #111;
    }
    .fire-summary header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px 6px; font-weight: 800; font-size: 18px;
    }
    .fire-summary .body { padding: 0 14px 12px; }
    .chip {
      display: inline-flex; align-items: center; gap: 8px;
      background: #f6f6f6; border-radius: 999px; padding: 6px 10px;
      margin-right: 8px; margin-bottom: 8px; font-weight: 700;
    }
    .dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; }
    .summary-list { margin: 8px 0 0; padding-left: 20px; }
    .summary-list a { color: #0066cc; text-decoration: underline; }
    .close-summary {
      background:#eee; border:1px solid #bbb; border-radius:6px;
      padding:6px 10px; cursor:pointer; font: 14px 'Segoe UI', Arial, sans-serif;
    }

    /* Footer link */
    .nb-footer {
      position: fixed; bottom: 10px; left: 0; width: 100%;
      text-align: center; z-index: 2000;
    }
    .nb-footer a {
      background:#fff; border-radius:6px; padding:8px 18px;
      box-shadow:0 1px 4px rgba(0,0,0,0.13);
      color:#0074d9; font-weight:bold; text-decoration:underline;
      font-family:'Segoe UI',Arial,sans-serif;
    }
  </style>
</head>

<body>
  <!-- ============================ HTML ============================ -->
  <div id="map" aria-label="Interactive wildfire map"></div>

  <button id="mapToggleBtn" class="map-btn map-toggle-btn" type="button" aria-pressed="false">
    Show Legend &amp; Layers
  </button>

  <button id="resetViewBtn" class="map-btn reset-view-btn" type="button" title="Reset map view">
    Reset Map View
  </button>

  <!-- Fire summary trigger and overlay -->
  <button id="fireSummaryBtn" class="fire-summary-btn" type="button">Fire Summary</button>
  <div id="fireSummaryOverlay" class="fire-summary-overlay" role="presentation">
    <div class="fire-summary" role="dialog" aria-modal="true" aria-labelledby="fs-title">
      <header>
        <div id="fs-title">New Brunswick Fire Summary</div>
        <button id="fs-close" class="close-summary" type="button">Close</button>
      </header>
      <div id="fs-body" class="body"></div>
    </div>
  </div>

  <div class="nb-footer">
    <a href="https://www.gnb.ca/en/topic/laws-safety/emergency-preparedness-alerts/fire-watch.html" target="_blank" rel="noopener">
      NB Fire Watch &amp; Burn Restrictions
    </a>
  </div>

  <!-- ============================ JS (Libraries) ============================ -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet-image/dist/esri-leaflet-image.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
  <script src="callsigns.js"></script>

  <!-- ============================ JS (App) ============================ -->
  <script>
    // ---------- Config ----------
    const LS_KEY = 'nbMapView';
    const NB_BOUNDS = [[44.0, -69.5],[48.5, -62.0]];
    const INITIAL_VIEW = { center: [46.7, -66.2], zoom: window.innerWidth < 768 ? 7 : 8 };

    // ---------- Utilities ----------
    const isMobile = () => window.innerWidth < 768;

    const getSavedView = () => {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || 'null'); }
      catch { return null; }
    };

    const saveView = (map) => {
      const c = map.getCenter();
      localStorage.setItem(LS_KEY, JSON.stringify({ center: [c.lat, c.lng], zoom: map.getZoom() }));
    };

    const normalizeFireStatus = (label) => (label || '').toString().trim().toLowerCase();

    const fireStatusColor = (label) => {
      switch (normalizeFireStatus(label)) {
        case 'out of control': return 'red';
        case 'contained':     return 'orange';
        case 'under control': return 'yellow';
        case 'being patrolled': return 'green';
        default: return 'gray';
      }
    };

    const formatEsriDate = (v) => {
      if (v == null) return '—';
      try {
        const d = new Date(Number(v));
        return d.toLocaleString(undefined, {
          year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'
        });
      } catch { return '—'; }
    };

    const numberFmt = (n, d = 1) =>
      (n == null || isNaN(n)) ? '—' : Number(n).toLocaleString(undefined, { maximumFractionDigits: d });

    // ---------- Map init ----------
    const restored = getSavedView();
    const map = L.map('map', {
      center: restored ? restored.center : INITIAL_VIEW.center,
      zoom: restored ? restored.zoom : INITIAL_VIEW.zoom,
      minZoom: 7,
      maxBounds: NB_BOUNDS,
      maxBoundsViscosity: 0.5
    });
    map.on('moveend', () => saveView(map));

    // Panes
    map.createPane('viirsPane');       map.getPane('viirsPane').style.zIndex = 410;
    map.createPane('nbBoundaryPane');  map.getPane('nbBoundaryPane').style.zIndex = 405;
    map.createPane('planesPane');      map.getPane('planesPane').style.zIndex = 1000;
    map.getPane('planesPane').style.pointerEvents = 'auto';

    // Basemap & imagery
    const esriImagery = L.esri.basemapLayer('Imagery').addTo(map);
    const sentinel2c  = L.esri.imageMapLayer({
      url: 'https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer',
      opacity: 0.7
    });

    // Mobile locate + fit
    if (isMobile()) {
      L.control.locate({
        position: 'topleft',
        flyTo: true,
        showPopup: false,
        keepCurrentZoomLevel: true,
        icon: 'fa fa-location-crosshairs',
        strings: { title: "Show me where I am" }
      }).addTo(map);
      map.fitBounds(NB_BOUNDS, { padding: [30, 30] });
    }

    // ---------- Fire layer + store (for summary) ----------
    const fireStore = new Map(); // id -> { id, props, latlng, layer }

    const nbActiveWildFires = L.esri.featureLayer({
      url: 'https://gis-erd-der.gnb.ca/arcgis/rest/services/Fire_Dashboards/Public_Fires/MapServer/0',
      pointToLayer: (feature, latlng) => {
        const color = fireStatusColor(feature.properties.FIRE_STAT_DESC_E);
        const icon = L.divIcon({
          className: 'fire-triangle-icon',
          html: `
            <div style="width:44px;height:44px;display:flex;align-items:center;justify-content:center;">
              <svg width="32" height="32" viewBox="0 0 32 32" style="display:block;margin-top:4px;">
                <polygon points="16,4 28,28 4,28" style="fill:${color};stroke:#222;stroke-width:2" />
              </svg>
            </div>
          `,
          iconSize: [44, 44],
          iconAnchor: [22, 30]
        });
        return L.marker(latlng, { icon });
      },
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const status = p.FIRE_STAT_DESC_E || '—';
        const sizeHa = p.FIRE_SIZE;
        const detected = formatEsriDate(p.TIME_DETECTED);
        const statusDate = formatEsriDate(p.FIRE_STAT_DATE);
        const statusColor = fireStatusColor(status);

        const popupHTML = `
          <div style="font:14px 'Segoe UI',Arial,sans-serif;min-width:220px">
            <div style="font-weight:800;font-size:16px;margin-bottom:6px">
              ${p.FIRE_NAME || 'Unnamed Fire'}
            </div>
            <div style="margin:6px 0 10px">
              <span style="display:inline-block;padding:2px 8px;border-radius:999px;background:${statusColor};color:#111;font-weight:700">
                ${status}
              </span>
            </div>
            <div style="line-height:1.35">
              <div><b>Area:</b> ${numberFmt(sizeHa, 1)} ha</div>
              <div><b>Detected:</b> ${detected}</div>
              <div><b>Status updated:</b> ${statusDate}</div>
            </div>
          </div>
        `;
        layer.bindPopup(popupHTML, { maxWidth: 320 });

        // Store by stable key
        const rawId = feature.id ?? p.OBJECTID ?? p.GlobalID ?? p.FIRE_ID ?? Math.random();
        const id = String(rawId);
        fireStore.set(id, { id, props: p, latlng: layer.getLatLng(), layer });

        // Debounced hover with click-to-lock
        let clickedOpen = false;
        let openT = null, closeT = null;
        const OPEN_DELAY = 150, CLOSE_DELAY = 60;

        const clearTimers = () => {
          if (openT) { clearTimeout(openT); openT = null; }
          if (closeT) { clearTimeout(closeT); closeT = null; }
        };

        layer.on('mouseover', function () {
          if (clickedOpen) return;
          if (closeT) { clearTimeout(closeT); closeT = null; }
          if (!openT) openT = setTimeout(() => { openT = null; this.openPopup(); }, OPEN_DELAY);
        });

        layer.on('mouseout', function () {
          if (clickedOpen) return;
          if (openT) { clearTimeout(openT); openT = null; }
          if (!closeT) closeT = setTimeout(() => { closeT = null; this.closePopup(); }, CLOSE_DELAY);
        });

        layer.on('click', function () {
          clickedOpen = !clickedOpen;
          clearTimers();
          if (clickedOpen) this.openPopup(); else this.closePopup();
        });

        layer.on('remove', clearTimers);
      }
    }).addTo(map);

    // Keep store in sync as features are removed
    nbActiveWildFires.on('removefeature', (e) => {
      const p = (e.feature && e.feature.properties) || {};
      const id = String(e.feature && (e.feature.id ?? p.OBJECTID ?? p.GlobalID ?? p.FIRE_ID));
      fireStore.delete(id);
    });

    // ---------- Other operational layers ----------
    // VIIRS hotspots
    const viirsHotspots = L.esri.featureLayer({
      url: 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/ArcGIS/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0',
      pane: 'viirsPane',
      pointToLayer: (_feature, latlng) =>
        L.circleMarker(latlng, { radius: 5, color: '#ffe066', fillColor: '#ffe066', fillOpacity: 0.7 })
    }).addTo(map);

    // Fire perimeters + labels
    const PERIMETER_COLOR = 'red';
    const perimeterLabelLayers = new Set();

    const activefires = L.esri.featureLayer({
      url: 'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Active_Wildfire_Perimeters_in_Canada_View/FeatureServer/0',
      style: () => ({ color: PERIMETER_COLOR, weight: 1, fillOpacity: 0.20 }),
      onEachFeature: (feature, layer) => {
        const ha = feature?.properties?.AREA;
        const html = `<span class="perimeter-label" style="color:${PERIMETER_COLOR}">${numberFmt(ha, 1)} ha</span>`;
        layer.bindTooltip(html, { permanent: true, className: 'perimeter-label-tooltip', direction: 'center', opacity: 0 });
        perimeterLabelLayers.add(layer);
      }
    }).addTo(map);

    const updatePerimeterLabelVisibility = () => {
      const show = map.getZoom() >= 11;
      perimeterLabelLayers.forEach((l) => {
        const tt = l.getTooltip && l.getTooltip();
        if (tt) tt.setOpacity(show ? 1 : 0);
      });
    };
    activefires.on('load', updatePerimeterLabelVisibility);
    map.on('zoomend', updatePerimeterLabelVisibility);

    // Crown lands (toggle visibility at low zoom)
    const nbCrownLands = L.esri.featureLayer({
      url: 'https://gis-erd-der.gnb.ca/server/rest/services/OpenData/Crown_Lands/FeatureServer/0',
      style: () => ({ color: 'purple', weight: 1, fillOpacity: 0.2 })
    });

    const updateCrownLandsVisibility = () => {
      if (map.getZoom() < 10 && map.hasLayer(nbCrownLands)) map.removeLayer(nbCrownLands);
    };
    map.on('zoomend', updateCrownLandsVisibility);

    // Burn bans (dynamic)
    const nbBurnBans = L.esri.dynamicMapLayer({
      url: 'https://gis-erd-der.gnb.ca/gisserver/rest/services/FireWeather/BurnCategories/MapServer',
      opacity: 0.7
    });

    // Weather stations
    const weatherStations = L.esri.featureLayer({
      url: 'https://services.arcgis.com/zmLUiqh7X11gGV2d/ArcGIS/rest/services/EnvironmentCanada/FeatureServer/0',
      pointToLayer: (feature, latlng) => {
        const p = feature.properties || {};
        const windDir = p.WindDirection || 0;
        const windSpeed = p.WindSpeed_kmh;
        const temp = p.Temperature_C;
        const humidity = p.Humidity_Percent;

        const icon = L.divIcon({
          className: 'weather-arrow-icon',
          html: `
            <div style="display:flex;flex-direction:column;align-items:center;">
              <svg width="38" height="38" style="transform:rotate(${windDir}deg);display:block;">
                <polygon points="19,4 30,30 19,24 8,30" style="fill:#bbb;stroke:#111;stroke-width:2" />
              </svg>
              <div style="font-size:13px;font-weight:bold;color:#222;background:rgba(255,255,255,0.85);border-radius:4px;padding:2px 6px;line-height:1.1;text-align:center;">
                ${windSpeed !== undefined ? `${windSpeed}<span style="font-size:10px;"> km/h</span>` : ''}<br>
                ${temp !== undefined ? `${temp}<span style="font-size:10px;">°C</span>` : ''}<br>
                ${humidity !== undefined ? `${humidity}<span style="font-size:10px;">%</span>` : ''}
              </div>
            </div>
          `,
          iconSize: [38, 54],
          iconAnchor: [19, 32]
        });
        return L.marker(latlng, { icon });
      }
    }).addTo(map);

    // Cities (labels only)
    const nbCities = [
      {name:"Fredericton",lat:45.9636,lng:-66.6431},{name:"Saint John",lat:45.2733,lng:-66.0633},
      {name:"Moncton",lat:46.0878,lng:-64.7782},{name:"Bathurst",lat:47.6186,lng:-65.6517},
      {name:"Miramichi",lat:47.0281,lng:-65.5019},{name:"Edmundston",lat:47.3730,lng:-68.3251},
      {name:"Campbellton",lat:48.0075,lng:-66.6731},{name:"Dieppe",lat:46.0842,lng:-64.6877},
      {name:"Riverview",lat:46.0617,lng:-64.8052},{name:"Quispamsis",lat:45.4319,lng:-65.9469},
      {name:"Oromocto",lat:45.8491,lng:-66.4828},{name:"Woodstock",lat:46.1527,lng:-67.6016}
    ];

    const cityMarkers = L.layerGroup(
      nbCities.map(city => {
        const t = L.divIcon({ html: '', iconSize: [0,0] });
        return L.marker([city.lat, city.lng], { icon: t, interactive: false, zIndexOffset: 1000 })
                .bindTooltip(`<span class="city-label">${city.name}</span>`, {
                  permanent: true, direction: 'top', offset: [0,0], className: 'city-label-tooltip'
                });
      })
    );

    // NB boundary (always on)
    L.esri.featureLayer({
      url: 'https://maps-cartes.services.geo.ca/server2_serveur2/rest/services/BaseMaps/Provinces/MapServer/0',
      where: "POLITICALDIV = 4",
      pane: 'nbBoundaryPane',
      style: () => ({ color: 'black', weight: 5, fill: false }),
      interactive: false
    }).addTo(map);

    // ---------- OpenSky planes ----------
    const OPEN_SKY_URL = "https://opensky-network.org/api/states/all";
    const PROXY_URL = ""; // if you need one, set it here
    const WHITELIST_CALLSIGNS = window.WHITELIST_CALLSIGNS || new Set();

    const planesLayer = L.layerGroup().addTo(map);
    const planeMarkers = new Map();

    const makePlaneIcon = (headingDeg, callsign) => {
      const ICON_OFFSET = -45; // tweak if emoji direction is off
      const isWhitelisted = WHITELIST_CALLSIGNS.has(callsign);
      const extraStyle = isWhitelisted ? 'filter:hue-rotate(-90deg) saturate(5);' : '';
      return L.divIcon({
        className: 'plane-div-icon',
        html: `
          <div style="transform: rotate(${ICON_OFFSET}deg); transform-origin:center; display:inline-block;">
            <div style="${extraStyle} transform: rotate(${Number.isFinite(headingDeg) ? headingDeg : 0}deg); display:block; font-size:26px;">✈️</div>
          </div>
        `,
        iconSize: [30, 46],
        iconAnchor: [15, 23]
      });
    };

    const upsertPlaneMarker = (icao24, lat, lon, heading, callsign, velocity) => {
      let m = planeMarkers.get(icao24);
      const popupContent = `
        <b>${callsign || 'Unknown'}</b><br>
        Heading: ${Number.isFinite(heading) ? Math.round(heading) : '—'}°<br>
        Speed: ${velocity != null ? Math.round(velocity * 1.94384) : '—'} kt
      `;

      if (!m) {
        m = L.marker([lat, lon], {
          icon: makePlaneIcon(heading, callsign),
          pane: 'planesPane',
          keyboard: false,
          zIndexOffset: 10000
        }).bindPopup(popupContent);

        // hover-to-open, click-to-lock
        let clicked = false;
        m.on('mouseover', function () { if (!clicked) this.openPopup(); });
        m.on('mouseout',  function () { if (!clicked) this.closePopup(); });
        m.on('click',    function () { clicked = !clicked; if (clicked) this.openPopup(); else this.closePopup(); });

        m.addTo(planesLayer);
        planeMarkers.set(icao24, m);
      } else {
        m.setLatLng([lat, lon]);
        m.setIcon(makePlaneIcon(heading, callsign));
        m.setPopupContent(popupContent);
      }
    };

    const pruneMissing = (seen) => {
      for (const [k, marker] of planeMarkers.entries()) {
        if (!seen.has(k)) {
          planesLayer.removeLayer(marker);
          planeMarkers.delete(k);
        }
      }
    };

    async function fetchOpenSkyStates() {
      try {
        const lamin = NB_BOUNDS[0][0], lomin = NB_BOUNDS[0][1];
        const lamax = NB_BOUNDS[1][0], lomax = NB_BOUNDS[1][1];
        const url = `${OPEN_SKY_URL}?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`;
        const resp = await fetch(PROXY_URL ? PROXY_URL + encodeURIComponent(url) : url);
        if (!resp.ok) throw new Error(resp.statusText);

        const data = await resp.json();
        const states = Array.isArray(data.states) ? data.states : [];
        const seen = new Set();

        for (const s of states) {
          const icao24 = s[0];
          const callsign = (s[1] || '').trim().toUpperCase();
          const lon = s[5], lat = s[6], vel = s[9], hdg = s[10];
          if (!icao24 || lat == null || lon == null) continue;
          seen.add(icao24);
          upsertPlaneMarker(icao24, lat, lon, hdg, callsign, vel);
        }
        pruneMissing(seen);
      } catch (e) {
        console.warn('OpenSky fetch failed:', e);
      }
    }

    fetchOpenSkyStates();
    const OPEN_SKY_INTERVAL_MS = 250000;
    let planesTimer = setInterval(fetchOpenSkyStates, OPEN_SKY_INTERVAL_MS);

    planesLayer.on('add', () => { if (!planesTimer) planesTimer = setInterval(fetchOpenSkyStates, OPEN_SKY_INTERVAL_MS); });
    planesLayer.on('remove', () => { if (planesTimer) { clearInterval(planesTimer); planesTimer = null; } });

    // ---------- Controls & Legend ----------
    const overlays = {
      "NB Active Wild Fires": nbActiveWildFires,
      "Weather Stations": weatherStations,
      "VIIRS Hotspots": viirsHotspots,
      "Fire Perimeters": activefires,
      "Aircraft": planesLayer,
      "Major Cities & Towns": cityMarkers,
      "NB Crown Lands (zoom in to view)": nbCrownLands,
      "NB Burn Bans": nbBurnBans,
      "Sentinel-2C Imagery": sentinel2c
    };

    const layersControl = L.control.layers(null, overlays, { collapsed: false }).addTo(map);

    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'info legend');
      div.style.background = 'rgba(255,255,255,0.95)';
      div.style.padding = '10px 14px';
      div.style.borderRadius = '8px';
      div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
      div.innerHTML = `
        <b>Legend</b><br>
        <div style="margin-bottom:8px;">
          <svg width="24" height="24" style="vertical-align:middle;"><polygon points="12,3 22,21 2,21" style="fill:red;stroke:#222;stroke-width:2" /></svg><span style="margin-left:6px;">Out of Control Fire</span><br>
          <svg width="24" height="24" style="vertical-align:middle;"><polygon points="12,3 22,21 2,21" style="fill:orange;stroke:#222;stroke-width:2" /></svg><span style="margin-left:6px;">Contained Fire</span><br>
          <svg width="24" height="24" style="vertical-align:middle;"><polygon points="12,3 22,21 2,21" style="fill:yellow;stroke:#222;stroke-width:2" /></svg><span style="margin-left:6px;">Under Control Fire</span><br>
          <svg width="24" height="24" style="vertical-align:middle;"><polygon points="12,3 22,21 2,21" style="fill:green;stroke:#222;stroke-width:2" /></svg><span style="margin-left:6px;">Being Patrolled Fire</span>
        </div>
        <div style="margin-bottom:8px;">
          <svg width="24" height="24" style="vertical-align:middle;"><polygon points="12,4 20,20 12,16 4,20" style="fill:#bbb;stroke:#111;stroke-width:2" /></svg>
          <a href="https://esricanada.maps.arcgis.com/home/item.html?id=38406bada3104e258fc8b42a2a96581a" target="_blank" rel="noopener" style="margin-left:6px; color:#0074d9; text-decoration:underline; font-weight:bold;">Weather Station Wind Direction</a><br>
          <span style="display:inline-block;width:24px;"></span>
          <span style="font-size:12px; font-weight:bold; white-space:nowrap;">12 <span style="font-size:10px;"> km/h</span>, 20<span style="font-size:10px;">°C</span>, 60<span style="font-size:10px;">%</span></span>
          <span style="margin-left:6px;">Wind Speed, Temp, Humidity</span>
        </div>
        <div>
          <svg width="18" height="18" style="vertical-align:middle;"><circle cx="9" cy="9" r="6" fill="#ffe066" stroke="#ffe066" stroke-width="2"/></svg>
          <a href="https://www.arcgis.com/home/item.html?id=dece90af1a0242dcbf0ca36d30276aa3" target="_blank" rel="noopener" style="margin-left:6px; color:#0074d9; text-decoration:underline; font-weight:bold;">VIIRS Hotspot</a>
        </div>
        <div>
          <a href="https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer" target="_blank" rel="noopener" style="margin-left:6px; color:#0074d9; text-decoration:underline; font-weight:bold;">Sentinel-2C Imagery</a>
        </div>
        <div style="margin-top:12px; font-size:12px;">
          Fires and Crown Land info are from
          <a href="https://www.snb.ca/geonb1/e/dc/catalogue-E.asp" target="_blank" rel="noopener" style="color:#0074d9; text-decoration:underline; font-weight:bold;">GeoNB</a>
        </div>
      `;
      return div;
    };
    legend.addTo(map);

    // Hide/Show UI (legend + layer list)
    const setMapUIHidden = (hidden) => {
      const mapDiv = document.getElementById('map');
      const btn = document.getElementById('mapToggleBtn');
      if (hidden) {
        mapDiv.classList.add('map-ui-hidden');
        btn.innerText = 'Show Legend & Layers';
        btn.setAttribute('aria-pressed', 'false');
      } else {
        mapDiv.classList.remove('map-ui-hidden');
        btn.innerText = 'Hide Legend & Layers';
        btn.setAttribute('aria-pressed', 'true');
      }
    };
    setMapUIHidden(isMobile());

    // Button events
    document.getElementById('mapToggleBtn').addEventListener('click', () => {
      const hidden = document.getElementById('map').classList.contains('map-ui-hidden');
      setMapUIHidden(hidden); // toggles text & state
    });
    document.getElementById('resetViewBtn').addEventListener('click', () => {
      map.setView(INITIAL_VIEW.center, INITIAL_VIEW.zoom);
      localStorage.removeItem(LS_KEY);
    });

    // ---------- Fire Summary ----------
    const summaryOverlay = document.getElementById('fireSummaryOverlay');
    const summaryBody = document.getElementById('fs-body');

    const buildSummaryHTML = () => {
      const items = Array.from(fireStore.values());
      let totalArea = 0;
      const counts = {
        'out of control': 0, 'contained': 0, 'under control': 0, 'being patrolled': 0, 'other': 0
      };

      items.forEach((it) => {
        const p = it.props || {};
        const sz = Number(p.FIRE_SIZE);
        if (isFinite(sz)) totalArea += sz;

        const key = normalizeFireStatus(p.FIRE_STAT_DESC_E);
        if (counts.hasOwnProperty(key)) counts[key]++; else counts.other++;
      });

      const top5 = items
        .slice()
        .sort((a, b) => (Number(b.props.FIRE_SIZE) || 0) - (Number(a.props.FIRE_SIZE) || 0))
        .slice(0, 5);

      const chip = (label) => {
        const color = fireStatusColor(label);
        const key = normalizeFireStatus(label);
        const n =
          key === 'out of control' ? counts['out of control'] :
          key === 'contained' ? counts['contained'] :
          key === 'under control' ? counts['under control'] :
          key === 'being patrolled' ? counts['being patrolled'] :
          counts.other;
        return `<span class="chip"><span class="dot" style="background:${color}"></span>${label} <span style="font-weight:700;margin-left:6px;">${n}</span></span>`;
      };

      const list = top5.map((it) => {
        const p = it.props || {};
        const name = p.FIRE_NAME || 'Unnamed Fire';
        const area = numberFmt(p.FIRE_SIZE, 0);
        return `<li><a href="#" data-fireid="${String(it.id)}">${name} — ${area} ha</a></li>`;
      }).join('');

      return `
        <div><b>Total area burned:</b> ${numberFmt(totalArea, 0)} ha</div>
        <div style="margin-top:10px;"><b>Fires by status:</b></div>
        <div style="margin-top:6px;">
          ${chip('Out of Control')}
          ${chip('Contained')}
          ${chip('Being Patrolled')}
          ${chip('Under Control')}
        </div>
        <div><b>Top 5 largest fires <span style="font-weight:400">(largest → smallest)</span></b></div>
        <ol class="summary-list" id="fs-top5">${list || '<li>No active fires</li>'}</ol>
        <div style="margin-top:10px;font-size:12px;color:#666;">Source: NB Active Fires (Public_Fires/MapServer/0).</div>
      `;
    };

    const openSummary = () => {
      summaryBody.innerHTML = buildSummaryHTML();
      summaryOverlay.style.display = 'flex';

      const listEl = document.getElementById('fs-top5');
      if (!listEl) return;

      listEl.querySelectorAll('a[data-fireid]').forEach((a) => {
        a.addEventListener('click', (e) => {
          e.preventDefault(); e.stopPropagation();
          const id = a.getAttribute('data-fireid');
          const rec = fireStore.get(id) || fireStore.get(Number(id));
          if (!rec) return;

          summaryOverlay.style.display = 'none';
          const targetZoom = Math.max(map.getZoom(), 12);
          map.flyTo(rec.latlng, targetZoom, { duration: 0.6 });
          map.once('moveend', () => { if (rec.layer?.openPopup) rec.layer.openPopup(); });
        });
      });
    };

    document.getElementById('fireSummaryBtn').addEventListener('click', openSummary);
    document.getElementById('fs-close').addEventListener('click', () => (summaryOverlay.style.display = 'none'));
    summaryOverlay.addEventListener('click', (e) => {
      if (e.target === summaryOverlay) summaryOverlay.style.display = 'none';
    });
  </script>
</body>
</html>
