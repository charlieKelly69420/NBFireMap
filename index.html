<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>New Brunswick Wildfire Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .leaflet-control-layers-expanded {
      max-height: 300px;
      overflow-y: auto;
    }
    .map-toggle-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 1001;
      background: #fff;
      border: 1px solid #bbb;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 15px;
      font-family: 'Segoe UI', Arial, sans-serif;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.13);
      transition: background 0.2s;
    }
    .map-toggle-btn:hover {
      background: #f0f0f0;
    }
    .reset-view-btn {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1002;
      background: #fff;
      border: 1px solid #bbb;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 15px;
      font-family: 'Segoe UI', Arial, sans-serif;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.13);
      transition: background 0.2s;
    }
    .reset-view-btn:hover {
      background: #f0f0f0;
    }
    /* Move zoom and GPS controls up a bit, but still below the reset button */
    .leaflet-top.leaflet-left {
      top: 40px !important;
    }
    .leaflet-control-layers,
    .info.legend {
      transition: opacity 0.2s;
    }
    .map-ui-hidden .leaflet-control-layers,
    .map-ui-hidden .info.legend {
      opacity: 0;
      pointer-events: none;
    }
    .leaflet-top.leaflet-right {
      top: 60px !important;
    }
    .info.legend {
      bottom: 70px !important;
    }
    /* Modern city label style, white bold with black halo, no arrow, no bg */
    .city-label-tooltip {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin: 0 !important;
      pointer-events: none;
    }
    .city-label-tooltip::before {
      display: none !important;
    }
    .city-label {
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 15px;
      font-weight: 700;
      color: #fff;
      text-shadow:
        -1px -1px 0 #000,
         1px -1px 0 #000,
        -1px  1px 0 #000,
         1px  1px 0 #000;
      background: none;
      padding: 0;
      margin: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="mapToggleBtn" class="map-toggle-btn">Show Legend & Layers</button>
  <button id="resetViewBtn" class="reset-view-btn" title="Reset map view">Reset Map View</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet-image/dist/esri-leaflet-image.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
  <script>
    // Allow panning at least 2x outside NB, but keep NB visible on mobile
    var nbBounds = [
      [44.0, -69.5], // Southwest corner (a bit outside NB)
      [48.5, -62.0]  // Northeast corner (a bit outside NB)
    ];
    // Save initial view for reset
    var initialView = {
      center: [46.7, -66.2],
      zoom: window.innerWidth < 768 ? 7 : 8
    };

    // Try to restore previous view
    var savedView = localStorage.getItem('nbMapView');
    var initialCenter = initialView.center.slice();
    var initialZoom = initialView.zoom;

    if (savedView) {
      try {
        var view = JSON.parse(savedView);
        initialCenter = view.center;
        initialZoom = view.zoom;
      } catch (e) {}
    }

    var map = L.map('map', {
      center: initialCenter,
      zoom: initialZoom,
      minZoom: 7,
      maxBounds: nbBounds,
      maxBoundsViscosity: 0.5
    });

    // Save view on move
    map.on('moveend', function() {
      localStorage.setItem('nbMapView', JSON.stringify({
        center: map.getCenter(),
        zoom: map.getZoom()
      }));
    });

    // Esri World Imagery as basemap
    var esriImagery = L.esri.basemapLayer('Imagery');

    // Sentinel-2C Imagery (on by default)
    var sentinel2c = L.esri.imageMapLayer({
      url: 'https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer',
      opacity: 0.7
    });

    // Add only one basemap at a time
    esriImagery.addTo(map);

    // On mobile, remove Sentinel-2C and add GPS
    if (window.innerWidth < 768) {
      map.removeLayer(sentinel2c);
      L.control.locate({
        position: 'topleft',
        flyTo: true,
        showPopup: false,
        keepCurrentZoomLevel: true,
        icon: 'fa fa-location-crosshairs', // Font Awesome 6+ "crosshairs" icon
        strings: { title: "Show me where I am" }
      }).addTo(map);
      // Optionally, fit bounds again if you want to ensure NB is visible
      map.fitBounds(nbBounds, { padding: [10, 10] });
    }

    // NB Active Wild Fires (on by default, styled by label)
    var nbActiveWildFires = L.esri.featureLayer({
      url: 'https://gis-erd-der.gnb.ca/arcgis/rest/services/Fire_Dashboards/Public_Fires/MapServer/0',
      pointToLayer: function(feature, latlng) {
        var label = feature.properties.FIRE_STAT_DESC_E || '';
        var color = 'gray';
        if (label === 'Out of Control') color = 'red';
        else if (label === 'Contained') color = 'orange';
        else if (label === 'Under control') color = 'yellow';
        else if (label === 'Being patrolled') color = 'green';
        else if (label === 'Being Patrolled') color = 'green';

        // SVG triangle as a divIcon (screen-size, not map-size)
        var triangleIcon = L.divIcon({
          className: 'fire-triangle-icon',
          html: `
            <svg width="32" height="32" viewBox="0 0 32 32">
              <polygon points="16,4 28,28 4,28" style="fill:${color};stroke:#222;stroke-width:2" />
            </svg>
          `,
          iconSize: [32, 32],
          iconAnchor: [16, 28]
        });

        return L.marker(latlng, { icon: triangleIcon });
      }
    }).addTo(map);

    nbActiveWildFires.bindPopup(function (layer) {
      var props = layer.feature.properties;
      var popup = '<b>NB Active Wild Fire</b><br>';
      for (var key in props) {
        if (props.hasOwnProperty(key)) {
          popup += '<b>' + key + ':</b> ' + props[key] + '<br>';
        }
      }
      return popup;
    });

    // VIIRS Hotspots (on by default, light yellow, draws under NB Active Wild Fires)
    map.createPane('viirsPane');
    map.getPane('viirsPane').style.zIndex = 410;

    var viirsHotspots = L.esri.featureLayer({
      url: 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/ArcGIS/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0',
      pane: 'viirsPane',
      pointToLayer: function(geojson, latlng) {
        return L.circleMarker(latlng, {
          radius: 5,
          color: '#ffe066',
          fillColor: '#ffe066',
          fillOpacity: 0.7
        });
      }
    }).addTo(map);

    // NB Crown Lands (off by default, styled client-side)
    var nbCrownLands = L.esri.featureLayer({
      url: 'https://gis-erd-der.gnb.ca/server/rest/services/OpenData/Crown_Lands/FeatureServer/0',
      style: function() {
        return { color: 'purple', weight: 1, fillOpacity: 0.2 };
      }
    });

    // Only show Crown Lands at zoom 10+
    map.on('zoomend', function() {
      if (map.hasLayer(nbCrownLands)) {
        if (map.getZoom() < 10) {
          map.removeLayer(nbCrownLands);
        }
      } else {
        if (map.getZoom() >= 10 && map._layersControl && map._layersControl._layers) {
          var overlays = map._layersControl._layers;
          for (var i in overlays) {
            if (overlays[i].name === "NB Crown Lands" && overlays[i].layer === nbCrownLands && overlays[i].overlay && overlays[i].active) {
              map.addLayer(nbCrownLands);
            }
          }
        }
      }
    });

    // NB Burn Bans (off by default, uses server symbology)
    var nbBurnBans = L.esri.dynamicMapLayer({
      url: 'https://gis-erd-der.gnb.ca/gisserver/rest/services/FireWeather/BurnCategories/MapServer',
      opacity: 0.7
    });

    // Weather Stations (on by default, arrow shows wind direction, label shows wind speed/temp/humidity)
    var weatherStations = L.esri.featureLayer({
      url: 'https://services.arcgis.com/zmLUiqh7X11gGV2d/ArcGIS/rest/services/EnvironmentCanada/FeatureServer/0',
      pointToLayer: function(feature, latlng) {
        var windDir = feature.properties.WindDirection || 0;
        var windSpeed = feature.properties.WindSpeed_kmh;
        var temp = feature.properties.Temperature_C;
        var humidity = feature.properties.Humidity_Percent;

        // Large, modern, bold arrow SVG
        var arrowIcon = L.divIcon({
          className: 'weather-arrow-icon',
          html: `
            <div style="display: flex; flex-direction: column; align-items: center;">
              <svg width="38" height="38" style="transform: rotate(${windDir}deg); display: block;">
                <polygon points="19,4 30,30 19,24 8,30" style="fill:#bbb;stroke:#111;stroke-width:2" />
              </svg>
              <div style="font-size:13px; font-weight:bold; color:#222; background:rgba(255,255,255,0.85); border-radius:4px; padding:2px 6px; margin-top:0; text-align:center; line-height:1.1;">
                ${windSpeed !== undefined ? `<span style="white-space:nowrap;">${windSpeed}<span style="font-size:10px;"> km/h</span></span>` : ''}
                <br>
                ${temp !== undefined ? temp + '<span style="font-size:10px;">°C</span>' : ''}
                <br>
                ${humidity !== undefined ? humidity + '<span style="font-size:10px;">%</span>' : ''}
              </div>
            </div>
          `,
          iconSize: [38, 54],
          iconAnchor: [19, 32]
        });

        return L.marker(latlng, { icon: arrowIcon });
      }
    }).addTo(map);

    // Cities (off by default, names only, no marker icon)
    var nbCities = [
      { name: "Fredericton", lat: 45.9636, lng: -66.6431 },
      { name: "Saint John", lat: 45.2733, lng: -66.0633 },
      { name: "Moncton", lat: 46.0878, lng: -64.7782 },
      { name: "Bathurst", lat: 47.6186, lng: -65.6517 },
      { name: "Miramichi", lat: 47.0281, lng: -65.5019 },
      { name: "Edmundston", lat: 47.3730, lng: -68.3251 },
      { name: "Campbellton", lat: 48.0075, lng: -66.6731 },
      { name: "Dieppe", lat: 46.0842, lng: -64.6877 },
      { name: "Riverview", lat: 46.0617, lng: -64.8052 },
      { name: "Quispamsis", lat: 45.4319, lng: -65.9469 },
      { name: "Oromocto", lat: 45.8491, lng: -66.4828 },
      { name: "Woodstock", lat: 46.1527, lng: -67.6016 }
    ];

    var cityMarkers = L.layerGroup(
      nbCities.map(function(city) {
        var transparentIcon = L.divIcon({ html: '', iconSize: [0, 0] });
        return L.marker([city.lat, city.lng], {
          icon: transparentIcon,
          interactive: false,
          zIndexOffset: 1000
        }).bindTooltip(
          `<span class="city-label">${city.name}</span>`,
          { permanent: true, direction: 'top', offset: [0, 0], className: 'city-label-tooltip' }
        );
      })
    );

    // Layer controls
    var overlays = {
      "NB Active Wild Fires": nbActiveWildFires,
      "Weather Stations": weatherStations,
      "VIIRS Hotspots": viirsHotspots,
      "Major Cities & Towns": cityMarkers,
      "NB Crown Lands (zoom in to view)": nbCrownLands,
      "NB Burn Bans": nbBurnBans,
      "Sentinel-2C Imagery": sentinel2c
    };
    // cityMarkers.addTo(map); // Off by default

    var layersControl = L.control.layers(null, overlays, { collapsed: false }).addTo(map);
    map._layersControl = layersControl;

    // Custom Legend Control
    var legend = L.control({ position: 'bottomright' });

    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend');
      div.style.background = 'rgba(255,255,255,0.95)';
      div.style.padding = '10px 14px';
      div.style.borderRadius = '8px';
      div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
      div.innerHTML = `
        <b>Legend</b><br>
        <div style="margin-bottom:8px;">
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:red;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Out of Control Fire</span>
          <br>
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:orange;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Contained Fire</span>
          <br>
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:yellow;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Under Control Fire</span>
          <br>
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:green;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Being Patrolled Fire</span>
        </div>
        <div style="margin-bottom:8px;">
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,4 20,20 12,16 4,20" style="fill:#bbb;stroke:#111;stroke-width:2" />
          </svg>
          <a href="https://esricanada.maps.arcgis.com/home/item.html?id=38406bada3104e258fc8b42a2a96581a" target="_blank" style="margin-left:6px; color:#0074d9; text-decoration:underline; font-weight:bold;">
            Weather Station Wind Direction
          </a>
          <br>
          <span style="display:inline-block;width:24px;"></span>
          <span style="font-size:12px; font-weight:bold; white-space:nowrap;">
            12 <span style="font-size:10px;">km/h</span>, 20<span style="font-size:10px;">°C</span>, 60<span style="font-size:10px;">%</span>
          </span>
          <span style="margin-left:6px;">Wind Speed, Temp, Humidity</span>
        </div>
        <div>
          <svg width="18" height="18" style="vertical-align:middle;">
            <circle cx="9" cy="9" r="6" fill="#ffe066" stroke="#ffe066" stroke-width="2"/>
          </svg>
          <a href="https://www.arcgis.com/home/item.html?id=dece90af1a0242dcbf0ca36d30276aa3" target="_blank" style="margin-left:6px; color:#0074d9; text-decoration:underline; font-weight:bold;">
            VIIRS Hotspot
          </a>
        </div>
        <div>
          <a href="https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer" target="_blank" style="margin-left:6px; color:#0074d9; text-decoration:underline; font-weight:bold;">
            Sentinel-2C Imagery
          </a>
        </div>
        <div style="margin-top:12px; font-size:12px;">
          Fires and Crown Land info are from 
          <a href="https://www.snb.ca/geonb1/e/dc/catalogue-E.asp" target="_blank" style="color:#0074d9; text-decoration:underline; font-weight:bold;">
            GeoNB
          </a>
        </div>
      `;
      return div;
    };

    legend.addTo(map);

    // Toggle button for legend and layers control
    function isMobile() {
      return window.innerWidth < 768;
    }

    function setMapUIHidden(hidden) {
      var mapDiv = document.getElementById('map');
      if (hidden) {
        mapDiv.classList.add('map-ui-hidden');
        document.getElementById('mapToggleBtn').innerText = 'Show Legend & Layers';
      } else {
        mapDiv.classList.remove('map-ui-hidden');
        document.getElementById('mapToggleBtn').innerText = 'Hide Legend & Layers';
      }
    }

    // Initial state: hidden on mobile, shown on desktop
    setMapUIHidden(isMobile());

    document.getElementById('mapToggleBtn').addEventListener('click', function() {
      var mapDiv = document.getElementById('map');
      setMapUIHidden(!mapDiv.classList.contains('map-ui-hidden'));
    });

    // Reset map view button logic
    document.getElementById('resetViewBtn').onclick = function() {
      map.setView(initialView.center, initialView.zoom);
      localStorage.removeItem('nbMapView');
    };

    // Create the custom pane BEFORE adding any boundary layers
    map.createPane('nbBoundaryPane');
    map.getPane('nbBoundaryPane').style.zIndex = 405;

    // Add thick black NB boundary from NRCan service, no fill, only for New Brunswick
    L.esri.featureLayer({
      url: 'https://maps-cartes.services.geo.ca/server2_serveur2/rest/services/BaseMaps/Provinces/MapServer/0',
      where: "POLITICALDIV = 4",
      pane: 'nbBoundaryPane',
      style: function() {
        return {
          color: 'black',
          weight: 5,
          fill: false
        };
      },
      interactive: false
    }).addTo(map);

  </script>
  <div style="position:fixed;bottom:10px;left:0;width:100%;text-align:center;z-index:2000;">
    <a href="https://www.gnb.ca/en/topic/laws-safety/emergency-preparedness-alerts/fire-watch.html"
       target="_blank"
       style="background:#fff;border-radius:6px;padding:8px 18px;box-shadow:0 1px 4px rgba(0,0,0,0.13);color:#0074d9;font-weight:bold;text-decoration:underline;font-family:'Segoe UI',Arial,sans-serif;">
      NB Fire Watch &amp; Burn Restrictions
    </a>
  </div>
</body>
</html>

