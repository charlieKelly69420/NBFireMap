<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>New Brunswick Wildfire Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light" />

    <!-- Fonts / Leaflet / Plugins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <style>
      :root {
        color-scheme: light;
        --bg: #f7f8fc;
        --text: #0f172a;
        --muted: #5b6474;
        --panel: rgba(255, 255, 255, 0.85);
        --panel-strong: #fff;
        --border: #e6eaf1;
        --radius: 14px;
        --radius-sm: 10px;
        --shadow: 0 10px 30px rgba(2, 8, 20, 0.08);
        --shadow-soft: 0 6px 16px rgba(2, 8, 20, 0.06);
        --btn-bg: #fff;
        --btn-border: #d9dee6;
        --btn-hover: #f2f4f7;
        --link: #2563eb;
        --focus: 0 0 0 3px rgba(37, 99, 235, 0.28);
        --oc: #ef4444;
        --cont: #fb923c;
        --uc: #facc15;
        --pat: #22c55e;
        --viirs: #ffd666;
        --perimeter: #ef4444;
        --boundary: #0b0f19;
        --fs-12: 12px;
        --fs-14: 14px;
        --fs-16: 16px;
        --fs-18: 18px;
      }

      html,
      body,
      #map {
        height: 100%;
        margin: 0;
      }

      body {
        background: var(--bg);
        color: var(--text);
        font: var(--fs-14) / 1.45 Inter, system-ui, Segoe UI, Roboto, Arial,
          sans-serif;
        letter-spacing: 0.1px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Leaflet controls */
      .leaflet-bar a,
      .leaflet-bar a:hover {
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--text);
        box-shadow: var(--shadow-soft);
      }

      .leaflet-bar a {
        width: 34px;
        height: 34px;
        line-height: 34px;
        font-size: 16px;
      }

      .leaflet-control-attribution {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-soft);
        padding: 4px 8px;
      }

      .leaflet-top.leaflet-left {
        top: 52px !important;
      }

      .leaflet-top.leaflet-right {
        top: 72px !important;
      }

      /* Layers/legend panel (single, de-duped block) */
      .leaflet-control-layers {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        font-size: var(--fs-14);
        padding: 8px 35px 8px 14px;
        backdrop-filter: blur(6px);
        min-width: fit-content;
        width: max-content;
        max-width: none;
        inline-size: max-content;
        overflow: visible;
        white-space: nowrap;
      }

      .leaflet-control-layers-expanded,
      .leaflet-control-layers-list {
        max-height: none !important;
        overflow: visible !important;
      }

      .leaflet-control-layers-overlays label {
        display: grid;
        grid-template-columns: 18px 26px 1fr;
        align-items: center;
        column-gap: 8px;
        min-width: max-content;
        line-height: 1.25;
      }

      .leaflet-control-layers-overlays input {
        margin: 0;
        width: max-content;
        height: 18px;
      }

      .leaflet-control-layers-overlays .text {
        min-width: max-content;
        white-space: nowrap;
        overflow: visible;
        text-overflow: clip;
      }

      @media (max-width: 640px) {
        .leaflet-control-layers {
          min-width: auto;
          max-width: calc(100vw - 24px);
          width: auto;
          white-space: normal;
        }
      }

      @media (max-width: 767.98px) {
        .leaflet-control-layers {
          font-size: var(--fs-12);
        }
      }

      /* Buttons */
      .map-btn {
        position: absolute;
        z-index: 1001;
        background: var(--btn-bg);
        border: 1px solid var(--btn-border);
        border-radius: 999px;
        padding: 10px 14px;
        font-size: var(--fs-14);
        font-weight: 700;
        color: var(--text);
        cursor: pointer;
        box-shadow: var(--shadow);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s, transform 0.06s, box-shadow 0.2s;
      }

      .map-btn:hover {
        background: var(--btn-hover);
        box-shadow: 0 8px 22px rgba(2, 8, 20, 0.08);
      }

      .map-btn:active {
        transform: translateY(1px);
      }

      .map-btn:focus-visible {
        outline: none;
        box-shadow: var(--focus);
      }

      .map-toggle-btn {
        top: 12px;
        right: 12px;
      }

      .reset-view-btn {
        top: 12px;
        left: 12px;
        z-index: 1002;
      }

      .map-btn .icon {
        width: 18px;
        height: 18px;
        display: inline-grid;
        place-items: center;
      }

      .map-ui-hidden .leaflet-control-layers {
        opacity: 0;
        pointer-events: none;
      }

      /* Tooltips/labels */
      .city-label-tooltip,
      .perimeter-label-tooltip {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        padding: 0 !important;
      }

      .city-label {
        font-size: 15px;
        font-weight: 800;
        color: #fff;
        text-shadow:
          0 0 2px rgba(0, 0, 0, 0.7),
          0 0 8px rgba(0, 0, 0, 0.6),
          1px 1px 0 rgba(0, 0, 0, 0.9);
      }

      .perimeter-label {
        font-size: 12px;
        font-weight: 800;
        pointer-events: none;
        padding: 2px 6px;
        border-radius: 6px;
        background: color-mix(
          in oklab,
          var(--perimeter) 12%,
          transparent
        );
        backdrop-filter: blur(2px);
      }

      /* Summary modal */
      .fire-summary-btn {
        position: fixed;
        left: 12px;
        bottom: 86px;
        z-index: 2001;
      }

      .fire-summary-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: start;
        justify-content: center;
        z-index: 3000;
        background: rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(2px);
      }

      .fire-summary {
        margin-top: 16px;
        background: var(--panel-strong);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        width: min(560px, calc(100% - 24px));
        color: var(--text);
      }

      .fire-summary header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px 8px;
      }

      .fire-summary h2 {
        font-size: var(--fs-18);
        font-weight: 800;
        margin: 0;
      }

      .fire-summary .body {
        padding: 0 16px 16px;
        line-height: 1.5;
      }

      .close-summary {
        background: var(--btn-bg);
        border: 1px solid var(--btn-border);
        color: var(--text);
        border-radius: var(--radius-sm);
        padding: 8px 12px;
        cursor: pointer;
        font-weight: 700;
        box-shadow: var(--shadow-soft);
      }

      .close-summary:hover {
        background: var(--btn-hover);
      }

      .close-summary:focus-visible {
        outline: none;
        box-shadow: var(--focus);
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 10px;
        margin: 0 8px 8px 0;
        font-weight: 700;
        box-shadow: var(--shadow-soft);
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        display: inline-block;
      }

      .summary-list {
        margin: 8px 0 0;
        padding-left: 12px;
        list-style: decimal;
        list-style-position: inside;
      }

      .summary-list a {
        color: var(--link);
        text-decoration: none;
        font-weight: 700;
      }

      .summary-list a:hover {
        text-decoration: underline;
      }

      .fs-scroll {
        max-height: 260px;
        overflow-y: auto;
        margin-top: 6px;
      }

      .fs-meta-row {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        margin-bottom: 6px;
        font-weight: 800;
      }

      /* Markers + legend bits */
      .marker-badge {
        width: 38px;
        height: 38px;
        border-radius: 999px;
        display: grid;
        place-items: center;
        background: var(--panel-strong);
        border: 2.5px solid var(--ring, #9aa0a6);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.18);
      }

      .marker-badge i {
        font-size: 18px;
        color: var(--ring, #9aa0a6);
      }

      .legend-icon {
        width: 18px;
        height: 18px;
        display: inline-grid;
        place-items: center;
      }

      .icons-pack {
        display: inline-flex;
        gap: 6px;
        vertical-align: middle;
        justify-content: center;
        width: 26px;
      }

      .legend-sub {
        margin: 6px 0 6px 52px;
        display: grid;
        row-gap: 6px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--muted);
      }

      .legend-line {
        width: 18px;
        height: 3px;
        border-radius: 2px;
        display: inline-block;
      }

      .legend-badge {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        display: grid;
        place-items: center;
        background: #fff;
        border: 2.5px solid var(--ring);
      }

      .legend-badge i {
        font-size: 11px;
        color: var(--ring);
      }

      .legend-viirs-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--viirs);
        display: inline-block;
        box-shadow: 0 0 0 1.5px #111827 inset;
      }

      /* Footer link */
      .nb-footer {
        position: fixed;
        bottom: 10px;
        left: 0;
        width: 100%;
        text-align: center;
        z-index: 2000;
      }

      .nb-footer a {
        background: var(--btn-bg);
        border: 1px solid var(--btn-border);
        border-radius: 12px;
        padding: 10px 18px;
        box-shadow: var(--shadow);
        color: var(--link);
        font-weight: 800;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }
    </style>
  </head>
  <body>
    <div id="map" aria-label="Interactive wildfire map"></div>

    <button
      id="mapToggleBtn"
      class="map-btn map-toggle-btn"
      type="button"
      aria-pressed="false"
      title="Show/Hide layers"
    >
      <span class="icon"><i class="fa-solid fa-layer-group"></i></span
      ><span>Show Layers</span>
    </button>

    <button
      id="resetViewBtn"
      class="map-btn reset-view-btn"
      type="button"
      title="Reset map view"
    >
      <span class="icon"><i class="fa-solid fa-compass"></i></span
      ><span>Reset Map View</span>
    </button>

    <button
      id="fireSummaryBtn"
      class="map-btn fire-summary-btn"
      type="button"
      title="Open summary"
    >
      <span class="icon"><i class="fa-solid fa-fire"></i></span
      ><span>Fire Summary</span>
    </button>

    <div
      id="fireSummaryOverlay"
      class="fire-summary-overlay"
      role="presentation"
      hidden
    >
      <div
        class="fire-summary"
        role="dialog"
        aria-modal="true"
        aria-labelledby="fs-title"
      >
        <header>
          <h2 id="fs-title">New Brunswick Fire Summary</h2>
          <button id="fs-close" class="close-summary" type="button">
            <span class="icon"><i class="fa-solid fa-xmark"></i></span> Close
          </button>
        </header>
        <div id="fs-body" class="body"></div>
      </div>
    </div>

    <div class="nb-footer">
      <a
        href="https://www.gnb.ca/en/topic/laws-safety/emergency-preparedness-alerts/fire-watch.html"
        target="_blank"
        rel="noopener"
      >
        <i class="fa-solid fa-up-right-from-square"></i> NB Fire Watch &amp;
        Burn Restrictions
      </a>
    </div>

    <!-- JS (deferred to paint first) -->
    <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script defer src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
    <script
      defer
      src="https://unpkg.com/esri-leaflet-image/dist/esri-leaflet-image.js"
    ></script>
    <script
      defer
      src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"
    ></script>
    <script defer src="callsigns.js"></script>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        'use strict';

        /* ---------- Shorthands & config ---------- */
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

        const LS_KEY = 'nbMapView';
        const NB_BOUNDS = [
          [44.0, -69.5],
          [48.5, -62.0]
        ];
        const INITIAL_VIEW = {
          center: [46.7, -66.2],
          zoom: innerWidth < 768 ? 7 : 8
        };
        const isMobile = () => innerWidth < 768;
        const ATLANTIC_TZ = 'America/Moncton';

        /* ---------- Utilities (condensed) ---------- */
        const getSavedView = () => {
          try {
            return JSON.parse(localStorage.getItem(LS_KEY) || 'null');
          } catch {
            return null;
          }
        };

        const saveView = (map) => {
          const c = map.getCenter();
          localStorage.setItem(
            LS_KEY,
            JSON.stringify({ center: [c.lat, c.lng], zoom: map.getZoom() })
          );
        };

        const norm = (s) => (s || '').toString().trim().toLowerCase();
        const cssVal = (n) =>
          getComputedStyle(document.documentElement)
            .getPropertyValue(n)
            .trim();

        const fireStatusColor = (s) =>
          (
            {
              'out of control': cssVal('--oc'),
              contained: cssVal('--cont'),
              'under control': cssVal('--uc'),
              'being patrolled': cssVal('--pat')
            }[norm(s)] || '#9aa0a6'
          );

        const fmtDT = (v) =>
          v == null
            ? '—'
            : new Date(+v).toLocaleString(undefined, {
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
              });

        const fmtDate = (v) =>
          v == null
            ? '—'
            : new Date(+v).toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                timeZone: ATLANTIC_TZ
              });

        const num = (n, d = 1) =>
          n == null || isNaN(n)
            ? '—'
            : Number(n).toLocaleString(undefined, {
                maximumFractionDigits: d
              });

        const ymdInTz = (ms, tz = ATLANTIC_TZ) => {
          const fmt = new Intl.DateTimeFormat('en-CA', {
            timeZone: tz,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
          const parts = fmt.formatToParts(new Date(ms));
          const g = (k) => +parts.find((p) => p.type === k)?.value;
          return { y: g('year'), m: g('month'), d: g('day') };
        };

        const sameYMD = (a, b, tz) => {
          if (a == null || b == null) return false;
          const A = ymdInTz(a, tz);
          const B = ymdInTz(b, tz);
          return A.y === B.y && A.m === B.m && A.d === B.d;
        };

        const yesterdayUTCms = (tz = ATLANTIC_TZ) => {
          const t = ymdInTz(Date.now(), tz);
          return Date.UTC(t.y, t.m - 1, t.d) - 86400000;
        };

        const isToday = (ms) => sameYMD(ms, Date.now(), ATLANTIC_TZ);
        const isYesterday = (ms) =>
          sameYMD(ms, yesterdayUTCms(ATLANTIC_TZ), ATLANTIC_TZ);

        const aqhiCategory = (n) => {
          const v = Number(n);
          if (!isFinite(v)) return { label: '—', color: '#6b7280' };
          if (v >= 10) return { label: 'Very High', color: '#8b5cf6' };
          if (v >= 7) return { label: 'High', color: '#ef4444' };
          if (v >= 4) return { label: 'Moderate', color: '#eab308' };
          return { label: 'Low', color: '#22c55e' };
        };

        /* ---------- Map init ---------- */
        const restored = getSavedView();
        const map = L.map('map', {
          center: restored?.center || INITIAL_VIEW.center,
          zoom: restored?.zoom || INITIAL_VIEW.zoom,
          minZoom: 7,
          maxBounds: NB_BOUNDS,
          maxBoundsViscosity: 0.5
        });

        map.on('moveend', () => saveView(map));

        // Panes (looped)
        [
          ['alwaysOnTopPopup', 9999],
          ['sentinelPane', 400],
          ['nbBoundaryPane', 405],
          ['perimetersPane', 412],
          ['radarPane', 413], 
          ['viirsPane', 414],
          ['weatherPane', 415],
          ['aqiPane', 416],
          ['firesPane', 420],
          ['planesPane', 1000, true]
        ].forEach(([name, z, pe]) => {
          const p = map.createPane(name);
          p.style.zIndex = z;
          if (pe) p.style.pointerEvents = 'auto';
        });

        // Basemap
        L.esri.basemapLayer('Imagery').addTo(map);

        const sentinel2c = L.esri.imageMapLayer({
          url: 'https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer',
          opacity: 0.7,
          pane: 'sentinelPane'
        });

        if (isMobile()) {
          L.control
            .locate({
              position: 'topleft',
              flyTo: true,
              showPopup: false,
              keepCurrentZoomLevel: true,
              icon: 'fa fa-location-crosshairs',
              strings: { title: 'Show me where I am' }
            })
            .addTo(map);
          map.fitBounds(NB_BOUNDS, { padding: [30, 30] });
        }

        /* ---------- Fire layer + store ---------- */
        const fireStore = new Map();

        const nbActiveWildFires = L.esri
          .featureLayer({
            url: 'https://gis-erd-der.gnb.ca/arcgis/rest/services/Fire_Dashboards/Public_Fires/MapServer/0',
            pane: 'firesPane',
            pointToLayer: (f, latlng) => {
              const ring = fireStatusColor(f.properties.FIRE_STAT_DESC_E);
              const icon = L.divIcon({
                className: 'fire-badge-icon',
                html: `
                  <div class="marker-badge" style="--ring:${ring}">
                    <i class="fa-solid fa-fire" aria-hidden="true"></i>
                  </div>`,
                iconSize: [38, 38],
                iconAnchor: [19, 26],
                popupAnchor: [0, -22]
              });
              return L.marker(latlng, { icon });
            },
            onEachFeature: (feature, layer) => {
              const p = feature.properties || {};
              const html = `
                <div style="font:${'14px/1.45'} Inter,system-ui,Segoe UI,Arial;min-width:240px;color:var(--text)">
                  <div style="font-weight:800;font-size:16px;margin-bottom:6px;letter-spacing:.2px">
                    ${p.FIRE_NAME || 'Unnamed Fire'}
                  </div>
                  <div style="margin:6px 0 10px">
                    <span style="display:inline-flex;align-items:center;gap:8px;padding:5px 10px;border-radius:999px;background:var(--panel);border:1px solid var(--border);font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,.12)">
                      <span class="dot" style="background:${fireStatusColor(
                        p.FIRE_STAT_DESC_E
                      )}"></span>${p.FIRE_STAT_DESC_E || '—'}
                    </span>
                  </div>
                  <div><b>Area:</b> ${num(p.FIRE_SIZE, 1)} ha</div>
                  <div><b>Detected:</b> ${fmtDT(p.TIME_DETECTED)}</div>
                  <div><b>Status updated:</b> ${fmtDT(p.FIRE_STAT_DATE)}</div>
                </div>`;

              layer.bindPopup(html, {
                maxWidth: 340,
                pane: 'alwaysOnTopPopup'
              });

              const rawId =
                feature.id ??
                p.OBJECTID ??
                p.GlobalID ??
                p.FIRE_ID ??
                Math.random();
              const id = String(rawId);

              fireStore.set(id, {
                id,
                props: p,
                latlng: layer.getLatLng(),
                layer
              });

              // lightweight hover logic
              let clicked = false;
              let openT = null;
              let closeT = null;
              const OPEN = 150;
              const CLOSE = 60;

              const clear = () => {
                if (openT) {
                  clearTimeout(openT);
                  openT = null;
                }
                if (closeT) {
                  clearTimeout(closeT);
                  closeT = null;
                }
              };

              layer.on('mouseover', function () {
                if (clicked) return;
                clearTimeout(closeT);
                if (!openT)
                  openT = setTimeout(() => {
                    openT = null;
                    this.openPopup();
                  }, OPEN);
              });

              layer.on('mouseout', function () {
                if (clicked) return;
                clearTimeout(openT);
                if (!closeT)
                  closeT = setTimeout(() => {
                    closeT = null;
                    this.closePopup();
                  }, CLOSE);
              });

              layer.on('click', function () {
                clicked = !clicked;
                clear();
                clicked ? this.openPopup() : this.closePopup();
              });

              layer.on('remove', clear);
            }
          })
          .addTo(map);

        nbActiveWildFires.on('removefeature', (e) => {
          const p = (e.feature && e.feature.properties) || {};
          const id = String(
            e.feature && (e.feature.id ?? p.OBJECTID ?? p.GlobalID ?? p.FIRE_ID)
          );
          fireStore.delete(id);
        });

        /* ---------- Other operational layers (lazy-ish) ---------- */
        const PERIMETER_COLOR = cssVal('--perimeter');

        const viirsHotspots = L.esri
          .featureLayer({
            url: 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/ArcGIS/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0',
            pane: 'viirsPane',
            pointToLayer: (_f, latlng) =>
              L.circleMarker(latlng, {
                radius: 5,
                color: 'var(--viirs)',
                fillColor: 'var(--viirs)',
                fillOpacity: 0.8
              })
          })
          .addTo(map);

        const perimeterLabelLayers = new Set();

        const noaaRadar = L.esri.imageMapLayer({
          url: 'https://mapservices.weather.noaa.gov/eventdriven/rest/services/radar/radar_base_reflectivity_time/ImageServer',
          opacity: 0.7,
          pane: 'radarPane'
          });


        const activefires = L.esri
          .featureLayer({
            url: 'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Active_Wildfire_Perimeters_in_Canada_View/FeatureServer/0',
            pane: 'perimetersPane',
            style: () => ({ color: PERIMETER_COLOR, weight: 1.2, fillOpacity: 0.18 }),
            onEachFeature: (feature, layer) => {
              const ha = feature?.properties?.AREA;
              layer.bindTooltip(
                `<span class="perimeter-label" style="color:${PERIMETER_COLOR}">${num(
                  ha,
                  1
                )} ha</span>`,
                {
                  permanent: true,
                  className: 'perimeter-label-tooltip',
                  direction: 'center',
                  opacity: 0
                }
              );
              perimeterLabelLayers.add(layer);
            }
          })
          .addTo(map);

        const setPerimeterLabels = () => {
          const show = map.getZoom() >= 11;
          perimeterLabelLayers.forEach((l) =>
            l.getTooltip()?.setOpacity(show ? 1 : 0)
          );
        };

        activefires.on('load', setPerimeterLabels);
        map.on('zoomend', setPerimeterLabels);

        const nbCrownLands = L.esri.featureLayer({
          url: 'https://gis-erd-der.gnb.ca/server/rest/services/OpenData/Crown_Lands/FeatureServer/0',
          pane: 'perimetersPane',
          style: () => ({ color: '#a855f7', weight: 1, fillOpacity: 0.18 })
        });

        map.on('zoomend', () => {
          if (map.getZoom() < 10 && map.hasLayer(nbCrownLands)) {
            map.removeLayer(nbCrownLands);
          }
        });

        const nbBurnBans = L.esri.dynamicMapLayer({
          url: 'https://gis-erd-der.gnb.ca/gisserver/rest/services/FireWeather/BurnCategories/MapServer',
          opacity: 0.7,
          pane: 'perimetersPane'
        });

        const weatherStations = L.esri
          .featureLayer({
            url: 'https://services.arcgis.com/zmLUiqh7X11gGV2d/ArcGIS/rest/services/EnvironmentCanada/FeatureServer/0',
            pane: 'weatherPane',
            pointToLayer: (feature, latlng) => {
              const p = feature.properties || {};
              const windDir = p.WindDirection || 0;
              const windSpeed = p.WindSpeed_kmh;
              const temp = p.Temperature_C;
              const humidity = p.Humidity_Percent;

              const icon = L.divIcon({
                className: 'weather-arrow-icon',
                html: `
                  <div style="display:flex;flex-direction:column;align-items:center;">
                    <svg
                      width="38"
                      height="38"
                      style="transform:rotate(${windDir}deg);display:block;filter:drop-shadow(0 2px 2px rgba(0,0,0,.25));"
                    >
                      <polygon
                        points="19,4 30,30 19,24 8,30"
                        style="fill:#cbd5e1;stroke:#111827;stroke-width:2"
                      />
                    </svg>
                    <div
                      style="font-size:12px;font-weight:800;color:var(--text);background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:4px 8px;line-height:1.15;text-align:center;box-shadow:var(--shadow-soft)"
                    >
                      ${
                        windSpeed != null
                          ? `${windSpeed}<span style="font-size:10px;"> km/h</span>`
                          : ''
                      }<br />
                      ${
                        temp != null
                          ? `${temp}<span style="font-size:10px;">°C</span>`
                          : ''
                      }<br />
                      ${
                        humidity != null
                          ? `${humidity}<span style="font-size:10px;">%</span>`
                          : ''
                      }
                    </div>
                  </div>`,
                iconSize: [38, 58],
                iconAnchor: [19, 34]
              });

              return L.marker(latlng, { icon });
            }
          })
          .addTo(map);

        // Cities (labels only)
        const cityMarkers = L.layerGroup(
          [
            ['Fredericton', 45.9636, -66.6431],
            ['Saint John', 45.2733, -66.0633],
            ['Moncton', 46.0878, -64.7782],
            ['Bathurst', 47.6186, -65.6517],
            ['Miramichi', 47.0281, -65.5019],
            ['Edmundston', 47.373, -68.3251],
            ['Campbellton', 48.0075, -66.6731],
            ['Dieppe', 46.0842, -64.6877],
            ['Riverview', 46.0617, -64.8052],
            ['Quispamsis', 45.4319, -65.9469],
            ['Oromocto', 45.8491, -66.4828],
            ['Woodstock', 46.1527, -67.6016]
          ].map(([name, lat, lng]) =>
            L.marker([lat, lng], {
              icon: L.divIcon({ html: '', iconSize: [0, 0] }),
              interactive: false,
              zIndexOffset: 1000
            }).bindTooltip(
              `<span class="city-label">${name}</span>`,
              {
                permanent: true,
                direction: 'top',
                className: 'city-label-tooltip'
              }
            )
          )
        );

        // NB boundary
        L.esri
          .featureLayer({
            url: 'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/Provinces_and_Territories_of_Canada/FeatureServer/0',
            where: "Name_EN = 'New Brunswick'",
            pane: 'nbBoundaryPane',
            style: () => ({ color: cssVal('--boundary'), weight: 5, fill: false }),
            interactive: false
          })
          .addTo(map);

        /* ---------- Planes (fetch only when visible) ---------- */
        const OPEN_SKY_URL = 'https://opensky-network.org/api/states/all';
        const WHITELIST_CALLSIGNS = window.WHITELIST_CALLSIGNS || new Set();

        const planesLayer = L.layerGroup();
        const planeMarkers = new Map();

        const makePlaneIcon = (heading, callsign) => {
          const ICON_OFFSET = -45;
          const wl = (window.WHITELIST_CALLSIGNS || new Set()).has(callsign);

          // build a single filter chain so it doesn't get overwritten
          const baseShadow = 'drop-shadow(0 2px 2px rgba(0,0,0,.25))';
          const filterChain = wl
            ? `hue-rotate(-90deg) saturate(5) ${baseShadow}`
            : baseShadow;

          const rotate = Number.isFinite(heading) ? heading : 0;

          return L.divIcon({
            className: 'plane-div-icon',
            html: `
              <div style="transform:rotate(${ICON_OFFSET}deg);transform-origin:center;display:inline-block;">
                <div style="transform:rotate(${rotate}deg);font-size:26px;filter:${filterChain}">
                  ✈️
                </div>
              </div>`,
            iconSize: [30, 46],
            iconAnchor: [15, 23]
          });
        };

        const upsertPlane = (id, lat, lon, hdg, callsign, vel) => {
          let m = planeMarkers.get(id);
          const html = `<b>${callsign || 'Unknown'}</b><br>Heading: ${
            Number.isFinite(hdg) ? Math.round(hdg) : '—'
          }°<br>Speed: ${vel != null ? Math.round(vel * 1.94384) : '—'} kt`;

          if (!m) {
            m = L.marker([lat, lon], {
              icon: makePlaneIcon(hdg, callsign),
              pane: 'planesPane',
              keyboard: false,
              zIndexOffset: 10000
            }).bindPopup(html, { pane: 'alwaysOnTopPopup' });

            let clicked = false;

            m.on('mouseover', function () {
              if (!clicked) this.openPopup();
            });

            m.on('mouseout', function () {
              if (!clicked) this.closePopup();
            });

            m.on('click', function () {
              clicked = !clicked;
              clicked ? this.openPopup() : this.closePopup();
            });

            m.addTo(planesLayer);
            planeMarkers.set(id, m);
          } else {
            m.setLatLng([lat, lon]);
            m.setIcon(makePlaneIcon(hdg, callsign));
            m.setPopupContent(html);
          }
        };

        const pruneMissing = (seen) => {
          for (const [k, m] of planeMarkers.entries()) {
            if (!seen.has(k)) {
              planesLayer.removeLayer(m);
              planeMarkers.delete(k);
            }
          }
        };

        async function fetchOpenSky() {
          try {
            const [lamin, lomin] = NB_BOUNDS[0];
            const [lamax, lomax] = NB_BOUNDS[1];

            const r = await fetch(
              `${OPEN_SKY_URL}?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`
            );
            if (!r.ok) throw new Error(r.statusText);

            const data = await r.json();
            const states = Array.isArray(data.states) ? data.states : [];

            const seen = new Set();

            for (const s of states) {
              const icao24 = s[0];
              const callsign = (s[1] || '').trim().toUpperCase();
              const lon = s[5];
              const lat = s[6];
              const vel = s[9];
              const hdg = s[10];

              if (!icao24 || lat == null || lon == null) continue;

              seen.add(icao24);
              upsertPlane(icao24, lat, lon, hdg, callsign, vel);
            }

            pruneMissing(seen);
          } catch (e) {
            console.warn('OpenSky fetch failed:', e);
          }
        }

        const OPEN_SKY_INTERVAL_MS = 250000;
        let planesTimer = null;

        planesLayer.on('add', () => {
          fetchOpenSky();
          if (!planesTimer)
            planesTimer = setInterval(fetchOpenSky, OPEN_SKY_INTERVAL_MS);
        });

        planesLayer.on('remove', () => {
          if (planesTimer) {
            clearInterval(planesTimer);
            planesTimer = null;
          }
        });

        /* ---------- WMS + Smoke + AQHI ---------- */
        const fireRiskGroup = L.layerGroup().addLayer(
          L.tileLayer.wms(
            'https://cwfis.cfs.nrcan.gc.ca/geoserver/public/wms',
            {
              layers: 'public:fdr_current',
              format: 'image/png',
              transparent: true,
              version: '1.1.1',
              opacity: 0.4,
              pane: 'perimetersPane',
              attribution: 'CWFIS © Natural Resources Canada'
            }
          )
        );

        const smokeLayer = L.esri.imageMapLayer({
          url: 'https://enterpriseim.esriservices.ca/server/rest/services/Hosted/Aug12/ImageServer',
          opacity: 0.5,
          pane: 'sentinelPane'
        });

        const aqiLayer = L.esri.featureLayer({
          url: 'https://services.arcgis.com/wjcPoefzjpzCgffS/ArcGIS/rest/services/aqhi_stations_observations_realtime/FeatureServer/1',
          pane: 'aqiPane',
          refreshInterval: 2, // minutes
          pointToLayer: (feature, latlng) => {
            const p = feature.properties || {};
            const raw = p.aqhi ?? p.aqhi_round;
            const val =
              raw == null || Number.isNaN(Number(raw)) ? null : Number(raw);
            const { label, color } = aqhiCategory(val);

            const icon = L.divIcon({
              className: 'aqi-badge-icon',
              html: `
                <div style="display:flex;flex-direction:column;align-items:center;">
                  <svg width="26" height="26" viewBox="0 0 26 26" style="filter:drop-shadow(0 2px 2px rgba(0,0,0,.25));">
                    <circle cx="13" cy="13" r="11" stroke="#111827" stroke-width="2" fill="${color}" />
                  </svg>
                  <div style="margin-top:2px;font-size:12px;font-weight:800;color:var(--text);background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:4px 8px;line-height:1.15;text-align:center;box-shadow:var(--shadow-soft)">
                    AQHI ${val ?? '—'} <span style="opacity:.8">${label}</span>
                  </div>
                </div>`,
              iconSize: [28, 48],
              iconAnchor: [14, 24],
              popupAnchor: [0, -22]
            });

            const m = L.marker(latlng, { icon });
            const loc = p.location_name_en || '';
            const when = p.observation_datetime_text_en || '';

            m.bindTooltip(
              `${loc ? loc + ' — ' : ''}AQHI ${val ?? '—'} • ${label}${
                when ? ' • ' + when : ''
              }`,
              { direction: 'top', offset: [0, -20], opacity: 0 }
            );

            return m;
          }
        });

        /* ---------- Overlays + control ---------- */
        const overlays = {
          'NB Active Wild Fires': nbActiveWildFires,
          'Weather Stations': weatherStations,
          'VIIRS Hotspots': viirsHotspots,
          'Fire Perimeters': activefires,
          Aircraft: planesLayer,
          'Major Cities & Towns': cityMarkers,
          'NB Crown Lands': nbCrownLands,
          'NB Burn Bans': nbBurnBans,
          'AQHI Risk': aqiLayer,
          'Weather Radar': noaaRadar,
          Smoke: smokeLayer,
          'Fire Risk': fireRiskGroup,
          'Sentinel-2C Imagery': sentinel2c
        };

        const layersControl = L.control
          .layers(null, overlays, { collapsed: false })
          .addTo(map);

        /* ---------- Legend makeover (idempotent) ---------- */
        function decorateLayersControl() {
          const list = $('.leaflet-control-layers-overlays');
          if (!list) return;

          // cleanup previous
          $$('.icons-pack,.legend-sub', list).forEach((el) => el.remove());

          const packs = {
            'NB Active Wild Fires':
              '<span class="icons-pack"><i class="fa-solid fa-fire legend-icon"></i></span>',
            'Weather Stations':
              '<span class="icons-pack"><i class="fa-solid fa-location-arrow legend-icon" style="transform:rotate(45deg)"></i></span>',
            'VIIRS Hotspots':
              '<span class="icons-pack"><span class="legend-viirs-dot"></span></span>',
            'Fire Perimeters':
              '<span class="icons-pack"><i class="fa-regular fa-square legend-icon"></i></span>',
            Aircraft:
              '<span class="icons-pack"><span style="font-size:14px;display:inline-block;transform:rotate(-45deg)">✈️</span></span>',
            'Major Cities & Towns':
              '<span class="icons-pack"><i class="fa-solid fa-city legend-icon"></i></span>',
            'NB Crown Lands':
              '<span class="icons-pack"><i class="fa-solid fa-tree legend-icon"></i></span>',
            'NB Burn Bans':
              '<span class="icons-pack"><i class="fa-solid fa-ban legend-icon"></i></span>',
            'AQHI Risk':
              '<span class="icons-pack"><i class="fa-solid fa-wind legend-icon"></i></span>',
            'Weather Radar (NOAA)':
              '<span class="icons-pack"><i class="fa-solid fa-radar legend-icon"></i></span>',
            Smoke:
              '<span class="icons-pack"><i class="fa-solid fa-smog legend-icon"></i></span>',
            'Fire Risk':
              '<span class="icons-pack"><i class="fa-solid fa-fire-extinguisher legend-icon"></i></span>',
            'Sentinel-2C Imagery':
              '<span class="icons-pack"><i class="fa-regular fa-image legend-icon"></i></span>'
          };

          $$('label', list).forEach((label) => {
            const textSpan = Array.from(label.querySelectorAll('span')).find((s) =>
              s.textContent.trim()
            );
            if (!textSpan) return;

            const name = textSpan.textContent.trim();
            label.insertAdjacentHTML(
              'afterbegin',
              packs[name] ||
                `<span class="icons-pack"><i class="fa-solid fa-layer-group legend-icon"></i></span>`
            );
            textSpan.classList.add('text');

            const insertSub = (html) =>
              label.insertAdjacentHTML('afterend', `<div class="legend-sub">${html}</div>`);

            if (name === 'NB Active Wild Fires') {
              const rows = [
                ['Out of Control', '--oc'],
                ['Contained', '--cont'],
                ['Under Control', '--uc'],
                ['Being Patrolled', '--pat']
              ]
                .map(
                  ([t, varName]) => `
                    <div class="legend-item">
                      <span class="legend-badge" style="--ring:${cssVal(varName)}">
                        <i class="fa-solid fa-fire"></i>
                      </span>
                      <span>${t}</span>
                    </div>`
                )
                .join('');

              insertSub(rows);
            }
          });
        }

        decorateLayersControl();
        $('.leaflet-control-layers')?.addEventListener('click', () =>
          queueMicrotask(decorateLayersControl)
        );

        /* ---------- UI: hide/show panel + reset ---------- */
        const setMapUIHidden = (hidden) => {
          const mapDiv = $('#map');
          const btn = $('#mapToggleBtn');

          mapDiv.classList.toggle('map-ui-hidden', hidden);
          btn.querySelector('span:last-child').textContent = hidden
            ? 'Show Layers'
            : 'Hide Layers';
          btn.setAttribute('aria-pressed', String(!hidden));
        };

        setMapUIHidden(isMobile());

        $('#mapToggleBtn').addEventListener('click', () =>
          setMapUIHidden(!$('#map').classList.contains('map-ui-hidden'))
        );

        $('#resetViewBtn').addEventListener('click', () => {
          map.setView(INITIAL_VIEW.center, INITIAL_VIEW.zoom);
          localStorage.removeItem(LS_KEY);
        });

        /* ---------- Fire Summary ---------- */
        const overlay = $('#fireSummaryOverlay');
        const bodyEl = $('#fs-body');

        const chip = (label, n) =>
          `<span class="chip"><span class="dot" style="background:${fireStatusColor(
            label
          )}"></span>${label} <span style="font-weight:800;margin-left:6px">${n}</span></span>`;

        function buildSummaryHTML() {
          const items = [...fireStore.values()];

          let totalArea = 0;
          const counts = {
            'out of control': 0,
            contained: 0,
            'under control': 0,
            'being patrolled': 0,
            other: 0
          };

          let newToday = 0;
          let newYesterday = 0;

          for (const it of items) {
            const p = it.props || {};
            const sz = +p.FIRE_SIZE;
            if (isFinite(sz)) totalArea += sz;

            const key = norm(p.FIRE_STAT_DESC_E);
            counts.hasOwnProperty(key) ? counts[key]++ : counts.other++;

            const det = p.TIME_DETECTED != null ? +p.TIME_DETECTED : null;
            if (det != null) {
              if (isToday(det)) newToday++;
              else if (isYesterday(det)) newYesterday++;
            }
          }

          const chips = [
            ['Out of Control', counts['out of control']],
            ['Contained', counts['contained']],
            ['Under Control', counts['under control']],
            ['Being Patrolled', counts['being patrolled']]
          ]
            .map(([l, n]) => chip(l, n))
            .join('');

          const sorted = items
            .slice()
            .sort(
              (a, b) => (+b.props.FIRE_SIZE || 0) - (+a.props.FIRE_SIZE || 0)
            );

          const list =
            sorted
              .map((it) => {
                const p = it.props || {};
                return `
                  <li style="margin:4px 0;">
                    <a href="#" data-fireid="${it.id}">
                      <span style="font-weight:700">${p.FIRE_NAME || 'Unnamed Fire'}</span>
                      &nbsp;—&nbsp;${num(p.FIRE_SIZE, 0)} ha
                      <span style="opacity:.8">• ${p.FIRE_STAT_DESC_E || '—'}</span>
                      <span style="opacity:.8">• Detected: ${fmtDate(p.TIME_DETECTED)}</span>
                    </a>
                  </li>`;
              })
              .join('') || '<li>No active fires</li>';

          return `
            <div class="fs-meta-row">
              <div>New fires today: ${num(newToday, 0)}</div>
              <div>New fires yesterday: ${num(newYesterday, 0)}</div>
              <div>Total area burned: ${num(totalArea, 0)} ha</div>
            </div>
            <div style="margin:8px 0 6px"><b>Fires by status</b></div>
            <div>${chips}</div>
            <div style="margin-top:10px">
              <b>All active fires <span style="font-weight:600;color:var(--muted)">(largest → smallest)</span></b>
              <ol class="summary-list fs-scroll" id="fs-all">${list}</ol>
            </div>
            <div style="margin-top:10px;font-size:12px;color:var(--muted)">
              “Today / yesterday” uses Atlantic Time (TIME_DETECTED).
              Source: NB Active Fires (Public_Fires/MapServer/0).
            </div>`;
        }

        const openSummary = () => {
          bodyEl.innerHTML = buildSummaryHTML();
          overlay.hidden = false;
          overlay.style.display = 'flex';

          $('#fs-all')?.addEventListener(
            'click',
            (e) => {
              const a = e.target.closest('a[data-fireid]');
              if (!a) return;

              e.preventDefault();

              const rec = fireStore.get(a.getAttribute('data-fireid'));
              if (!rec) return;

              overlay.style.display = 'none';
              overlay.hidden = true;

              map.flyTo(rec.latlng, Math.max(map.getZoom(), 12), {
                duration: 0.6
              });

              map.once('moveend', () => rec.layer?.openPopup && rec.layer.openPopup());
            },
            { once: true }
          );
        };

        $('#fireSummaryBtn').addEventListener('click', openSummary);
        $('#fs-close').addEventListener('click', () => {
          overlay.style.display = 'none';
          overlay.hidden = true;
        });

        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.style.display = 'none';
            overlay.hidden = true;
          }
        });
      }); // here
    </script>
  </body>
</html>
