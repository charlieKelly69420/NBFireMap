name: Fetch NB Fire Feeds

on:
  schedule:
    - cron: "38 * * * *"
  workflow_dispatch:
permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Fetch and verify feeds (10-in-a-row, up to 5 passes, 2s per copy, 30s between passes)
        id: fetch
        env:
          BASE: https://gis-erd-der.gnb.ca/arcgis/rest/services/Fire_Dashboards/Public_Fires/MapServer
          QUERY: '?where=1%3D1&outFields=*&f=json'
          TABLE_NAME: SDEOWNER.V_FIRE_DASHBOARD_SUM
          COPIES: "10"
        run: |
          set -euo pipefail

          cleanup_prefix() {
            rm -f "${1}"[0-9][0-9].json || true
          }

          download_n() {
            local url="$1" prefix="$2" n="${3:-10}"
            cleanup_prefix "$prefix"
            for i in $(seq -w 01 "$n"); do
              tmpfile="$(mktemp)"
              if ! curl -sS --fail --retry 3 --retry-delay 2 --retry-connrefused --max-time 60 "$url" -o "$tmpfile"; then
                echo "Curl failed for ${url}"
                rm -f "$tmpfile"
                return 1
              fi
              if ! jq -e type "$tmpfile" >/dev/null 2>&1; then
                echo "Invalid JSON for ${url}"
                rm -f "$tmpfile"
                return 1
              fi
              mv "$tmpfile" "${prefix}${i}.json"
              sleep 2   # <-- 2 seconds between copies
            done
          }

          all_match() {
            local prefix="$1"
            ls ${prefix}[0-9][0-9].json >/dev/null 2>&1 || return 1
            local uniq_count
            uniq_count=$(sha256sum ${prefix}[0-9][0-9].json | awk '{print $1}' | sort | uniq | wc -l | tr -d ' ')
            test "$uniq_count" -eq 1
          }

          get_table_id() {
            local meta
            if ! meta="$(curl -sS --fail "$BASE?f=pjson")"; then
              echo "Failed to read service metadata"; return 1
            fi
            echo "$meta" | jq -e --arg NAME "$TABLE_NAME" '.tables[] | select(.name==$NAME) | .id' 2>/dev/null | tr -d '\r\n'
          }

          write_with_timestamp() {
            local src="$1" dest="$2"
            local ts
            ts="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            jq --arg ts "$ts" '
              if (.features | type) == "array" then
                .features |= map(
                  .attributes |= ((. // {}) + {"UPDATED_FROM_ERD": $ts})
                )
              else
                .
              end
            ' "$src" > "${dest}.tmp"
            mv "${dest}.tmp" "$dest"
          }

          ACTIVE_NEEDED=true
          OUT_NEEDED=true
          TABLE_NEEDED=true

          TID="$(get_table_id || true)"
          if [ -z "${TID:-}" ]; then
            echo "Could not find table id for $TABLE_NAME in service metadata."
            TABLE_NEEDED=false
          fi

          ANY_CHANGED=false

          for pass in 1 2 3 4 5; do
            echo "::group::Pass $pass"

            if [ "$ACTIVE_NEEDED" = true ]; then
              echo "Attempt: active fires (layer 0)"
              if download_n "$BASE/0/query$QUERY" "active_fires" "$COPIES"; then
                if all_match "active_fires"; then
                  write_with_timestamp active_fires01.json active_fires.json
                  echo "Active fires stabilized on pass $pass"
                  ACTIVE_NEEDED=false
                  ANY_CHANGED=true
                else
                  echo "Active fires NOT stable on pass $pass."
                fi
              else
                echo "Active fires download failed on pass $pass."
              fi
              cleanup_prefix "active_fires"
            fi

            if [ "$OUT_NEEDED" = true ]; then
              echo "Attempt: out fires (layer 1)"
              if download_n "$BASE/1/query$QUERY" "out_fires" "$COPIES"; then
                if all_match "out_fires"; then
                  write_with_timestamp out_fires01.json out_fires.json
                  echo "Out fires stabilized on pass $pass"
                  OUT_NEEDED=false
                  ANY_CHANGED=true
                else
                  echo "Out fires NOT stable on pass $pass."
                fi
              else
                echo "Out fires download failed on pass $pass."
              fi
              cleanup_prefix "out_fires"
            fi

            if [ "$TABLE_NEEDED" = true ]; then
              echo "Attempt: table $TABLE_NAME (id=${TID:-unknown})"
              if [ -n "${TID:-}" ]; then
                if download_n "$BASE/$TID/query$QUERY" "v_fire_dashboard_sum" "$COPIES"; then
                  if all_match "v_fire_dashboard_sum"; then
                    write_with_timestamp v_fire_dashboard_sum01.json v_fire_dashboard_sum.json
                    echo "Table $TABLE_NAME stabilized on pass $pass"
                    TABLE_NEEDED=false
                    ANY_CHANGED=true
                  else
                    echo "Table $TABLE_NAME NOT stable on pass $pass."
                  fi
                else
                  echo "Table $TABLE_NAME download failed on pass $pass."
                fi
                cleanup_prefix "v_fire_dashboard_sum"
              else
                echo "Skipping table; no table id."
              fi
            fi

            echo "::endgroup::"

            if [ "$ACTIVE_NEEDED" = false ] && [ "$OUT_NEEDED" = false ] && [ "$TABLE_NEEDED" = false ]; then
              break
            else
              echo "Some datasets still unstable; waiting 30s before next pass..."
              sleep 30
            fi
          done

          echo "any_changed=$ANY_CHANGED" >> "$GITHUB_OUTPUT"

      - name: Commit updated JSON (only what changed)
        if: steps.fetch.outputs.any_changed == 'true'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add active_fires.json out_fires.json v_fire_dashboard_sum.json || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            ts="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git commit -m "Update fire feeds (${ts})"
            git push
          fi
