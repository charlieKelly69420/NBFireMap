<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>New Brunswick Wildfire Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .leaflet-control-layers-expanded {
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet-image/dist/esri-leaflet-image.js"></script>
  <script>
    // Center and restrict map to a tighter view of New Brunswick
    var nbBounds = [
      [44.95, -68.5], // Southwest corner (lat, lng) - slightly tighter
      [48.05, -63.8]  // Northeast corner (lat, lng)
    ];

    var map = L.map('map', {
      center: [46.7, -66.2], // More centered on NB
      zoom: 8,
      minZoom: 7,
      maxBounds: nbBounds,
      maxBoundsViscosity: 1.0 // Prevents panning outside bounds
    });

    // Esri World Imagery as basemap
    var esriImagery = L.esri.basemapLayer('Imagery');

    // Sentinel-2C Imagery (on by default)
    var sentinel2c = L.esri.imageMapLayer({
      url: 'https://sentinel.arcgis.com/arcgis/rest/services/Sentinel2/ImageServer',
      opacity: 0.7
    });

    // Add only one basemap at a time
    esriImagery.addTo(map);
    sentinel2c.addTo(map);

    // NB Active Wild Fires (on by default, styled by label)
    var nbActiveWildFires = L.esri.featureLayer({
      url: 'https://gis-erd-der.gnb.ca/arcgis/rest/services/Fire_Dashboards/Public_Fires/MapServer/0',
      pointToLayer: function(feature, latlng) {
        var label = feature.properties.FIRE_STAT_DESC_E || '';
        var color = 'gray';
        if (label === 'Out of Control') color = 'red';
        else if (label === 'Contained') color = 'orange';
        else if (label === 'Under control') color = 'yellow';
        else if (label === 'Being patrolled') color = 'green';
        else if (label === 'Being Patrolled') color = 'green';

        // SVG triangle as a divIcon (screen-size, not map-size)
        var triangleIcon = L.divIcon({
          className: 'fire-triangle-icon',
          html: `
            <svg width="32" height="32" viewBox="0 0 32 32">
              <polygon points="16,4 28,28 4,28" style="fill:${color};stroke:#222;stroke-width:2" />
            </svg>
          `,
          iconSize: [32, 32],
          iconAnchor: [16, 28]
        });

        return L.marker(latlng, { icon: triangleIcon });
      }
    }).addTo(map);

    nbActiveWildFires.bindPopup(function (layer) {
      var props = layer.feature.properties;
      var popup = '<b>NB Active Wild Fire</b><br>';
      for (var key in props) {
        if (props.hasOwnProperty(key)) {
          popup += '<b>' + key + ':</b> ' + props[key] + '<br>';
        }
      }
      return popup;
    });

    // VIIRS Hotspots (on by default, light blue, draws under NB Active Wild Fires)
    map.createPane('viirsPane');
    map.getPane('viirsPane').style.zIndex = 410;

    var viirsHotspots = L.esri.featureLayer({
      url: 'https://services9.arcgis.com/RHVPKKiFTONKtxq3/ArcGIS/rest/services/Satellite_VIIRS_Thermal_Hotspots_and_Fire_Activity/FeatureServer/0',
      pane: 'viirsPane',
      pointToLayer: function(geojson, latlng) {
        return L.circleMarker(latlng, {
          radius: 5,
          color: '#00bfff',
          fillColor: '#00bfff',
          fillOpacity: 0.7
        });
      }
    }).addTo(map);

    // NB Crown Lands (off by default, styled client-side)
    var nbCrownLands = L.esri.featureLayer({
      url: 'https://gis-erd-der.gnb.ca/server/rest/services/OpenData/Crown_Lands/FeatureServer/0',
      style: function() {
        return { color: 'purple', weight: 1, fillOpacity: 0.2 };
      }
    });

    // Only show Crown Lands at zoom 10+
    map.on('zoomend', function() {
      if (map.hasLayer(nbCrownLands)) {
        if (map.getZoom() < 10) {
          map.removeLayer(nbCrownLands);
        }
      } else {
        if (map.getZoom() >= 10 && map._layersControl && map._layersControl._layers) {
          // Only add if toggled on in the control
          var overlays = map._layersControl._layers;
          for (var i in overlays) {
            if (overlays[i].name === "NB Crown Lands" && overlays[i].layer === nbCrownLands && overlays[i].overlay && overlays[i].active) {
              map.addLayer(nbCrownLands);
            }
          }
        }
      }
    });

    // NB Burn Bans (off by default, uses server symbology)
    var nbBurnBans = L.esri.dynamicMapLayer({
      url: 'https://gis-erd-der.gnb.ca/gisserver/rest/services/FireWeather/BurnCategories/MapServer',
      opacity: 0.7
    });

    // Weather Stations (on by default, arrow shows wind direction, label shows wind speed/temp/humidity)
    var weatherStations = L.esri.featureLayer({
      url: 'https://services.arcgis.com/zmLUiqh7X11gGV2d/ArcGIS/rest/services/EnvironmentCanada/FeatureServer/0',
      pointToLayer: function(feature, latlng) {
        var windDir = feature.properties.WindDirection || 0;
        var windSpeed = feature.properties.WindSpeed_kmh;
        var temp = feature.properties.Temperature_C;
        var humidity = feature.properties.Humidity_Percent;

        // Large, modern, bold arrow SVG
        var arrowIcon = L.divIcon({
          className: 'weather-arrow-icon',
          html: `
            <div style="display: flex; flex-direction: column; align-items: center;">
              <svg width="38" height="38" style="transform: rotate(${windDir}deg); display: block;">
                <polygon points="19,4 30,30 19,24 8,30" style="fill:#bbb;stroke:#111;stroke-width:2" />
              </svg>
              <div style="font-size:13px; font-weight:bold; color:#222; background:rgba(255,255,255,0.85); border-radius:4px; padding:2px 6px; margin-top:0; text-align:center; line-height:1.1;">
                ${windSpeed !== undefined ? `<span style="white-space:nowrap;">${windSpeed}<span style="font-size:10px;"> km/h</span></span>` : ''}
                <br>
                ${temp !== undefined ? temp + '<span style="font-size:10px;">°C</span>' : ''}
                <br>
                ${humidity !== undefined ? humidity + '<span style="font-size:10px;">%</span>' : ''}
              </div>
            </div>
          `,
          iconSize: [38, 54],
          iconAnchor: [19, 32]
        });

        return L.marker(latlng, { icon: arrowIcon });
      }
    }).addTo(map);

    // Custom Legend Control
    var legend = L.control({ position: 'bottomright' });

    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend');
      div.style.background = 'rgba(255,255,255,0.95)';
      div.style.padding = '10px 14px';
      div.style.borderRadius = '8px';
      div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
      div.innerHTML = `
        <b>Legend</b><br>
        <div style="margin-bottom:8px;">
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:red;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Out of Control Fire</span>
          <br>
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:orange;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Contained Fire</span>
          <br>
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:yellow;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Under Control Fire</span>
          <br>
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:green;stroke:#222;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Being Patrolled Fire</span>
        </div>
        <div style="margin-bottom:8px;">
          <svg width="24" height="24" style="vertical-align:middle;">
            <polygon points="12,3 22,21 2,21" style="fill:#bbb;stroke:#111;stroke-width:2" />
          </svg>
          <span style="margin-left:6px;">Weather Station Wind Direction</span>
          <br>
          <span style="display:inline-block;width:24px;"></span>
          <span style="font-size:12px; font-weight:bold;">12 <span style="font-size:10px;">km/h</span>, 20<span style="font-size:10px;">°C</span>, 60<span style="font-size:10px;">%</span></span>
          <span style="margin-left:6px;">Wind Speed, Temp, Humidity</span>
        </div>
        <div>
          <svg width="18" height="18" style="vertical-align:middle;">
            <circle cx="9" cy="9" r="6" fill="#00bfff" stroke="#00bfff" stroke-width="2"/>
          </svg>
          <span style="margin-left:6px;">VIIRS Hotspot</span>
        </div>
      `;
      return div;
    };

    legend.addTo(map);

    // Layer controls
    // Add to overlays (default off)
    var overlays = {
      "NB Active Wild Fires": nbActiveWildFires,
      "Weather Stations": weatherStations,
      "VIIRS Hotspots": viirsHotspots,
      "NB Crown Lands (zoom in to view)": nbCrownLands,
      "NB Burn Bans": nbBurnBans,
      "Sentinel-2C Imagery": sentinel2c
    };

    var layersControl = L.control.layers(null, overlays, { collapsed: false }).addTo(map);
    map._layersControl = layersControl; // Store for later reference
  </script>
</body>
</html>